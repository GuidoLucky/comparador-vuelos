<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lucky Tour ‚Äî Comparador de Vuelos</title>
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{--gold:#C9A84C;--gold-light:#E8CC7A;--dark:#0D1117;--dark2:#161B22;--dark3:#21262D;--border:#30363D;--text:#E6EDF3;--muted:#8B949E;--green:#3FB950;--blue:#58A6FF;--red:#F85149;--orange:#F0883E;}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Sora',sans-serif;background:var(--dark);color:var(--text);min-height:100vh;}
header{background:var(--dark2);border-bottom:1px solid var(--border);padding:14px 28px;display:flex;align-items:center;gap:12px;}
.logo-icon{width:36px;height:36px;background:var(--gold);border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:18px;}
.logo-text{font-size:17px;font-weight:700;}.logo-text span{color:var(--gold);}
.logo-sub{font-size:10px;color:var(--muted);letter-spacing:2px;text-transform:uppercase;}
.container{max-width:1200px;margin:0 auto;padding:24px 20px;}
.search-card{background:var(--dark2);border:1px solid var(--border);border-radius:14px;padding:22px 24px;margin-bottom:24px;}
.tipo-tabs{display:flex;gap:6px;margin-bottom:20px;}
.tipo-tab{background:var(--dark3);border:1px solid var(--border);border-radius:8px;color:var(--muted);font-family:'Sora',sans-serif;font-size:12px;font-weight:600;padding:7px 16px;cursor:pointer;transition:all 0.15s;}
.tipo-tab:hover{border-color:var(--gold);color:var(--text);}
.tipo-tab.active{background:rgba(201,168,76,0.12);border-color:var(--gold);color:var(--gold);}
.search-row{display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap;}
.field{display:flex;flex-direction:column;gap:5px;}
.field label{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;font-weight:600;}
.field input,.field select{background:var(--dark3);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:'Sora',sans-serif;font-size:14px;padding:9px 11px;outline:none;transition:border-color 0.2s;}
.field input:focus,.field select:focus{border-color:var(--gold);}
.field select option{background:var(--dark3);}
.f-sm{width:90px;}.f-md{width:145px;}.f-xs{width:72px;}.f-lg{width:140px;}
.tramo-row-multi{display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap;padding:12px;background:var(--dark3);border-radius:10px;margin-bottom:8px;position:relative;}
.tramo-num{font-size:10px;font-weight:700;color:var(--gold);text-transform:uppercase;letter-spacing:1px;align-self:center;min-width:60px;}
.btn-rm-tramo{position:absolute;top:8px;right:8px;background:none;border:none;color:var(--muted);cursor:pointer;font-size:16px;padding:2px 6px;border-radius:4px;}
.btn-rm-tramo:hover{color:var(--red);}
.btn-add-tramo{background:none;border:1px dashed var(--border);border-radius:8px;color:var(--muted);font-family:'Sora',sans-serif;font-size:12px;padding:8px 16px;cursor:pointer;width:100%;margin-top:4px;transition:all 0.15s;}
.btn-add-tramo:hover{border-color:var(--gold);color:var(--gold);}
.pax-stops-row{display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap;margin-top:14px;padding-top:14px;border-top:1px solid var(--border);}
.btn-buscar{background:var(--gold);color:#000;border:none;border-radius:9px;font-family:'Sora',sans-serif;font-size:14px;font-weight:700;padding:10px 26px;cursor:pointer;transition:all 0.2s;white-space:nowrap;align-self:flex-end;}
.btn-buscar:hover{background:var(--gold-light);}
.btn-buscar:disabled{opacity:0.5;cursor:not-allowed;}

/* Moneda toggle */
.moneda-toggle{display:flex;gap:4px;align-self:flex-end;}
.moneda-btn{background:var(--dark3);border:1px solid var(--border);border-radius:7px;color:var(--muted);font-family:'Sora',sans-serif;font-size:12px;font-weight:700;padding:9px 14px;cursor:pointer;transition:all 0.15s;}
.moneda-btn.active{background:rgba(201,168,76,0.12);border-color:var(--gold);color:var(--gold);}

.results-layout{display:grid;grid-template-columns:230px 1fr;gap:20px;}
@media(max-width:768px){.results-layout{grid-template-columns:1fr;}}
.filtros-panel{background:var(--dark2);border:1px solid var(--border);border-radius:14px;padding:18px;height:fit-content;position:sticky;top:20px;}
.filtros-title{font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:16px;}
.filtro-grupo{margin-bottom:20px;}
.filtro-grupo-title{font-size:12px;font-weight:600;color:var(--text);margin-bottom:10px;}
.filtro-btn{display:flex;align-items:center;gap:8px;background:var(--dark3);border:1px solid var(--border);border-radius:7px;padding:8px 10px;cursor:pointer;margin-bottom:6px;width:100%;font-family:'Sora',sans-serif;font-size:12px;color:var(--muted);transition:all 0.15s;text-align:left;}
.filtro-btn:hover{border-color:var(--gold);color:var(--text);}
.filtro-btn.active{border-color:var(--gold);background:rgba(201,168,76,0.1);color:var(--gold);}
.filtro-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.filtro-count{margin-left:auto;font-size:10px;background:var(--dark);border-radius:10px;padding:1px 6px;}
.range-slider{width:100%;accent-color:var(--gold);cursor:pointer;}
.range-labels{display:flex;justify-content:space-between;font-size:10px;color:var(--muted);margin-top:4px;}
.btn-limpiar{background:none;border:1px solid var(--border);border-radius:7px;color:var(--muted);font-family:'Sora',sans-serif;font-size:11px;padding:6px 12px;cursor:pointer;width:100%;margin-top:4px;}
.btn-limpiar:hover{border-color:var(--red);color:var(--red);}
.results-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;}
.results-count{font-size:13px;color:var(--muted);}
.results-count strong{color:var(--gold);font-size:20px;margin-right:4px;}
.sort-select{background:var(--dark3);border:1px solid var(--border);border-radius:7px;color:var(--text);font-family:'Sora',sans-serif;font-size:12px;padding:6px 10px;outline:none;}
.tc-badge{font-size:10px;color:var(--muted);margin-left:8px;}

/* VUELO CARD */
.vuelo-card{background:var(--dark2);border:1px solid var(--border);border-radius:12px;margin-bottom:8px;transition:border-color 0.2s;}
.vuelo-card:hover{border-color:rgba(201,168,76,0.4);}
.vuelo-main{display:grid;grid-template-columns:88px 1fr 180px;gap:16px;padding:16px 18px;align-items:center;}
.aero-col{text-align:center;}
.aero-code{font-size:20px;font-weight:700;color:var(--gold);}
.aero-name{font-size:10px;color:var(--muted);margin-top:2px;line-height:1.3;}
.aero-source{font-size:9px;color:var(--muted);margin-top:3px;background:var(--dark3);border-radius:3px;padding:1px 5px;display:inline-block;}
.tramo{padding:2px 0;}
.tramo-label{font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:5px;font-weight:600;}
.tramo-row{display:flex;align-items:center;gap:10px;}
.airport-block{min-width:44px;}
.airport-code{font-size:17px;font-weight:700;}
.airport-time{font-size:12px;color:var(--muted);margin-top:1px;}
.airport-date{font-size:9px;color:var(--muted);}
.tramo-line{flex:1;display:flex;flex-direction:column;align-items:center;gap:3px;}
.line-bar{width:100%;display:flex;align-items:center;gap:4px;}
.line-dot{width:5px;height:5px;border-radius:50%;background:var(--border);flex-shrink:0;}
.line-seg{flex:1;height:1px;background:var(--border);}
.line-plane{font-size:13px;flex-shrink:0;}
.tramo-dur{font-size:10px;color:var(--muted);}
.esc-badge{font-size:9px;font-weight:600;padding:2px 7px;border-radius:10px;text-transform:uppercase;letter-spacing:0.5px;}
.esc-badge.directo{background:rgba(63,185,80,0.15);color:var(--green);}
.esc-badge.una{background:rgba(240,136,62,0.15);color:var(--orange);}
.esc-badge.dos{background:rgba(248,81,73,0.15);color:var(--red);}
.tramo-divider{height:1px;background:var(--border);margin:8px 0;}

/* PRECIO Y EQUIPAJE */
.precio-col{text-align:right;}
.precio-moneda-label{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;}
.precio-amt{font-size:22px;font-weight:700;line-height:1.1;}
.precio-alt{font-size:11px;color:var(--muted);margin-top:1px;}
.precio-pax{font-size:10px;color:var(--muted);}
.precio-expira{font-size:9px;color:var(--muted);margin-top:4px;}
.precio-expira.urgente{color:var(--orange);}

/* Equipaje */
.equipaje-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:4px;margin-top:10px;}
.eq-item{background:var(--dark3);border-radius:6px;padding:5px 6px;text-align:center;border:1px solid var(--border);}
.eq-item.incluido{border-color:rgba(63,185,80,0.3);background:rgba(63,185,80,0.06);}
.eq-item.no-incluido{opacity:0.6;}
.eq-icon{font-size:14px;display:block;margin-bottom:2px;}
.eq-label{font-size:8px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;display:block;}
.eq-valor{font-size:9px;font-weight:600;display:block;margin-top:1px;}
.eq-item.incluido .eq-valor{color:var(--green);}
.eq-item.no-incluido .eq-valor{color:var(--muted);}

.estado{text-align:center;padding:60px 20px;color:var(--muted);}
.estado h3{font-size:17px;color:var(--text);margin:12px 0 6px;}
.spinner{width:36px;height:36px;border:3px solid var(--border);border-top-color:var(--gold);border-radius:50%;animation:spin 0.8s linear infinite;margin:0 auto;}
@keyframes spin{to{transform:rotate(360deg);}}
.no-results{text-align:center;padding:40px;background:var(--dark2);border:1px solid var(--border);border-radius:12px;color:var(--muted);}

.btn-reservar{background:var(--gold);color:#000;border:none;border-radius:7px;font-family:'Sora',sans-serif;font-size:12px;font-weight:700;padding:8px 16px;cursor:pointer;margin-top:8px;width:100%;transition:all 0.2s;}
.btn-reservar:hover{background:var(--gold-light);}

/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:1000;display:flex;align-items:flex-start;justify-content:center;padding:20px;overflow-y:auto;}
.modal{background:var(--dark2);border:1px solid var(--border);border-radius:16px;width:100%;max-width:720px;padding:28px;position:relative;margin:auto;}
.modal-close{position:absolute;top:16px;right:16px;background:none;border:none;color:var(--muted);font-size:20px;cursor:pointer;}
.modal-close:hover{color:var(--text);}
.modal-title{font-size:18px;font-weight:700;margin-bottom:4px;}
.modal-sub{font-size:12px;color:var(--muted);margin-bottom:20px;}
.modal-section{margin-bottom:20px;padding-bottom:20px;border-bottom:1px solid var(--border);}
.modal-section:last-child{border-bottom:none;margin-bottom:0;}
.modal-section-title{font-size:11px;font-weight:700;color:var(--gold);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:14px;}
.form-row{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px;}
.form-field{display:flex;flex-direction:column;gap:4px;flex:1;min-width:120px;}
.form-field label{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;font-weight:600;}
.form-field input,.form-field select{background:var(--dark3);border:1px solid var(--border);border-radius:7px;color:var(--text);font-family:'Sora',sans-serif;font-size:13px;padding:8px 10px;outline:none;width:100%;}
.form-field input:focus,.form-field select:focus{border-color:var(--gold);}
.form-field select option{background:var(--dark3);}
.pax-tab-header{display:flex;gap:6px;margin-bottom:16px;flex-wrap:wrap;}
.pax-tab{background:var(--dark3);border:1px solid var(--border);border-radius:7px;color:var(--muted);font-family:'Sora',sans-serif;font-size:12px;font-weight:600;padding:6px 14px;cursor:pointer;}
.pax-tab.active{border-color:var(--gold);color:var(--gold);background:rgba(201,168,76,0.1);}
.cliente-search{position:relative;}
.cliente-dropdown{position:absolute;top:100%;left:0;right:0;background:var(--dark2);border:1px solid var(--gold);border-radius:8px;z-index:10;max-height:200px;overflow-y:auto;display:none;}
.cliente-dropdown.show{display:block;}
.cliente-item{padding:10px 12px;cursor:pointer;font-size:12px;border-bottom:1px solid var(--border);}
.cliente-item:last-child{border-bottom:none;}
.cliente-item:hover{background:rgba(201,168,76,0.1);}
.cliente-item strong{color:var(--gold);}
.cliente-item span{color:var(--muted);font-size:10px;margin-left:6px;}
.btn-modal-submit{background:var(--gold);color:#000;border:none;border-radius:9px;font-family:'Sora',sans-serif;font-size:15px;font-weight:700;padding:12px 28px;cursor:pointer;width:100%;margin-top:8px;}
.btn-modal-submit:hover{background:var(--gold-light);}
.btn-modal-submit:disabled{opacity:0.5;cursor:not-allowed;}
.reserva-ok{text-align:center;padding:30px 0;}
.reserva-pnr{font-size:42px;font-weight:700;color:var(--gold);letter-spacing:4px;margin:10px 0;}
.reserva-detail{font-size:13px;color:var(--muted);margin-top:6px;}
.alert-diff{background:rgba(248,81,73,0.1);border:1px solid var(--red);border-radius:8px;padding:12px;margin-bottom:16px;font-size:13px;color:var(--red);}
</style>
</head>
<body>
<header>
  <div class="logo-icon">‚úà</div>
  <div>
    <div class="logo-text"><span>Lucky</span> Tour</div>
    <div class="logo-sub">Comparador de Vuelos</div>
  </div>
</header>
<div class="container">
  <div class="search-card">
    <div class="tipo-tabs">
      <button class="tipo-tab active" onclick="setTipo('roundtrip')">‚áÑ Ida y vuelta</button>
      <button class="tipo-tab" onclick="setTipo('oneway')">‚Üí Solo ida</button>
      <button class="tipo-tab" onclick="setTipo('multidestino')">‚äï Multidestino</button>
    </div>
    <div id="form-simple">
      <div class="search-row">
        <div class="field f-sm"><label>Origen</label><input type="text" id="origen" placeholder="BUE" value="BUE" maxlength="3" oninput="this.value=this.value.toUpperCase()"></div>
        <div class="field f-sm"><label>Destino</label><input type="text" id="destino" placeholder="MIA" maxlength="3" oninput="this.value=this.value.toUpperCase()"></div>
        <div class="field f-md"><label>Ida</label><input type="date" id="salida"></div>
        <div class="field f-md" id="field-regreso"><label>Vuelta</label><input type="date" id="regreso"></div>
      </div>
    </div>
    <div id="form-multi" style="display:none">
      <div id="tramos-container"></div>
      <button class="btn-add-tramo" onclick="addTramo()">+ Agregar tramo</button>
    </div>
    <div class="pax-stops-row">
      <div class="field f-xs"><label>Adultos</label><select id="adultos"><option>1</option><option selected>2</option><option>3</option><option>4</option><option>5</option><option>6</option></select></div>
      <div class="field f-xs"><label>Ni√±os</label><select id="ninos"><option selected>0</option><option>1</option><option>2</option><option>3</option></select></div>
      <div class="field f-xs"><label>Infantes</label><select id="infantes"><option selected>0</option><option>1</option><option>2</option></select></div>
      <div class="field f-lg"><label>Escalas</label>
        <select id="stops">
          <option value="">Todas</option>
          <option value="0">Solo directo</option>
          <option value="1">Hasta 1 escala</option>
          <option value="2">Hasta 2 escalas</option>
        </select>
      </div>
      <div class="field"><label>Moneda</label>
        <div class="moneda-toggle">
          <button class="moneda-btn active" id="btn-usd" onclick="setMoneda('USD')">USD</button>
          <button class="moneda-btn" id="btn-ars" onclick="setMoneda('ARS')">ARS</button>
        </div>
      </div>
      <button class="btn-buscar" id="btnBuscar" onclick="buscar()">‚ö° Buscar</button>
    </div>
  </div>
  <div id="mainContent">
    <div class="estado"><div style="font-size:48px">‚úàÔ∏è</div><h3>Busc√° tu vuelo</h3><p>Eleg√≠ el tipo de viaje, complet√° los datos y busc√°</p></div>
  </div>
</div>

<script>
const hoy=new Date();
const d1=new Date(hoy);d1.setMonth(d1.getMonth()+1);
const d2=new Date(d1);d2.setDate(d2.getDate()+7);
document.getElementById('salida').value=d1.toISOString().split('T')[0];
document.getElementById('regreso').value=d2.toISOString().split('T')[0];

let tipoActual='roundtrip';
let monedaActual='USD';
let tcUsdArs=1200;
let todosLosVuelos=[];
let filtros={escalas:-1,maxPrecioUSD:null,aerolineas:[],ordenar:'precio'};

// Cargar tipo de cambio al iniciar
fetch('/tipo-cambio').then(r=>r.json()).then(d=>{
  tcUsdArs=d.bsp||1425;
  console.log('TC USD/ARS:',tcUsdArs);
}).catch(()=>{});

function setMoneda(m){
  monedaActual=m;
  document.getElementById('btn-usd').classList.toggle('active',m==='USD');
  document.getElementById('btn-ars').classList.toggle('active',m==='ARS');
  if(todosLosVuelos.length>0) aplicarFiltrosYRender();
}

function precioMostrar(precioUSD){
  if(monedaActual==='ARS') return Math.round(precioUSD * tcUsdArs);
  return precioUSD;
}
function fmtPrecio(n){
  if(monedaActual==='ARS') return Math.round(n).toLocaleString('es-AR');
  return n.toLocaleString('es-AR',{minimumFractionDigits:2,maximumFractionDigits:2});
}
function simboloMoneda(){ return monedaActual; }

function setTipo(tipo){
  tipoActual=tipo;
  document.querySelectorAll('.tipo-tab').forEach((t,i)=>{t.classList.toggle('active',['roundtrip','oneway','multidestino'][i]===tipo);});
  document.getElementById('form-simple').style.display=tipo==='multidestino'?'none':'block';
  document.getElementById('form-multi').style.display=tipo==='multidestino'?'block':'none';
  document.getElementById('field-regreso').style.display=tipo==='oneway'?'none':'flex';
  if(tipo==='multidestino'&&document.getElementById('tramos-container').children.length===0){addTramo();addTramo();}
}

let tramoCount=0;
function addTramo(){
  tramoCount++;
  const n=tramoCount;
  const prev=document.getElementById('tramos-container').lastElementChild;
  const prevDest=prev?prev.querySelector('.t-dest')?.value:'';
  const prevDate=prev?prev.querySelector('.t-fecha')?.value:'';
  let nextDate='';
  if(prevDate){const d=new Date(prevDate);d.setDate(d.getDate()+3);nextDate=d.toISOString().split('T')[0];}
  const div=document.createElement('div');
  div.className='tramo-row-multi';div.id=`tramo-${n}`;
  div.innerHTML=`<span class="tramo-num">Tramo ${n}</span>
    <div class="field f-sm"><label>Origen</label><input type="text" class="t-orig" placeholder="BUE" value="${prevDest}" maxlength="3" oninput="this.value=this.value.toUpperCase()"></div>
    <div class="field f-sm"><label>Destino</label><input type="text" class="t-dest" placeholder="MIA" maxlength="3" oninput="this.value=this.value.toUpperCase()"></div>
    <div class="field f-md"><label>Fecha</label><input type="date" class="t-fecha" value="${nextDate}"></div>
    ${n>2?`<button class="btn-rm-tramo" onclick="removeTramo(${n})">‚úï</button>`:''}`;
  document.getElementById('tramos-container').appendChild(div);
}
function removeTramo(n){const el=document.getElementById(`tramo-${n}`);if(el)el.remove();}

function fmt(iso){if(!iso)return'‚Äì';return new Date(iso).toLocaleTimeString('es-AR',{hour:'2-digit',minute:'2-digit',hour12:false});}
function fmtFecha(iso){if(!iso)return'';return new Date(iso).toLocaleDateString('es-AR',{day:'2-digit',month:'short'});}
function fmtExpira(iso){
  if(!iso)return'';
  const diff=Math.floor((new Date(iso)-Date.now())/60000);
  if(diff<0)return'Expirado';
  if(diff<60)return`‚è± ${diff}m`;
  return`‚è± ${Math.floor(diff/60)}h ${diff%60}m`;
}
function escClass(n){return n===0?'directo':n===1?'una':'dos';}
function escLabel(n){return n===0?'Directo':n===1?'1 escala':`${n} escalas`;}

function renderEquipaje(eq){
  const items=[
    {icon:'üéí', label:'Mochila', valor:eq.handOn.label, ok:eq.handOn.incluido},
    {icon:'üß≥', label:'Carry on', valor:eq.carryOn.label, ok:eq.carryOn.incluido},
    {icon:'üì¶', label:'Despachado', valor:eq.checked.label, ok:eq.checked.incluido},
  ];
  return `<div class="equipaje-grid">${items.map(i=>`
    <div class="eq-item ${i.ok?'incluido':'no-incluido'}">
      <span class="eq-icon">${i.icon}</span>
      <span class="eq-label">${i.label}</span>
      <span class="eq-valor">${i.valor}</span>
    </div>`).join('')}</div>`;
}

function renderTramo(leg,label){
  if(!leg)return'';
  const stops=(leg.ciudadesEscala||[]).join(' ¬∑ ');
  const overnight=leg.tripDays>0?`<span style="color:var(--orange);font-size:9px"> +${leg.tripDays}d</span>`:'';
  return`<div class="tramo">
    <div class="tramo-label">${label}</div>
    <div class="tramo-row">
      <div class="airport-block">
        <div class="airport-code">${leg.origen}</div>
        <div class="airport-time">${fmt(leg.salida)}</div>
        <div class="airport-date">${fmtFecha(leg.salida)}</div>
      </div>
      <div class="tramo-line">
        <div class="line-bar"><div class="line-dot"></div><div class="line-seg"></div><div class="line-plane">‚úà</div><div class="line-seg"></div><div class="line-dot"></div></div>
        ${stops?`<div style="font-size:9px;color:var(--orange);margin-top:1px">${stops}</div>`:''}
        <div class="tramo-dur">${leg.duracion||''}</div>
      </div>
      <div class="airport-block" style="text-align:right">
        <div class="airport-code">${leg.destino}${overnight}</div>
        <div class="airport-time">${fmt(leg.llegada)}</div>
        <div class="airport-date">${fmtFecha(leg.llegada)}</div>
      </div>
    </div>
    <div style="margin-top:5px"><span class="esc-badge ${escClass(leg.escalas)}">${escLabel(leg.escalas)}</span></div>
  </div>`;
}

function renderVuelo(v){
  const expiraStr=fmtExpira(v.expira);
  const urgente=expiraStr.includes('m')&&!expiraStr.includes('h');
  const pax=parseInt(document.getElementById('adultos').value)+parseInt(document.getElementById('ninos').value);
  const labels=['üõ´ Ida','üõ¨ Vuelta','‚úà Tramo 3','‚úà Tramo 4','‚úà Tramo 5'];
  const tramosHTML=v.itinerario.map((leg,i)=>{
    const h=renderTramo(leg,labels[i]||`‚úà Tramo ${i+1}`);
    return i>0?`<div class="tramo-divider"></div>${h}`:h;
  }).join('');
  const precio=precioMostrar(v.precioUSD);
  const precioAlt=monedaActual==='USD'
    ? `‚âà ARS ${Math.round(v.precioUSD*tcUsdArs).toLocaleString('es-AR')}`
    : `= USD ${v.precioUSD.toLocaleString('es-AR',{minimumFractionDigits:2})}`;

  return`<div class="vuelo-card">
    <div class="vuelo-main">
      <div class="aero-col">
        <div class="aero-code">${v.aerolinea}</div>
        <div class="aero-name">${v.aerolineaDesc}</div>
        <div class="aero-source">${v.source}</div>
      </div>
      <div>${tramosHTML}</div>
      <div class="precio-col">
        <div class="precio-moneda-label">${v.monedaBase || simboloMoneda()} Total</div>
        <div class="precio-amt">${fmtPrecio(precio)}</div>
        <div class="precio-alt">${precioAlt}</div>
        ${pax>1?`<div class="precio-pax">‚âà ${fmtPrecio(precio/pax)} por pax</div>`:''}
        ${renderEquipaje(v.equipaje)}
        <div class="precio-expira ${urgente?'urgente':''}">${expiraStr}</div>
      </div>
    </div>
  </div>`;
}

function aplicarFiltrosYRender(){
  let vuelos=[...todosLosVuelos];
  if(filtros.escalas>=0)vuelos=vuelos.filter(v=>v.escalas===filtros.escalas);
  if(filtros.aerolineas.length>0)vuelos=vuelos.filter(v=>filtros.aerolineas.includes(v.aerolinea));
  if(filtros.maxPrecioUSD)vuelos=vuelos.filter(v=>v.precioUSD<=filtros.maxPrecioUSD);
  if(filtros.ordenar==='precio')vuelos.sort((a,b)=>a.precioUSD-b.precioUSD);
  else if(filtros.ordenar==='duracion')vuelos.sort((a,b)=>(a.itinerario[0]?.duracionMin||999)-(b.itinerario[0]?.duracionMin||999));
  else if(filtros.ordenar==='salida')vuelos.sort((a,b)=>new Date(a.itinerario[0]?.salida)-new Date(b.itinerario[0]?.salida));

  const cuentas={0:0,1:0,2:0};
  todosLosVuelos.forEach(v=>{cuentas[Math.min(v.escalas,2)]++;});
  const aerosMap={};
  todosLosVuelos.forEach(v=>{aerosMap[v.aerolinea]=v.aerolineaDesc;});
  const precioMinUSD=Math.min(...todosLosVuelos.map(v=>v.precioUSD));
  const precioMaxUSD=Math.max(...todosLosVuelos.map(v=>v.precioUSD));
  const currentMaxUSD=filtros.maxPrecioUSD||precioMaxUSD;
  const sym=simboloMoneda();
  const conv=monedaActual==='ARS'?tcUsdArs:1;
  const tcLabel=monedaActual==='ARS'?`<span class="tc-badge">BSP: $${Math.round(tcUsdArs).toLocaleString()}</span>`:'';

  document.getElementById('mainContent').innerHTML=`
    <div class="results-layout">
      <div class="filtros-panel">
        <div class="filtros-title">Filtros</div>
        <div class="filtro-grupo">
          <div class="filtro-grupo-title">Escalas</div>
          <button class="filtro-btn ${filtros.escalas===-1?'active':''}" onclick="setFE(-1)"><div class="filtro-dot" style="background:var(--blue)"></div>Todos<span class="filtro-count">${todosLosVuelos.length}</span></button>
          <button class="filtro-btn ${filtros.escalas===0?'active':''}" onclick="setFE(0)"><div class="filtro-dot" style="background:var(--green)"></div>Directo<span class="filtro-count">${cuentas[0]}</span></button>
          <button class="filtro-btn ${filtros.escalas===1?'active':''}" onclick="setFE(1)"><div class="filtro-dot" style="background:var(--orange)"></div>1 escala<span class="filtro-count">${cuentas[1]}</span></button>
          <button class="filtro-btn ${filtros.escalas===2?'active':''}" onclick="setFE(2)"><div class="filtro-dot" style="background:var(--red)"></div>2+ escalas<span class="filtro-count">${cuentas[2]}</span></button>
        </div>
        <div class="filtro-grupo">
          <div class="filtro-grupo-title">Precio m√°ximo ${tcLabel}</div>
          <input type="range" class="range-slider" min="${precioMinUSD}" max="${precioMaxUSD}" value="${currentMaxUSD}" oninput="setFP(this.value)">
          <div class="range-labels">
            <span>${sym} ${Math.round(precioMinUSD*conv).toLocaleString()}</span>
            <span style="color:var(--gold)">${sym} ${Math.round(currentMaxUSD*conv).toLocaleString()}</span>
          </div>
        </div>
        <div class="filtro-grupo">
          <div class="filtro-grupo-title">Aerol√≠nea</div>
          ${Object.entries(aerosMap).map(([code,name])=>`<button class="filtro-btn ${filtros.aerolineas.includes(code)?'active':''}" onclick="toggleAero('${code}')"><span style="font-weight:700;color:var(--gold)">${code}</span> ${name}</button>`).join('')}
        </div>
        <button class="btn-limpiar" onclick="limpiarFiltros()">‚úï Limpiar filtros</button>
      </div>
      <div>
        <div class="results-header">
          <div class="results-count"><strong>${vuelos.length}</strong> opciones${todosLosVuelos.length>vuelos.length?` (de ${todosLosVuelos.length})`:''}</div>
          <select class="sort-select" onchange="setOrden(this.value)">
            <option value="precio" ${filtros.ordenar==='precio'?'selected':''}>Precio ‚Üë</option>
            <option value="duracion" ${filtros.ordenar==='duracion'?'selected':''}>Duraci√≥n ‚Üë</option>
            <option value="salida" ${filtros.ordenar==='salida'?'selected':''}>Hora de salida</option>
          </select>
        </div>
        ${vuelos.length===0?'<div class="no-results">üòï Sin resultados con estos filtros</div>':vuelos.map(renderVuelo).join('')}
      </div>
    </div>`;
}

function setFE(n){filtros.escalas=n;aplicarFiltrosYRender();}
function setFP(v){filtros.maxPrecioUSD=parseFloat(v);aplicarFiltrosYRender();}
function toggleAero(code){filtros.aerolineas.includes(code)?filtros.aerolineas=filtros.aerolineas.filter(a=>a!==code):filtros.aerolineas.push(code);aplicarFiltrosYRender();}
function setOrden(v){filtros.ordenar=v;aplicarFiltrosYRender();}
function limpiarFiltros(){filtros={escalas:-1,maxPrecioUSD:null,aerolineas:[],ordenar:'precio'};aplicarFiltrosYRender();}

async function buscar(){
  const adultos=document.getElementById('adultos').value;
  const ninos=document.getElementById('ninos').value;
  const infantes=document.getElementById('infantes').value;
  const stops=document.getElementById('stops').value;
  let body={tipo:tipoActual,adultos,ninos,infantes,stops:stops||undefined};
  if(tipoActual==='multidestino'){
    const tramosEls=document.getElementById('tramos-container').querySelectorAll('.tramo-row-multi');
    const tramos=[];
    for(const el of tramosEls){
      const o=el.querySelector('.t-orig').value.trim().toUpperCase();
      const d=el.querySelector('.t-dest').value.trim().toUpperCase();
      const f=el.querySelector('.t-fecha').value;
      if(!o||!d||!f){alert('Complet√° todos los tramos');return;}
      tramos.push({origen:o,destino:d,salida:f});
    }
    if(tramos.length<2){alert('Agreg√° al menos 2 tramos');return;}
    body.tramos=tramos;
  } else {
    const origen=document.getElementById('origen').value.trim().toUpperCase();
    const destino=document.getElementById('destino').value.trim().toUpperCase();
    const salida=document.getElementById('salida').value;
    const regreso=document.getElementById('regreso').value;
    if(!origen||!destino||!salida||(tipoActual==='roundtrip'&&!regreso)){alert('Complet√° todos los campos');return;}
    body={...body,origen,destino,salida,regreso};
  }
  document.getElementById('mainContent').innerHTML=`<div class="estado"><div class="spinner"></div><h3>Buscando vuelos...</h3><p>Puede tardar hasta 30 segundos</p></div>`;
  const btn=document.getElementById('btnBuscar');btn.disabled=true;btn.textContent='‚è≥ Buscando...';
  try{
    const res=await fetch('/buscar-vuelos',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    const data=await res.json();
    if(data.searchId) searchIdActual=data.searchId;
    if(!data.ok){document.getElementById('mainContent').innerHTML=`<div class="estado"><div style="font-size:40px">‚ö†Ô∏è</div><h3>Error</h3><p>${data.error}</p></div>`;return;}
    todosLosVuelos=data.vuelos||[];
    filtros={escalas:-1,maxPrecioUSD:null,aerolineas:[],ordenar:'precio'};
    if(!todosLosVuelos.length){document.getElementById('mainContent').innerHTML=`<div class="estado"><div style="font-size:40px">üîç</div><h3>Sin resultados</h3><p>Prob√° otras fechas o destinos</p></div>`;return;}
    aplicarFiltrosYRender();
  }catch(err){
    document.getElementById('mainContent').innerHTML=`<div class="estado"><div style="font-size:40px">‚ö†Ô∏è</div><h3>Error de conexi√≥n</h3><p>${err.message}</p></div>`;
  }finally{btn.disabled=false;btn.textContent='‚ö° Buscar';}
}
document.addEventListener('keydown',e=>{if(e.key==='Enter')buscar();});
</script>

<!-- MODAL DE RESERVA -->
<div id="modalReserva" class="modal-overlay" style="display:none">
  <div class="modal">
    <button class="modal-close" onclick="cerrarModal()">‚úï</button>
    <div id="modalContenido"></div>
  </div>
</div>

<script>
// ‚îÄ‚îÄ‚îÄ ESTADO RESERVA ‚îÄ‚îÄ‚îÄ
let searchIdActual = '';
let vueloSeleccionado = null;
let paisesData = [];
let paxActivo = 0;
let pasajerosForms = [];

// searchId se captura en la respuesta de /buscar-vuelos
const _buscarBtn = document.getElementById('btnBuscar');

async function cargarPaises() {
  if (paisesData.length) return paisesData;
  const r = await fetch('/document-countries?documentFor=Passengers');
  const d = await r.json();
  paisesData = d.data || [];
  return paisesData;
}

function getPaisOpts(selectedId) {
  return paisesData.map(p => `<option value="${p.Id}" ${p.Id===selectedId?'selected':''}>${p.Name}</option>`).join('');
}
function getDocTipoOpts(paisId, selectedId) {
  const pais = paisesData.find(p=>p.Id===paisId);
  const tipos = pais?.DocumentTypes || [];
  return tipos.map(t => `<option value="${t.Id}" data-code="${t.Code}" ${t.Id===selectedId?'selected':''}>${t.Name}</option>`).join('');
}
function getFactTipoOpts(paisId, selectedId) {
  const pais = paisesData.find(p=>p.Id===paisId);
  const tipos = pais?.AccountingDocumentTypes || pais?.DocumentTypes || [];
  return tipos.map(t => `<option value="${t.Id}" data-code="${t.Code}" ${t.Id===selectedId?'selected':''}>${t.Name}</option>`).join('');
}

// Pa√≠s por defecto Argentina
function getPaisDefaultId() {
  const arg = paisesData.find(p=>p.Name==='Argentina');
  return arg?.Id || '';
}

async function abrirReserva(quotationId, searchId, e) {
  e.stopPropagation();
  if (!searchId) { alert('Hac√© una nueva b√∫squeda para reservar'); return; }
  
  // Encontrar el vuelo
  vueloSeleccionado = todosLosVuelos.find(v=>v.id==quotationId);
  if (!vueloSeleccionado) return;

  document.getElementById('modalReserva').style.display = 'flex';
  document.getElementById('modalContenido').innerHTML = '<div class="estado"><div class="spinner"></div><h3>Verificando disponibilidad...</h3></div>';

  try {
    // Check availability
    const chk = await fetch('/check-availability', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ searchId, quotationId: String(quotationId) })
    }).then(r=>r.json());

    if (!chk.ok) throw new Error(chk.error);

    // Cargar pa√≠ses
    await cargarPaises();

    // Inicializar forms de pasajeros
    const adultos = parseInt(document.getElementById('adultos').value);
    const ninos = parseInt(document.getElementById('ninos').value);
    const infantes = parseInt(document.getElementById('infantes').value);
    pasajerosForms = [];
    for(let i=0;i<adultos;i++) pasajerosForms.push({tipo:'ADT', idx:i});
    for(let i=0;i<ninos;i++) pasajerosForms.push({tipo:'CHD', idx:i});
    for(let i=0;i<infantes;i++) pasajerosForms.push({tipo:'INF', idx:i});
    paxActivo = 0;

    renderModalReserva(searchId, quotationId, chk.hasDifferences);
  } catch(err) {
    document.getElementById('modalContenido').innerHTML = `<div class="estado"><div style="font-size:40px">‚ö†Ô∏è</div><h3>Error</h3><p>${err.message}</p></div>`;
  }
}

function renderModalReserva(searchId, quotationId, hasDiff) {
  const v = vueloSeleccionado;
  const pax = pasajerosForms[paxActivo];
  const tipoLabel = pax.tipo==='ADT'?'Adulto':pax.tipo==='CHD'?'Ni√±o':'Infante';
  const paxNum = pax.idx+1;
  const paisDefId = getPaisDefaultId();

  const tabs = pasajerosForms.map((p,i) => {
    const lbl = p.tipo==='ADT'?`Adulto ${p.idx+1}`:p.tipo==='CHD'?`Ni√±o ${p.idx+1}`:`Infante ${p.idx+1}`;
    return `<button class="pax-tab ${i===paxActivo?'active':''}" onclick="cambiarPax(${i})">${lbl}</button>`;
  }).join('');

  document.getElementById('modalContenido').innerHTML = `
    <div class="modal-title">‚úà Confirmar Reserva</div>
    <div class="modal-sub">${v.aerolinea} ¬∑ ${v.itinerario.map(l=>l.origen+' ‚Üí '+l.destino).join(' | ')} ¬∑ USD ${v.precioUSD?.toFixed(2)}</div>
    ${hasDiff?'<div class="alert-diff">‚ö†Ô∏è El precio del vuelo cambi√≥. Verific√° antes de confirmar.</div>':''}

    <div class="modal-section">
      <div class="modal-section-title">Pasajeros</div>
      <div class="pax-tab-header">${tabs}</div>
      <div id="paxForm"></div>
    </div>

    <div class="modal-section">
      <div class="modal-section-title">Datos de contacto</div>
      <div class="form-row">
        <div class="form-field"><label>Apellido*</label><input id="c_apellido" placeholder="Apellido"></div>
        <div class="form-field"><label>Nombre*</label><input id="c_nombre" placeholder="Nombre"></div>
      </div>
      <div class="form-row">
        <div class="form-field"><label>Email*</label><input id="c_email" type="email" placeholder="email@ejemplo.com"></div>
        <div class="form-field"><label>Tel√©fono 1*</label><input id="c_tel1" placeholder="+54 11 1234-5678"></div>
        <div class="form-field"><label>Tel√©fono 2</label><input id="c_tel2" placeholder="Opcional"></div>
      </div>
    </div>

    <button class="btn-modal-submit" id="btnConfirmar" onclick="confirmarReserva('${searchId}','${quotationId}')">Confirmar Reserva</button>
  `;

  renderPaxForm(paxActivo);
}

function renderPaxForm(idx) {
  const pax = pasajerosForms[idx];
  const paisDefId = getPaisDefaultId();
  const saved = pax.data || {};
  const docPaisId = saved.docPaisId || paisDefId;
  const factPaisId = saved.factPaisId || paisDefId;

  document.getElementById('paxForm').innerHTML = `
    <div class="cliente-search" style="margin-bottom:14px">
      <div class="form-field">
        <label>Buscar cliente existente</label>
        <input id="buscarCliente_${idx}" placeholder="Apellido, nombre o documento..." oninput="buscarCliente(${idx}, this.value)" autocomplete="off">
      </div>
      <div class="cliente-dropdown" id="dropdown_${idx}"></div>
    </div>
    <div class="form-row">
      <div class="form-field" style="flex:2"><label>Apellido*</label><input id="p_apellido_${idx}" placeholder="APELLIDO" value="${saved.apellido||''}" oninput="guardarPaxField(${idx},'apellido',this.value)"></div>
      <div class="form-field" style="flex:2"><label>Nombre*</label><input id="p_nombre_${idx}" placeholder="NOMBRE" value="${saved.nombre||''}" oninput="guardarPaxField(${idx},'nombre',this.value)"></div>
      <div class="form-field" style="flex:1"><label>G√©nero*</label>
        <select id="p_genero_${idx}" onchange="guardarPaxField(${idx},'genero',this.value)">
          <option value="">-</option>
          <option value="0" ${saved.genero=='0'?'selected':''}>Masculino</option>
          <option value="1" ${saved.genero=='1'?'selected':''}>Femenino</option>
        </select>
      </div>
    </div>
    <div class="form-row">
      <div class="form-field"><label>Email</label><input id="p_email_${idx}" type="email" value="${saved.email||''}" placeholder="email@ejemplo.com" oninput="guardarPaxField(${idx},'email',this.value)"></div>
      <div class="form-field"><label>Fecha nac. (D/M/A)*</label>
        <div style="display:flex;gap:4px">
          <input id="p_nacDia_${idx}" type="number" placeholder="DD" min="1" max="31" style="width:52px" value="${saved.fechaNacDia||''}" oninput="guardarPaxField(${idx},'fechaNacDia',this.value)">
          <input id="p_nacMes_${idx}" type="number" placeholder="MM" min="1" max="12" style="width:52px" value="${saved.fechaNacMes||''}" oninput="guardarPaxField(${idx},'fechaNacMes',this.value)">
          <input id="p_nacAnio_${idx}" type="number" placeholder="AAAA" min="1900" max="2026" style="width:72px" value="${saved.fechaNacAnio||''}" oninput="guardarPaxField(${idx},'fechaNacAnio',this.value)">
        </div>
      </div>
    </div>
    <div style="font-size:10px;color:var(--gold);text-transform:uppercase;letter-spacing:1px;font-weight:700;margin:10px 0 8px">Documento de viaje</div>
    <div class="form-row">
      <div class="form-field"><label>Pa√≠s doc.*</label>
        <select id="p_docPais_${idx}" onchange="onDocPaisChange(${idx})">
          <option value="">Seleccionar</option>
          ${getPaisOpts(docPaisId)}
        </select>
      </div>
      <div class="form-field"><label>Tipo doc.*</label>
        <select id="p_docTipo_${idx}" onchange="guardarPaxField(${idx},'docTipoId',this.value);guardarPaxField(${idx},'docTipo',this.options[this.selectedIndex]?.dataset.code)">
          <option value="">-</option>
          ${getDocTipoOpts(docPaisId, saved.docTipoId||'')}
        </select>
      </div>
      <div class="form-field"><label>Nro. documento*</label><input id="p_docNum_${idx}" value="${saved.docNumero||''}" placeholder="12345678" oninput="guardarPaxField(${idx},'docNumero',this.value)"></div>
    </div>
    <div class="form-row">
      <div class="form-field"><label>Nacionalidad*</label>
        <select id="p_nac_${idx}" onchange="guardarPaxField(${idx},'nacionalidadId',this.value)">
          <option value="">Seleccionar</option>
          ${getPaisOpts(saved.nacionalidadId||docPaisId)}
        </select>
      </div>
      <div class="form-field"><label>Venc. doc. (D/M/A)*</label>
        <div style="display:flex;gap:4px">
          <input id="p_vencDia_${idx}" type="number" placeholder="DD" min="1" max="31" style="width:52px" value="${saved.docVencDia||''}" oninput="guardarPaxField(${idx},'docVencDia',this.value)">
          <input id="p_vencMes_${idx}" type="number" placeholder="MM" min="1" max="12" style="width:52px" value="${saved.docVencMes||''}" oninput="guardarPaxField(${idx},'docVencMes',this.value)">
          <input id="p_vencAnio_${idx}" type="number" placeholder="AAAA" min="2026" max="2055" style="width:72px" value="${saved.docVencAnio||''}" oninput="guardarPaxField(${idx},'docVencAnio',this.value)">
        </div>
      </div>
    </div>
    <div style="font-size:10px;color:var(--gold);text-transform:uppercase;letter-spacing:1px;font-weight:700;margin:10px 0 8px">Documento de facturaci√≥n</div>
    <div class="form-row">
      <div class="form-field"><label>Pa√≠s fact.*</label>
        <select id="p_factPais_${idx}" onchange="onFactPaisChange(${idx})">
          <option value="">Seleccionar</option>
          ${getPaisOpts(factPaisId)}
        </select>
      </div>
      <div class="form-field"><label>Tipo fact.*</label>
        <select id="p_factTipo_${idx}" onchange="guardarPaxField(${idx},'factTipoId',this.value);guardarPaxField(${idx},'factTipo',this.options[this.selectedIndex]?.dataset.code)">
          <option value="">-</option>
          ${getFactTipoOpts(factPaisId, saved.factTipoId||'')}
        </select>
      </div>
      <div class="form-field"><label>Nro. fact.*</label><input id="p_factNum_${idx}" value="${saved.factNumero||''}" placeholder="20123456789" oninput="guardarPaxField(${idx},'factNumero',this.value)"></div>
    </div>
  `;

  // Guardar valores iniciales
  if (docPaisId) { guardarPaxField(idx,'docPaisId',docPaisId); guardarPaxField(idx,'docPais', paisesData.find(p=>p.Id===docPaisId)?.Name||''); }
  if (factPaisId) { guardarPaxField(idx,'factPaisId',factPaisId); guardarPaxField(idx,'factPais', paisesData.find(p=>p.Id===factPaisId)?.Name||''); }
}

function guardarPaxField(idx, campo, valor) {
  if (!pasajerosForms[idx].data) pasajerosForms[idx].data = {};
  pasajerosForms[idx].data[campo] = valor;
}

function onDocPaisChange(idx) {
  const sel = document.getElementById(`p_docPais_${idx}`);
  const paisId = sel.value;
  const paisNombre = sel.options[sel.selectedIndex]?.text || '';
  guardarPaxField(idx,'docPaisId',paisId);
  guardarPaxField(idx,'docPais',paisNombre);
  // Actualizar tipos de doc
  document.getElementById(`p_docTipo_${idx}`).innerHTML = '<option value="">-</option>' + getDocTipoOpts(paisId,'');
  document.getElementById(`p_nac_${idx}`).innerHTML = '<option value="">Seleccionar</option>' + getPaisOpts(paisId);
  guardarPaxField(idx,'nacionalidadId',paisId);
}

function onFactPaisChange(idx) {
  const sel = document.getElementById(`p_factPais_${idx}`);
  const paisId = sel.value;
  const paisNombre = sel.options[sel.selectedIndex]?.text || '';
  guardarPaxField(idx,'factPaisId',paisId);
  guardarPaxField(idx,'factPais',paisNombre);
  document.getElementById(`p_factTipo_${idx}`).innerHTML = '<option value="">-</option>' + getFactTipoOpts(paisId,'');
}

function cambiarPax(idx) {
  // Guardar datos actuales del form antes de cambiar
  const i = paxActivo;
  const campos = ['apellido','nombre','genero','email','nacDia','nacMes','nacAnio','docNum','vencDia','vencMes','vencAnio','factNum'];
  const mapeo = {apellido:'apellido',nombre:'nombre',genero:'genero',email:'email',nacDia:'fechaNacDia',nacMes:'fechaNacMes',nacAnio:'fechaNacAnio',docNum:'docNumero',vencDia:'docVencDia',vencMes:'docVencMes',vencAnio:'docVencAnio',factNum:'factNumero'};
  for(const c of campos) {
    const el = document.getElementById(`p_${c}_${i}`);
    if(el) guardarPaxField(i, mapeo[c], el.value);
  }
  paxActivo = idx;
  document.querySelectorAll('.pax-tab').forEach((t,ti)=>t.classList.toggle('active',ti===idx));
  renderPaxForm(idx);
}

async function buscarCliente(idx, q) {
  const dd = document.getElementById(`dropdown_${idx}`);
  if (q.length < 2) { dd.classList.remove('show'); return; }
  const clientes = await fetch(`/clientes/buscar?q=${encodeURIComponent(q)}`).then(r=>r.json());
  if (!clientes.length) { dd.classList.remove('show'); return; }
  dd.innerHTML = clientes.map(c => `
    <div class="cliente-item" onclick="precargarCliente(${idx}, ${c.id})">
      <strong>${c.apellido}, ${c.nombre}</strong>
      <span>${c.doc_tipo} ${c.doc_numero}</span>
      <span>${c.email||''}</span>
    </div>
  `).join('');
  dd.classList.add('show');
}

async function precargarCliente(idx, clienteId) {
  document.getElementById(`dropdown_${idx}`).classList.remove('show');
  const clientes = await fetch('/clientes').then(r=>r.json());
  const c = clientes.find(x=>x.id===clienteId);
  if (!c) return;
  
  // Guardar todos los datos
  if (!pasajerosForms[idx].data) pasajerosForms[idx].data = {};
  Object.assign(pasajerosForms[idx].data, {
    apellido: c.apellido, nombre: c.nombre, email: c.email||'',
    genero: String(c.genero||'0'),
    fechaNacDia: c.fecha_nac_dia, fechaNacMes: c.fecha_nac_mes, fechaNacAnio: c.fecha_nac_anio,
    docPais: c.doc_pais, docPaisId: c.doc_pais_id,
    docTipo: c.doc_tipo, docTipoId: c.doc_tipo_id, docNumero: c.doc_numero,
    docVencDia: c.doc_venc_dia, docVencMes: c.doc_venc_mes, docVencAnio: c.doc_venc_anio,
    nacionalidad: c.nacionalidad, nacionalidadId: c.nacionalidad_id,
    factPais: c.fact_pais, factPaisId: c.fact_pais_id,
    factTipo: c.fact_tipo, factTipoId: c.fact_tipo_id, factNumero: c.fact_numero
  });
  renderPaxForm(idx);
  document.getElementById(`buscarCliente_${idx}`).value = `${c.apellido}, ${c.nombre}`;
}

async function confirmarReserva(searchId, quotationId) {
  // Guardar datos del pax activo
  cambiarPax(paxActivo);

  // Validar
  for(const pax of pasajerosForms) {
    const d = pax.data || {};
    if(!d.apellido||!d.nombre||!d.docNumero) {
      alert(`Complet√° los datos del pasajero ${pax.tipo} ${pax.idx+1}`);
      return;
    }
  }
  const cApellido = document.getElementById('c_apellido').value;
  const cNombre = document.getElementById('c_nombre').value;
  const cEmail = document.getElementById('c_email').value;
  const cTel1 = document.getElementById('c_tel1').value;
  if(!cApellido||!cNombre||!cEmail||!cTel1) { alert('Complet√° los datos de contacto'); return; }

  const btn = document.getElementById('btnConfirmar');
  btn.disabled = true; btn.textContent = '‚è≥ Procesando...';

  const pasajeros = pasajerosForms.map(p => ({ tipo: p.tipo, ...p.data }));
  const contacto = { apellido: cApellido, nombre: cNombre, email: cEmail, telefono1: cTel1, telefono2: document.getElementById('c_tel2').value };
  const v = vueloSeleccionado;
  const vueloInfo = {
    tipo: 'vuelo', origen: v.itinerario[0]?.origen, destino: v.itinerario[v.itinerario.length-1]?.destino,
    salida: v.itinerario[0]?.salida, aerolinea: v.aerolinea,
    precioUSD: v.precioUSD, moneda: 'USD', itinerario: v.itinerario
  };

  try {
    const res = await fetch('/crear-reserva', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ searchId, quotationId: String(quotationId), pasajeros, contacto, vueloInfo })
    }).then(r=>r.json());

    if (!res.ok) throw new Error(res.error);

    document.getElementById('modalContenido').innerHTML = `
      <div class="reserva-ok">
        <div style="font-size:48px">‚úÖ</div>
        <div style="font-size:13px;color:var(--muted);margin-top:12px">Reserva confirmada</div>
        <div class="reserva-pnr">${res.pnr}</div>
        <div class="reserva-detail">Nro. de orden: ${res.orderNumber}</div>
        <div class="reserva-detail" style="margin-top:16px">${v.aerolinea} ¬∑ ${v.itinerario.map(l=>l.origen+' ‚Üí '+l.destino).join(' | ')}</div>
        <div class="reserva-detail">USD ${v.precioUSD?.toFixed(2)}</div>
        <button class="btn-modal-submit" style="margin-top:20px;max-width:200px;margin-left:auto;margin-right:auto" onclick="cerrarModal()">Cerrar</button>
      </div>
    `;
  } catch(err) {
    btn.disabled = false; btn.textContent = 'Confirmar Reserva';
    alert('Error: ' + err.message);
  }
}

function cerrarModal() {
  document.getElementById('modalReserva').style.display = 'none';
  vueloSeleccionado = null;
  pasajerosForms = [];
}

// Cerrar al hacer click fuera
document.getElementById('modalReserva').addEventListener('click', function(e) {
  if(e.target === this) cerrarModal();
});
</script>

</body>
</html>
