<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lucky Tour ‚Äî Comparador de Vuelos</title>
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{--gold:#C9A84C;--gold-light:#E8CC7A;--dark:#0D1117;--dark2:#161B22;--dark3:#21262D;--border:#30363D;--text:#E6EDF3;--muted:#8B949E;--green:#3FB950;--blue:#58A6FF;--red:#F85149;--orange:#F0883E;}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Sora',sans-serif;background:var(--dark);color:var(--text);min-height:100vh;}
header{background:var(--dark2);border-bottom:1px solid var(--border);padding:14px 28px;display:flex;align-items:center;gap:12px;}
.logo-icon{width:36px;height:36px;background:var(--gold);border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:18px;}
.logo-text{font-size:17px;font-weight:700;}.logo-text span{color:var(--gold);}
.logo-sub{font-size:10px;color:var(--muted);letter-spacing:2px;text-transform:uppercase;}
.container{max-width:1200px;margin:0 auto;padding:24px 20px;}
.search-card{background:var(--dark2);border:1px solid var(--border);border-radius:14px;padding:22px 24px;margin-bottom:24px;}
.tipo-tabs{display:flex;gap:6px;margin-bottom:20px;}
.tipo-tab{background:var(--dark3);border:1px solid var(--border);border-radius:8px;color:var(--muted);font-family:'Sora',sans-serif;font-size:12px;font-weight:600;padding:7px 16px;cursor:pointer;transition:all 0.15s;}
.tipo-tab:hover{border-color:var(--gold);color:var(--text);}
.tipo-tab.active{background:rgba(201,168,76,0.12);border-color:var(--gold);color:var(--gold);}
.search-row{display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap;}
.field{display:flex;flex-direction:column;gap:5px;}
.field label{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;font-weight:600;}
.field input,.field select{background:var(--dark3);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:'Sora',sans-serif;font-size:14px;padding:9px 11px;outline:none;transition:border-color 0.2s;}
.field input:focus,.field select:focus{border-color:var(--gold);}
.field select option{background:var(--dark3);}
.f-sm{width:90px;}.f-md{width:145px;}.f-xs{width:72px;}.f-lg{width:140px;}
.tramo-row-multi{display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap;padding:12px;background:var(--dark3);border-radius:10px;margin-bottom:8px;position:relative;}
.tramo-num{font-size:10px;font-weight:700;color:var(--gold);text-transform:uppercase;letter-spacing:1px;align-self:center;min-width:60px;}
.btn-rm-tramo{position:absolute;top:8px;right:8px;background:none;border:none;color:var(--muted);cursor:pointer;font-size:16px;padding:2px 6px;border-radius:4px;}
.btn-rm-tramo:hover{color:var(--red);}
.btn-add-tramo{background:none;border:1px dashed var(--border);border-radius:8px;color:var(--muted);font-family:'Sora',sans-serif;font-size:12px;padding:8px 16px;cursor:pointer;width:100%;margin-top:4px;transition:all 0.15s;}
.btn-add-tramo:hover{border-color:var(--gold);color:var(--gold);}
.pax-stops-row{display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap;margin-top:14px;padding-top:14px;border-top:1px solid var(--border);}
.btn-buscar{background:var(--gold);color:#000;border:none;border-radius:9px;font-family:'Sora',sans-serif;font-size:14px;font-weight:700;padding:10px 26px;cursor:pointer;transition:all 0.2s;white-space:nowrap;align-self:flex-end;}
.btn-buscar:hover{background:var(--gold-light);}
.btn-buscar:disabled{opacity:0.5;cursor:not-allowed;}

/* Moneda toggle */
.moneda-toggle{display:flex;gap:4px;align-self:flex-end;}
.moneda-btn{background:var(--dark3);border:1px solid var(--border);border-radius:7px;color:var(--muted);font-family:'Sora',sans-serif;font-size:12px;font-weight:700;padding:9px 14px;cursor:pointer;transition:all 0.15s;}
.moneda-btn.active{background:rgba(201,168,76,0.12);border-color:var(--gold);color:var(--gold);}

.results-layout{display:grid;grid-template-columns:230px 1fr;gap:20px;}
@media(max-width:768px){.results-layout{grid-template-columns:1fr;}}
.filtros-panel{background:var(--dark2);border:1px solid var(--border);border-radius:14px;padding:18px;height:fit-content;position:sticky;top:20px;}
.filtros-title{font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:16px;}
.filtro-grupo{margin-bottom:20px;}
.filtro-grupo-title{font-size:12px;font-weight:600;color:var(--text);margin-bottom:10px;}
.filtro-btn{display:flex;align-items:center;gap:8px;background:var(--dark3);border:1px solid var(--border);border-radius:7px;padding:8px 10px;cursor:pointer;margin-bottom:6px;width:100%;font-family:'Sora',sans-serif;font-size:12px;color:var(--muted);transition:all 0.15s;text-align:left;}
.filtro-btn:hover{border-color:var(--gold);color:var(--text);}
.filtro-btn.active{border-color:var(--gold);background:rgba(201,168,76,0.1);color:var(--gold);}
.filtro-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.filtro-count{margin-left:auto;font-size:10px;background:var(--dark);border-radius:10px;padding:1px 6px;}
.range-slider{width:100%;accent-color:var(--gold);cursor:pointer;}
.range-labels{display:flex;justify-content:space-between;font-size:10px;color:var(--muted);margin-top:4px;}
.btn-limpiar{background:none;border:1px solid var(--border);border-radius:7px;color:var(--muted);font-family:'Sora',sans-serif;font-size:11px;padding:6px 12px;cursor:pointer;width:100%;margin-top:4px;}
.btn-limpiar:hover{border-color:var(--red);color:var(--red);}
.results-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;}
.results-count{font-size:13px;color:var(--muted);}
.results-count strong{color:var(--gold);font-size:20px;margin-right:4px;}
.sort-select{background:var(--dark3);border:1px solid var(--border);border-radius:7px;color:var(--text);font-family:'Sora',sans-serif;font-size:12px;padding:6px 10px;outline:none;}
.tc-badge{font-size:10px;color:var(--muted);margin-left:8px;}

/* VUELO CARD */
.vuelo-card{background:var(--dark2);border:1px solid var(--border);border-radius:12px;margin-bottom:8px;transition:border-color 0.2s;}
.vuelo-card:hover{border-color:rgba(201,168,76,0.4);}
.vuelo-main{display:grid;grid-template-columns:88px 1fr 180px;gap:16px;padding:16px 18px;align-items:center;}
.aero-col{text-align:center;}
.aero-code{font-size:20px;font-weight:700;color:var(--gold);}
.aero-name{font-size:10px;color:var(--muted);margin-top:2px;line-height:1.3;}
.aero-source{font-size:9px;color:var(--muted);margin-top:3px;background:var(--dark3);border-radius:3px;padding:1px 5px;display:inline-block;}
.tramo{padding:2px 0;}
.tramo-label{font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:5px;font-weight:600;}
.tramo-row{display:flex;align-items:center;gap:10px;}
.airport-block{min-width:44px;}
.airport-code{font-size:17px;font-weight:700;}
.airport-time{font-size:12px;color:var(--muted);margin-top:1px;}
.airport-date{font-size:9px;color:var(--muted);}
.tramo-line{flex:1;display:flex;flex-direction:column;align-items:center;gap:3px;}
.line-bar{width:100%;display:flex;align-items:center;gap:4px;}
.line-dot{width:5px;height:5px;border-radius:50%;background:var(--border);flex-shrink:0;}
.line-seg{flex:1;height:1px;background:var(--border);}
.line-plane{font-size:13px;flex-shrink:0;}
.tramo-dur{font-size:10px;color:var(--muted);}
.esc-badge{font-size:9px;font-weight:600;padding:2px 7px;border-radius:10px;text-transform:uppercase;letter-spacing:0.5px;}
.esc-badge.directo{background:rgba(63,185,80,0.15);color:var(--green);}
.esc-badge.una{background:rgba(240,136,62,0.15);color:var(--orange);}
.esc-badge.dos{background:rgba(248,81,73,0.15);color:var(--red);}
.tramo-divider{height:1px;background:var(--border);margin:8px 0;}

/* PRECIO Y EQUIPAJE */
.precio-col{text-align:right;}
.precio-moneda-label{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;}
.precio-amt{font-size:22px;font-weight:700;line-height:1.1;}
.precio-alt{font-size:11px;color:var(--muted);margin-top:1px;}
.precio-pax{font-size:10px;color:var(--muted);}
.precio-expira{font-size:9px;color:var(--muted);margin-top:4px;}
.precio-expira.urgente{color:var(--orange);}

/* Equipaje */
.equipaje-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:4px;margin-top:10px;}
.eq-item{background:var(--dark3);border-radius:6px;padding:5px 6px;text-align:center;border:1px solid var(--border);}
.eq-item.incluido{border-color:rgba(63,185,80,0.3);background:rgba(63,185,80,0.06);}
.eq-item.no-incluido{opacity:0.6;}
.eq-icon{font-size:14px;display:block;margin-bottom:2px;}
.eq-label{font-size:8px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;display:block;}
.eq-valor{font-size:9px;font-weight:600;display:block;margin-top:1px;}
.eq-item.incluido .eq-valor{color:var(--green);}
.eq-item.no-incluido .eq-valor{color:var(--muted);}

.estado{text-align:center;padding:60px 20px;color:var(--muted);}
.estado h3{font-size:17px;color:var(--text);margin:12px 0 6px;}
.spinner{width:36px;height:36px;border:3px solid var(--border);border-top-color:var(--gold);border-radius:50%;animation:spin 0.8s linear infinite;margin:0 auto;}
@keyframes spin{to{transform:rotate(360deg);}}
.no-results{text-align:center;padding:40px;background:var(--dark2);border:1px solid var(--border);border-radius:12px;color:var(--muted);}

.btn-reservar{background:var(--gold);color:#000;border:none;border-radius:7px;font-family:'Sora',sans-serif;font-size:12px;font-weight:700;padding:8px 16px;cursor:pointer;transition:all 0.2s;}
.btn-reservar:hover{background:var(--gold-light);}

/* Acciones debajo del vuelo - misma grilla que vuelo-main */
.vuelo-actions{display:grid;grid-template-columns:88px 1fr 180px;gap:16px;padding:8px 18px 12px 18px;border-top:1px solid var(--border);align-items:center;}
.vuelo-actions .cotizar-check{font-size:12px;color:var(--muted);cursor:pointer;display:flex;align-items:center;gap:4px;justify-content:center;}
.vuelo-actions .btn-detalle{width:100%;}
.vuelo-actions .btn-reservar{margin-top:0;width:100%;padding:8px 16px;}

/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:1000;display:flex;align-items:flex-start;justify-content:center;padding:20px;overflow-y:auto;}
.modal{background:var(--dark2);border:1px solid var(--border);border-radius:16px;width:100%;max-width:720px;padding:28px;position:relative;margin:auto;}
.modal-close{position:absolute;top:16px;right:16px;background:none;border:none;color:var(--muted);font-size:20px;cursor:pointer;}
.modal-close:hover{color:var(--text);}
.modal-title{font-size:18px;font-weight:700;margin-bottom:4px;}
.modal-sub{font-size:12px;color:var(--muted);margin-bottom:20px;}
.modal-section{margin-bottom:20px;padding-bottom:20px;border-bottom:1px solid var(--border);}
.modal-section:last-child{border-bottom:none;margin-bottom:0;}
.modal-section-title{font-size:11px;font-weight:700;color:var(--gold);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:14px;}
.form-row{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px;}
.form-field{display:flex;flex-direction:column;gap:4px;flex:1;min-width:120px;}
.form-field label{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;font-weight:600;}
.form-field input,.form-field select{background:var(--dark3);border:1px solid var(--border);border-radius:7px;color:var(--text);font-family:'Sora',sans-serif;font-size:13px;padding:8px 10px;outline:none;width:100%;}
.form-field input:focus,.form-field select:focus{border-color:var(--gold);}
.form-field select option{background:var(--dark3);}
.pax-tab-header{display:flex;gap:6px;margin-bottom:16px;flex-wrap:wrap;}
.pax-tab{background:var(--dark3);border:1px solid var(--border);border-radius:7px;color:var(--muted);font-family:'Sora',sans-serif;font-size:12px;font-weight:600;padding:6px 14px;cursor:pointer;}
.pax-tab.active{border-color:var(--gold);color:var(--gold);background:rgba(201,168,76,0.1);}
.cliente-search{position:relative;}
.cliente-dropdown{position:absolute;top:100%;left:0;right:0;background:var(--dark2);border:1px solid var(--gold);border-radius:8px;z-index:10;max-height:200px;overflow-y:auto;display:none;}
.cliente-dropdown.show{display:block;}
.cliente-item{padding:10px 12px;cursor:pointer;font-size:12px;border-bottom:1px solid var(--border);}
.cliente-item:last-child{border-bottom:none;}
.cliente-item:hover{background:rgba(201,168,76,0.1);}
.cliente-item strong{color:var(--gold);}
.cliente-item span{color:var(--muted);font-size:10px;margin-left:6px;}
.btn-modal-submit{background:var(--gold);color:#000;border:none;border-radius:9px;font-family:'Sora',sans-serif;font-size:15px;font-weight:700;padding:12px 28px;cursor:pointer;width:100%;margin-top:8px;}
.btn-modal-submit:hover{background:var(--gold-light);}
.btn-modal-submit:disabled{opacity:0.5;cursor:not-allowed;}
.reserva-ok{text-align:center;padding:30px 0;}
.reserva-pnr{font-size:42px;font-weight:700;color:var(--gold);letter-spacing:4px;margin:10px 0;}
.reserva-detail{font-size:13px;color:var(--muted);margin-top:6px;}
.alert-diff{background:rgba(248,81,73,0.1);border:1px solid var(--red);border-radius:8px;padding:12px;margin-bottom:16px;font-size:13px;color:var(--red);}

.btn-detalle{background:transparent;color:var(--gold);border:1px solid var(--gold);border-radius:7px;font-family:'Sora',sans-serif;font-size:12px;font-weight:600;padding:7px 14px;cursor:pointer;margin-top:6px;width:100%;transition:all 0.2s;}
.btn-detalle:hover{background:rgba(201,168,76,0.1);}
.detalle-panel{background:var(--dark3);border-top:1px solid var(--border);padding:16px 18px;display:none;}
.detalle-panel.show{display:block;}
.detalle-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;}
@media(max-width:768px){.detalle-grid{grid-template-columns:1fr;}}
.detalle-section-title{font-size:10px;font-weight:700;color:var(--gold);text-transform:uppercase;letter-spacing:1px;margin-bottom:10px;}
.detalle-row{display:flex;justify-content:space-between;align-items:center;padding:5px 0;font-size:12px;border-bottom:1px solid var(--border);}
.detalle-row:last-child{border-bottom:none;}
.detalle-row.total{font-weight:700;font-size:14px;color:var(--gold);padding-top:8px;}
.detalle-label{color:var(--muted);}
.detalle-valor{color:var(--text);}
.detalle-venta{background:rgba(201,168,76,0.1);border:1px solid var(--gold);border-radius:8px;padding:10px;margin-top:10px;text-align:center;}
.detalle-venta-precio{font-size:20px;font-weight:700;color:var(--gold);}
.detalle-venta-label{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;}
/* Condiciones table */
.cond-table{width:100%;border-collapse:collapse;font-size:12px;}
.cond-table tr{border-bottom:1px solid var(--border);}
.cond-table tr:last-child{border-bottom:none;}
.cond-table td{padding:7px 0;}
.cond-table .cond-label{color:var(--muted);padding-right:10px;}
.cond-table .cond-monto{text-align:right;font-weight:600;color:var(--text);padding-right:8px;white-space:nowrap;}
.cond-badge{font-size:10px;font-weight:600;padding:2px 8px;border-radius:4px;display:inline-block;white-space:nowrap;}
.cond-badge.permite{background:rgba(63,185,80,0.15);color:var(--green);border:1px solid rgba(63,185,80,0.3);}
.cond-badge.no-permite{background:rgba(248,81,73,0.1);color:var(--red);border:1px solid rgba(248,81,73,0.2);}
.markup-bar{background:var(--dark2);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:16px;display:flex;align-items:center;gap:12px;flex-wrap:wrap;}
.markup-bar label{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;font-weight:600;}
.markup-bar input, .markup-bar select{background:var(--dark3);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:'Sora',sans-serif;font-size:13px;padding:6px 10px;outline:none;width:90px;}
.markup-bar input:focus, .markup-bar select:focus{border-color:var(--gold);}
.btn-markup-save{background:var(--gold);color:#000;border:none;border-radius:6px;font-family:'Sora',sans-serif;font-size:12px;font-weight:700;padding:7px 14px;cursor:pointer;}

/* VISTA RESERVAS */
.reservas-view{display:none;padding:20px;}
.reservas-view.show{display:block;}
/* Reservas stats */
.res-stats{display:flex;gap:12px;flex-wrap:wrap;}
.res-stat{background:var(--dark2);border:1px solid var(--border);border-radius:10px;padding:12px 18px;flex:1;min-width:120px;}
.res-stat .num{font-size:24px;font-weight:700;}
.res-stat .lbl{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;}
.res-stat.creada .num{color:#e67e22;}
.res-stat.emitida .num{color:#2ecc71;}
.res-stat.cancelada .num{color:#e74c3c;}
/* Reservas table dark */
.res-table{width:100%;border-collapse:collapse;font-size:13px;}
.res-table th{text-align:left;padding:10px 12px;font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;border-bottom:2px solid var(--border);font-weight:600;}
.res-table td{padding:10px 12px;border-bottom:1px solid var(--border);vertical-align:middle;}
.res-table tr{cursor:pointer;transition:background 0.15s;}
.res-table tr:hover td{background:rgba(255,255,255,0.03);}
.res-pnr{font-family:'SF Mono',Consolas,monospace;font-weight:700;color:var(--gold);font-size:14px;}
.res-fecha{font-size:11px;color:var(--muted);}
.res-ruta{font-weight:600;}
.res-precio{font-weight:700;}
.badge-res{display:inline-block;padding:3px 10px;border-radius:20px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.3px;}
.badge-CREADA{background:rgba(230,126,34,0.15);color:#e67e22;}
.badge-EMITIDA{background:rgba(46,204,113,0.15);color:#2ecc71;}
.badge-CANCELADA{background:rgba(231,76,60,0.15);color:#e74c3c;}
/* Modal detail dark */
.det-section{margin-bottom:18px;}
.det-section h3{font-size:11px;text-transform:uppercase;letter-spacing:0.5px;color:var(--muted);margin-bottom:8px;}
.det-grid{display:grid;grid-template-columns:repeat(auto-fit, minmax(160px, 1fr));gap:10px;}
.det-item .lbl{font-size:10px;color:var(--muted);text-transform:uppercase;}
.det-item .val{font-size:14px;font-weight:600;margin-top:2px;}
.itin-seg{padding:10px 14px;background:var(--dark2);border-radius:8px;margin-bottom:6px;display:flex;align-items:center;gap:12px;border:1px solid var(--border);}
.itin-seg .idate{font-weight:700;min-width:55px;font-size:12px;color:var(--gold);}
.itin-seg .iroute{flex:1;}
.itin-seg .iroute .cities{font-weight:600;font-size:13px;}
.itin-seg .iroute .fnum{font-size:11px;color:var(--muted);}
.itin-seg .itimes{font-size:12px;color:var(--muted);white-space:nowrap;}
.pax-row-det{padding:8px 14px;background:var(--dark2);border-radius:8px;margin-bottom:5px;display:flex;justify-content:space-between;align-items:center;border:1px solid var(--border);}
.pax-row-det .pname{font-weight:600;font-size:13px;}
.pax-row-det .ptype{font-size:11px;color:var(--muted);}
.pax-row-det .pdoc{font-size:12px;color:var(--muted);}
/* Action buttons dark */
.btn-act{padding:7px 14px;border:none;border-radius:7px;font-size:12px;font-weight:600;cursor:pointer;font-family:'Sora',sans-serif;transition:opacity 0.2s;}
.btn-act:hover{opacity:0.85;}
.btn-act-primary{background:var(--gold);color:#000;}
.btn-act-outline{background:none;border:1px solid var(--border);color:var(--muted);}
.btn-act-success{background:#27ae60;color:#fff;}
.btn-act-danger{background:#e74c3c;color:#fff;}
.btn-act-blue{background:#1565c0;color:#fff;}
/* Recotizar/PDF panel dark */
.recot-panel{background:var(--dark2);border:1px solid var(--border);border-radius:10px;padding:14px;margin-top:14px;}
.recot-panel h4{font-size:13px;margin-bottom:10px;color:var(--gold);}
.recot-opts{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px;}
.recot-opts label{font-size:10px;color:var(--muted);text-transform:uppercase;}
.recot-opts select,.recot-opts input{padding:6px 10px;background:var(--dark3);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:12px;font-family:'Sora',sans-serif;outline:none;}
.tarifa-card-d{background:var(--dark3);border:1px solid var(--border);border-radius:8px;padding:10px;margin-bottom:8px;}
.tarifa-card-d .th{font-weight:700;margin-bottom:6px;font-size:13px;}
.tarifa-card-d .tr{display:flex;justify-content:space-between;font-size:12px;padding:2px 0;}
.tarifa-card-d .tr.total{font-weight:700;font-size:14px;border-top:1px solid var(--border);padding-top:6px;margin-top:4px;}
.notas-dark{width:100%;padding:8px;background:var(--dark2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px;font-family:'Sora',sans-serif;resize:vertical;min-height:50px;outline:none;}
.nav-tabs{display:flex;gap:6px;margin-bottom:20px;}
.nav-tab{background:var(--dark2);border:1px solid var(--border);border-radius:8px;color:var(--muted);font-family:'Sora',sans-serif;font-size:13px;font-weight:600;padding:8px 18px;cursor:pointer;transition:all 0.2s;}
.nav-tab.active{border-color:var(--gold);color:var(--gold);background:rgba(201,168,76,0.1);}
.reservas-table{width:100%;border-collapse:collapse;font-size:13px;}
.reservas-table th{text-align:left;padding:10px 12px;font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;border-bottom:2px solid var(--border);font-weight:600;}
.reservas-table td{padding:10px 12px;border-bottom:1px solid var(--border);vertical-align:middle;}
.reservas-table tr:hover td{background:rgba(255,255,255,0.02);}
.badge{display:inline-block;padding:3px 8px;border-radius:4px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;}
.badge-creada{background:rgba(201,168,76,0.2);color:var(--gold);}
.badge-emitida{background:rgba(40,167,69,0.2);color:#28a745;}
.badge-cancelada{background:rgba(220,53,69,0.2);color:#dc3545;}
.pnr-code{font-family:monospace;font-size:15px;font-weight:700;color:var(--gold);letter-spacing:2px;}

.cotizar-check{display:flex;align-items:center;gap:6px;font-size:11px;color:var(--muted);margin-top:6px;cursor:pointer;}
.cotizar-check input[type=checkbox]{accent-color:var(--gold);width:14px;height:14px;cursor:pointer;}
.cotizar-check:hover{color:var(--text);}
.cotizar-bar{position:fixed;bottom:0;left:0;right:0;background:var(--dark2);border-top:1px solid var(--gold);padding:12px 24px;display:flex;align-items:center;gap:12px;z-index:100;transform:translateY(100%);transition:transform 0.3s;}
.cotizar-bar.show{transform:translateY(0);}
.cotizar-bar-txt{color:var(--gold);font-weight:700;font-size:13px;}
.cotizar-bar select{background:var(--dark3);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:'Sora',sans-serif;font-size:12px;padding:6px 10px;outline:none;}
.cotizar-bar select:focus{border-color:var(--gold);}
.btn-cotizar-gen{background:var(--gold);color:#000;border:none;border-radius:7px;font-family:'Sora',sans-serif;font-size:13px;font-weight:700;padding:9px 20px;cursor:pointer;}
.btn-cotizar-gen:disabled{opacity:0.5;cursor:not-allowed;}
.btn-cotizar-cancel{background:none;border:1px solid var(--border);color:var(--muted);border-radius:7px;font-family:'Sora',sans-serif;font-size:12px;padding:8px 14px;cursor:pointer;}
</style>
</head>
<body>
<header>
  <div class="logo-icon">‚úà</div>
  <div>
    <div class="logo-text"><span>Lucky</span> Tour</div>
    <div class="logo-sub">Comparador de Vuelos</div>
  </div>
  <div style="margin-left:auto;display:flex;align-items:center;gap:10px;">
    <span id="userInfo" style="font-size:11px;color:#8b949e;"></span>
    <button onclick="logout()" style="background:none;border:1px solid #30363d;color:#8b949e;padding:4px 12px;border-radius:6px;font-size:11px;cursor:pointer;font-family:'Sora',sans-serif;">Salir</button>
  </div>
</header>
<script>
// Auth: override fetch para incluir token autom√°ticamente
const _originalFetch = window.fetch;
window.fetch = function(url, opts = {}) {
  const token = localStorage.getItem('lt_session');
  if (token) {
    opts.headers = opts.headers || {};
    if (opts.headers instanceof Headers) {
      opts.headers.set('X-Session-Token', token);
    } else {
      opts.headers['X-Session-Token'] = token;
    }
  }
  return _originalFetch(url, opts).then(res => {
    if (res.status === 401 && !url.includes('/api/login') && !url.includes('/api/session')) {
      localStorage.removeItem('lt_session');
      window.location.href = '/login.html';
    }
    return res;
  });
};
function logout() {
  fetch('/api/logout', { method: 'POST' }).catch(()=>{});
  localStorage.removeItem('lt_session');
  localStorage.removeItem('lt_vendedor');
  localStorage.removeItem('lt_nombre');
  localStorage.removeItem('lt_email');
  window.location.href = '/login.html';
}
// Mostrar info del usuario
const _ltNombre = localStorage.getItem('lt_nombre');
if (_ltNombre) document.getElementById('userInfo').textContent = _ltNombre;
</script>
<div class="container">
  <div class="nav-tabs">
    <button class="nav-tab active" onclick="mostrarVista('buscar',this)">üîç Buscar vuelos</button>
    <button class="nav-tab" onclick="mostrarVista('reservas',this)">üìã Mis reservas</button>
  </div>
  <div class="search-card">
    <div class="tipo-tabs">
      <button class="tipo-tab active" onclick="setTipo('roundtrip')">‚áÑ Ida y vuelta</button>
      <button class="tipo-tab" onclick="setTipo('oneway')">‚Üí Solo ida</button>
      <button class="tipo-tab" onclick="setTipo('multidestino')">‚äï Multidestino</button>
    </div>
    <div id="form-simple">
      <div class="search-row">
        <div class="field f-sm"><label>Origen</label><input type="text" id="origen" placeholder="BUE" value="BUE" maxlength="3" oninput="this.value=this.value.toUpperCase()"></div>
        <div class="field f-sm"><label>Destino</label><input type="text" id="destino" placeholder="MIA" maxlength="3" oninput="this.value=this.value.toUpperCase()"></div>
        <div class="field f-md"><label>Ida</label><input type="date" id="salida"></div>
        <div class="field f-md" id="field-regreso"><label>Vuelta</label><input type="date" id="regreso"></div>
      </div>
    </div>
    <div id="form-multi" style="display:none">
      <div id="tramos-container"></div>
      <button class="btn-add-tramo" onclick="addTramo()">+ Agregar tramo</button>
    </div>
    <div class="pax-stops-row">
      <div class="field f-xs"><label>Adultos</label><select id="adultos"><option>1</option><option selected>2</option><option>3</option><option>4</option><option>5</option><option>6</option></select></div>
      <div class="field f-xs"><label>Ni√±os</label><select id="ninos"><option selected>0</option><option>1</option><option>2</option><option>3</option></select></div>
      <div class="field f-xs"><label>Infantes</label><select id="infantes"><option selected>0</option><option>1</option><option>2</option></select></div>
      <div class="field f-lg"><label>Escalas</label>
        <select id="stops">
          <option value="">Todas</option>
          <option value="0">Solo directo</option>
          <option value="1">Hasta 1 escala</option>
          <option value="2">Hasta 2 escalas</option>
        </select>
      </div>
      <div class="field"><label>Moneda</label>
        <div class="moneda-toggle">
          <button class="moneda-btn active" id="btn-usd" onclick="setMoneda('USD')">USD</button>
          <button class="moneda-btn" id="btn-ars" onclick="setMoneda('ARS')">ARS</button>
        </div>
      </div>
      <button class="btn-buscar" id="btnBuscar" onclick="buscar()">‚ö° Buscar</button>
    </div>
    <!-- B√∫squeda avanzada -->
    <div style="margin-top:12px;border-top:1px solid var(--border);padding-top:10px;">
      <button onclick="document.getElementById('advSearch').style.display=document.getElementById('advSearch').style.display==='none'?'flex':'none';this.querySelector('.adv-arrow').textContent=document.getElementById('advSearch').style.display==='none'?'‚ñ∏':'‚ñæ'" style="background:none;border:none;color:var(--gold);font-family:'Sora',sans-serif;font-size:12px;font-weight:600;cursor:pointer;padding:0;display:flex;align-items:center;gap:4px;"><span class="adv-arrow">‚ñ∏</span> B√∫squeda avanzada</button>
      <div id="advSearch" style="display:none;gap:10px;flex-wrap:wrap;margin-top:10px;align-items:flex-end;">
        <div class="field" style="min-width:160px;">
          <label>Aerol√≠neas</label>
          <input type="text" id="advAirlines" placeholder="AR,AA,LA,DL..." maxlength="50" style="text-transform:uppercase" oninput="this.value=this.value.toUpperCase()">
        </div>
        <div class="field" style="min-width:140px;">
          <label>Cabina</label>
          <select id="advCabin">
            <option value="">Todas</option>
            <option value="0">Economy (EC)</option>
            <option value="2">Business (BU)</option>
            <option value="1">First (FI)</option>
            <option value="3">Premium Economy (PE)</option>
          </select>
        </div>
        <div class="field" style="min-width:140px;">
          <label>Tipo de vuelo</label>
          <select id="advFlightType">
            <option value="">Todos</option>
            <option value="1">Non Stop</option>
            <option value="2">Directo</option>
          </select>
        </div>
      </div>
    </div>
  </div>
  <div id="mainContent">
    <div class="estado"><div style="font-size:48px">‚úàÔ∏è</div><h3>Busc√° tu vuelo</h3><p>Eleg√≠ el tipo de viaje, complet√° los datos y busc√°</p></div>
  </div>
</div>

<script>
const hoy=new Date();
const d1=new Date(hoy);d1.setMonth(d1.getMonth()+1);
const d2=new Date(d1);d2.setDate(d2.getDate()+7);
document.getElementById('salida').value=d1.toISOString().split('T')[0];
document.getElementById('regreso').value=d2.toISOString().split('T')[0];

let tipoActual='roundtrip';
let monedaActual='USD';
let tcUsdArs=1200;
let todosLosVuelos=[];
let filtros={escalas:-1,maxPrecioUSD:null,aerolineas:[],ordenar:'precio'};

// Cargar tipo de cambio al iniciar
fetch('/tipo-cambio').then(r=>r.json()).then(d=>{
  tcUsdArs=d.bsp||1425;
  console.log('TC USD/ARS:',tcUsdArs);
}).catch(()=>{});

function setMoneda(m){
  monedaActual=m;
  document.getElementById('btn-usd').classList.toggle('active',m==='USD');
  document.getElementById('btn-ars').classList.toggle('active',m==='ARS');
  if(todosLosVuelos.length>0) aplicarFiltrosYRender();
}

function precioMostrar(precioUSD){
  if(monedaActual==='ARS') return Math.round(precioUSD * tcUsdArs);
  return precioUSD;
}
function fmtPrecio(n){
  if(monedaActual==='ARS') return Math.round(n).toLocaleString('es-AR');
  return n.toLocaleString('es-AR',{minimumFractionDigits:2,maximumFractionDigits:2});
}
function simboloMoneda(){ return monedaActual; }

function setTipo(tipo){
  tipoActual=tipo;
  document.querySelectorAll('.tipo-tab').forEach((t,i)=>{t.classList.toggle('active',['roundtrip','oneway','multidestino'][i]===tipo);});
  document.getElementById('form-simple').style.display=tipo==='multidestino'?'none':'block';
  document.getElementById('form-multi').style.display=tipo==='multidestino'?'block':'none';
  document.getElementById('field-regreso').style.display=tipo==='oneway'?'none':'flex';
  if(tipo==='multidestino'&&document.getElementById('tramos-container').children.length===0){addTramo();addTramo();}
}

let tramoCount=0;
function addTramo(){
  tramoCount++;
  const n=tramoCount;
  const prev=document.getElementById('tramos-container').lastElementChild;
  const prevDest=prev?prev.querySelector('.t-dest')?.value:'';
  const prevDate=prev?prev.querySelector('.t-fecha')?.value:'';
  let nextDate='';
  if(prevDate){const d=new Date(prevDate);d.setDate(d.getDate()+3);nextDate=d.toISOString().split('T')[0];}
  const div=document.createElement('div');
  div.className='tramo-row-multi';div.id=`tramo-${n}`;
  div.innerHTML=`<span class="tramo-num">Tramo ${n}</span>
    <div class="field f-sm"><label>Origen</label><input type="text" class="t-orig" placeholder="BUE" value="${prevDest}" maxlength="3" oninput="this.value=this.value.toUpperCase()"></div>
    <div class="field f-sm"><label>Destino</label><input type="text" class="t-dest" placeholder="MIA" maxlength="3" oninput="this.value=this.value.toUpperCase()"></div>
    <div class="field f-md"><label>Fecha</label><input type="date" class="t-fecha" value="${nextDate}"></div>
    ${n>2?`<button class="btn-rm-tramo" onclick="removeTramo(${n})">‚úï</button>`:''}`;
  document.getElementById('tramos-container').appendChild(div);
}
function removeTramo(n){const el=document.getElementById(`tramo-${n}`);if(el)el.remove();}

function fmt(iso){if(!iso)return'‚Äì';return new Date(iso).toLocaleTimeString('es-AR',{hour:'2-digit',minute:'2-digit',hour12:false});}
function fmtFecha(iso){if(!iso)return'';return new Date(iso).toLocaleDateString('es-AR',{day:'2-digit',month:'short'});}
function fmtExpira(iso){
  if(!iso)return'';
  const diff=Math.floor((new Date(iso)-Date.now())/60000);
  if(diff<0)return'Expirado';
  if(diff<60)return`‚è± ${diff}m`;
  return`‚è± ${Math.floor(diff/60)}h ${diff%60}m`;
}
function escClass(n){return n===0?'directo':n===1?'una':'dos';}
function escLabel(n){return n===0?'Directo':n===1?'1 escala':`${n} escalas`;}

function renderEquipaje(eq){
  const items=[
    {icon:'üéí', label:'Mochila', valor:eq.handOn.label, ok:eq.handOn.incluido},
    {icon:'üß≥', label:'Carry on', valor:eq.carryOn.label, ok:eq.carryOn.incluido},
    {icon:'üì¶', label:'Despachado', valor:eq.checked.label, ok:eq.checked.incluido},
  ];
  return `<div class="equipaje-grid">${items.map(i=>`
    <div class="eq-item ${i.ok?'incluido':'no-incluido'}">
      <span class="eq-icon">${i.icon}</span>
      <span class="eq-label">${i.label}</span>
      <span class="eq-valor">${i.valor}</span>
    </div>`).join('')}</div>`;
}

function renderTramo(leg,label){
  if(!leg)return'';
  const stops=(leg.ciudadesEscala||[]).join(' ¬∑ ');
  const overnight=leg.tripDays>0?`<span style="color:var(--orange);font-size:9px"> +${leg.tripDays}d</span>`:'';
  return`<div class="tramo">
    <div class="tramo-label">${label}</div>
    <div class="tramo-row">
      <div class="airport-block">
        <div class="airport-code">${leg.origen}</div>
        <div class="airport-time">${fmt(leg.salida)}</div>
        <div class="airport-date">${fmtFecha(leg.salida)}</div>
      </div>
      <div class="tramo-line">
        <div class="line-bar"><div class="line-dot"></div><div class="line-seg"></div><div class="line-plane">‚úà</div><div class="line-seg"></div><div class="line-dot"></div></div>
        ${stops?`<div style="font-size:9px;color:var(--orange);margin-top:1px">${stops}</div>`:''}
        <div class="tramo-dur">${leg.duracion||''}</div>
      </div>
      <div class="airport-block" style="text-align:right">
        <div class="airport-code">${leg.destino}${overnight}</div>
        <div class="airport-time">${fmt(leg.llegada)}</div>
        <div class="airport-date">${fmtFecha(leg.llegada)}</div>
      </div>
    </div>
    <div style="margin-top:5px"><span class="esc-badge ${escClass(leg.escalas)}">${escLabel(leg.escalas)}</span></div>
  </div>`;
}

function renderVuelo(v){
  const expiraStr=fmtExpira(v.expira);
  const urgente=expiraStr.includes('m')&&!expiraStr.includes('h');
  const pax=parseInt(document.getElementById('adultos').value)+parseInt(document.getElementById('ninos').value);
  const labels=['üõ´ Ida','üõ¨ Vuelta','‚úà Tramo 3','‚úà Tramo 4','‚úà Tramo 5'];
  const tramosHTML=v.itinerario.map((leg,i)=>{
    const h=renderTramo(leg,labels[i]||`‚úà Tramo ${i+1}`);
    return i>0?`<div class="tramo-divider"></div>${h}`:h;
  }).join('');
  const precio=precioMostrar(v.precioUSD);
  const precioAlt=monedaActual==='USD'
    ? `‚âà ARS ${Math.round(v.precioUSD*tcUsdArs).toLocaleString('es-AR')}`
    : `= USD ${v.precioUSD.toLocaleString('es-AR',{minimumFractionDigits:2})}`;

  return`<div class="vuelo-card">
    <div class="vuelo-main">
      <div class="aero-col">
        <div class="aero-code">${v.aerolinea}</div>
        <div class="aero-name">${v.aerolineaDesc}</div>
        <div class="aero-source">${v.source}</div>
      </div>
      <div>${tramosHTML}</div>
      <div class="precio-col">
        <div class="precio-moneda-label">${v.monedaBase || simboloMoneda()} Total</div>
        <div class="precio-amt">${fmtPrecio(precio)}</div>
        <div class="precio-alt">${precioAlt}</div>
        ${pax>1?`<div class="precio-pax">‚âà ${fmtPrecio(precio/pax)} por pax</div>`:''}
        ${renderEquipaje(v.equipaje)}
        <div class="precio-expira ${urgente?'urgente':''}">${expiraStr}</div>
      </div>
    </div>
    <div class="vuelo-actions">
      <label class="cotizar-check">
        <input type="checkbox" onchange="toggleCotizar('${v.id}','${searchIdActual}',this.checked)"> Cotizar
      </label>
      <button class="btn-detalle" onclick="verDetalle('${v.id}','${searchIdActual}',event)">üìä Ver precio</button>
      <button class="btn-reservar" onclick="abrirReserva('${v.id}','${searchIdActual}',event)">‚úà Reservar</button>
    </div>
    <div class="detalle-panel" data-detalle="${v.id}"></div>
  </div>`;
}

function aplicarFiltrosYRender(){
  let vuelos=[...todosLosVuelos];
  if(filtros.escalas>=0)vuelos=vuelos.filter(v=>v.escalas===filtros.escalas);
  if(filtros.aerolineas.length>0)vuelos=vuelos.filter(v=>filtros.aerolineas.includes(v.aerolinea));
  if(filtros.maxPrecioUSD)vuelos=vuelos.filter(v=>v.precioUSD<=filtros.maxPrecioUSD);
  if(filtros.ordenar==='precio')vuelos.sort((a,b)=>a.precioUSD-b.precioUSD);
  else if(filtros.ordenar==='duracion')vuelos.sort((a,b)=>(a.itinerario[0]?.duracionMin||999)-(b.itinerario[0]?.duracionMin||999));
  else if(filtros.ordenar==='salida')vuelos.sort((a,b)=>new Date(a.itinerario[0]?.salida)-new Date(b.itinerario[0]?.salida));

  const cuentas={0:0,1:0,2:0};
  todosLosVuelos.forEach(v=>{cuentas[Math.min(v.escalas,2)]++;});
  const aerosMap={};
  todosLosVuelos.forEach(v=>{aerosMap[v.aerolinea]=v.aerolineaDesc;});
  const precioMinUSD=Math.min(...todosLosVuelos.map(v=>v.precioUSD));
  const precioMaxUSD=Math.max(...todosLosVuelos.map(v=>v.precioUSD));
  const currentMaxUSD=filtros.maxPrecioUSD||precioMaxUSD;
  const sym=simboloMoneda();
  const conv=monedaActual==='ARS'?tcUsdArs:1;
  const tcLabel=monedaActual==='ARS'?`<span class="tc-badge">BSP: $${Math.round(tcUsdArs).toLocaleString()}</span>`:'';

  document.getElementById('mainContent').innerHTML=`
    <div class="results-layout">
      <div class="filtros-panel">
        <div class="filtros-title">Filtros</div>
        <div class="filtro-grupo">
          <div class="filtro-grupo-title">Escalas</div>
          <button class="filtro-btn ${filtros.escalas===-1?'active':''}" onclick="setFE(-1)"><div class="filtro-dot" style="background:var(--blue)"></div>Todos<span class="filtro-count">${todosLosVuelos.length}</span></button>
          <button class="filtro-btn ${filtros.escalas===0?'active':''}" onclick="setFE(0)"><div class="filtro-dot" style="background:var(--green)"></div>Directo<span class="filtro-count">${cuentas[0]}</span></button>
          <button class="filtro-btn ${filtros.escalas===1?'active':''}" onclick="setFE(1)"><div class="filtro-dot" style="background:var(--orange)"></div>1 escala<span class="filtro-count">${cuentas[1]}</span></button>
          <button class="filtro-btn ${filtros.escalas===2?'active':''}" onclick="setFE(2)"><div class="filtro-dot" style="background:var(--red)"></div>2+ escalas<span class="filtro-count">${cuentas[2]}</span></button>
        </div>
        <div class="filtro-grupo">
          <div class="filtro-grupo-title">Precio m√°ximo ${tcLabel}</div>
          <input type="range" class="range-slider" min="${precioMinUSD}" max="${precioMaxUSD}" value="${currentMaxUSD}" oninput="setFP(this.value)">
          <div class="range-labels">
            <span>${sym} ${Math.round(precioMinUSD*conv).toLocaleString()}</span>
            <span style="color:var(--gold)">${sym} ${Math.round(currentMaxUSD*conv).toLocaleString()}</span>
          </div>
        </div>
        <div class="filtro-grupo">
          <div class="filtro-grupo-title">Aerol√≠nea</div>
          ${Object.entries(aerosMap).map(([code,name])=>`<button class="filtro-btn ${filtros.aerolineas.includes(code)?'active':''}" onclick="toggleAero('${code}')"><span style="font-weight:700;color:var(--gold)">${code}</span> ${name}</button>`).join('')}
        </div>
        <button class="btn-limpiar" onclick="limpiarFiltros()">‚úï Limpiar filtros</button>
      </div>
      <div>
        <div class="results-header">
          <div class="results-count"><strong>${vuelos.length}</strong> opciones${todosLosVuelos.length>vuelos.length?` (de ${todosLosVuelos.length})`:''}</div>
          <select class="sort-select" onchange="setOrden(this.value)">
            <option value="precio" ${filtros.ordenar==='precio'?'selected':''}>Precio ‚Üë</option>
            <option value="duracion" ${filtros.ordenar==='duracion'?'selected':''}>Duraci√≥n ‚Üë</option>
            <option value="salida" ${filtros.ordenar==='salida'?'selected':''}>Hora de salida</option>
          </select>
        </div>
        ${vuelos.length===0?'<div class="no-results">üòï Sin resultados con estos filtros</div>':vuelos.map(renderVuelo).join('')}
      </div>
    </div>`;
}

function setFE(n){filtros.escalas=n;aplicarFiltrosYRender();}
function setFP(v){filtros.maxPrecioUSD=parseFloat(v);aplicarFiltrosYRender();}
function toggleAero(code){filtros.aerolineas.includes(code)?filtros.aerolineas=filtros.aerolineas.filter(a=>a!==code):filtros.aerolineas.push(code);aplicarFiltrosYRender();}
function setOrden(v){filtros.ordenar=v;aplicarFiltrosYRender();}
function limpiarFiltros(){filtros={escalas:-1,maxPrecioUSD:null,aerolineas:[],ordenar:'precio'};aplicarFiltrosYRender();}

async function buscar(){
  const adultos=document.getElementById('adultos').value;
  const ninos=document.getElementById('ninos').value;
  const infantes=document.getElementById('infantes').value;
  const stops=document.getElementById('stops').value;
  let body={tipo:tipoActual,adultos,ninos,infantes,stops:stops||undefined};
  // B√∫squeda avanzada
  const advAirlines = (document.getElementById('advAirlines').value || '').trim();
  const advCabin = document.getElementById('advCabin').value;
  const advFlightType = document.getElementById('advFlightType').value;
  if (advAirlines) body.airlines = advAirlines.split(',').map(a => a.trim()).filter(Boolean);
  if (advCabin) body.cabinType = parseInt(advCabin);
  if (advFlightType) body.flightType = parseInt(advFlightType);
  if(tipoActual==='multidestino'){
    const tramosEls=document.getElementById('tramos-container').querySelectorAll('.tramo-row-multi');
    const tramos=[];
    for(const el of tramosEls){
      const o=el.querySelector('.t-orig').value.trim().toUpperCase();
      const d=el.querySelector('.t-dest').value.trim().toUpperCase();
      const f=el.querySelector('.t-fecha').value;
      if(!o||!d||!f){alert('Complet√° todos los tramos');return;}
      tramos.push({origen:o,destino:d,salida:f});
    }
    if(tramos.length<2){alert('Agreg√° al menos 2 tramos');return;}
    body.tramos=tramos;
  } else {
    const origen=document.getElementById('origen').value.trim().toUpperCase();
    const destino=document.getElementById('destino').value.trim().toUpperCase();
    const salida=document.getElementById('salida').value;
    const regreso=document.getElementById('regreso').value;
    if(!origen||!destino||!salida||(tipoActual==='roundtrip'&&!regreso)){alert('Complet√° todos los campos');return;}
    body={...body,origen,destino,salida,regreso};
  }
  document.getElementById('mainContent').innerHTML=`<div class="estado"><div class="spinner"></div><h3>Buscando vuelos...</h3><p>Puede tardar hasta 30 segundos</p></div>`;
  const btn=document.getElementById('btnBuscar');btn.disabled=true;btn.textContent='‚è≥ Buscando...';
  try{
    const res=await fetch('/buscar-vuelos',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    const data=await res.json();
    if(data.searchId) searchIdActual=data.searchId;
    if(!data.ok){document.getElementById('mainContent').innerHTML=`<div class="estado"><div style="font-size:40px">‚ö†Ô∏è</div><h3>Error</h3><p>${data.error}</p></div>`;return;}
    todosLosVuelos=data.vuelos||[];
    if(todosLosVuelos.length) document.getElementById('markupBar').style.display='flex';
    filtros={escalas:-1,maxPrecioUSD:null,aerolineas:[],ordenar:'precio'};
    if(!todosLosVuelos.length){document.getElementById('mainContent').innerHTML=`<div class="estado"><div style="font-size:40px">üîç</div><h3>Sin resultados</h3><p>Prob√° otras fechas o destinos</p></div>`;return;}
    aplicarFiltrosYRender();
  }catch(err){
    document.getElementById('mainContent').innerHTML=`<div class="estado"><div style="font-size:40px">‚ö†Ô∏è</div><h3>Error de conexi√≥n</h3><p>${err.message}</p></div>`;
  }finally{btn.disabled=false;btn.textContent='‚ö° Buscar';}
}
document.addEventListener('keydown',e=>{if(e.key==='Enter')buscar();});
</script>

<!-- MARKUP BAR (se muestra en b√∫squeda) -->
<div id="markupBar" class="markup-bar" style="max-width:1100px;margin:0 auto 0;display:none;">
  <label>üí∞ Tu markup:</label>
  <select id="markupTipo" onchange="guardarMarkup()">
    <option value="porcentaje">%</option>
    <option value="fijo">USD fijo</option>
  </select>
  <input type="number" id="markupValor" value="0" min="0" step="0.5" oninput="guardarMarkup()" style="width:80px;">
  <span id="markupInfo" style="font-size:12px;color:var(--muted);"></span>
</div>

<!-- VISTA RESERVAS (completa) -->
<div id="vistaReservas" style="display:none;max-width:1100px;margin:0 auto;padding:20px 0;">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:10px;">
    <h2 style="font-size:20px;font-weight:700;">üìã Mis Reservas</h2>
    <button onclick="cargarReservas()" style="background:none;border:1px solid var(--border);color:var(--muted);border-radius:6px;padding:6px 14px;font-size:12px;cursor:pointer;font-family:'Sora',sans-serif;">üîÑ Actualizar</button>
  </div>
  <!-- Stats -->
  <div id="reservasStats" style="display:flex;gap:12px;margin-bottom:16px;flex-wrap:wrap;"></div>
  <!-- Filtros -->
  <div style="display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap;">
    <input type="text" id="searchInput" placeholder="üîç Buscar PNR, pasajero, ruta..." style="flex:1;min-width:200px;padding:8px 12px;background:var(--dark2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:'Sora',sans-serif;font-size:13px;outline:none;">
    <select id="filterEstado" style="padding:8px 12px;background:var(--dark2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:'Sora',sans-serif;font-size:13px;outline:none;">
      <option value="TODAS">Todas</option>
      <option value="CREADA">Creadas</option>
      <option value="EMITIDA">Emitidas</option>
      <option value="CANCELADA">Canceladas</option>
    </select>
  </div>
  <!-- Tabla -->
  <div id="reservasTabla" style="overflow-x:auto;"></div>
</div>

<!-- MODAL DETALLE RESERVA -->
<div id="modalOverlay" class="modal-overlay" style="display:none" onclick="if(event.target===this)cerrarModalRes()">
  <div class="modal" style="max-width:700px;">
    <div style="padding:16px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;">
      <h2 id="modalTitle" style="font-size:16px;font-weight:700;">Detalle de Reserva</h2>
      <button class="modal-close" onclick="cerrarModalRes()">‚úï</button>
    </div>
    <div id="modalBody" style="padding:20px;max-height:70vh;overflow-y:auto;"></div>
    <div id="modalActions" style="display:flex;gap:8px;padding:12px 20px;border-top:1px solid var(--border);flex-wrap:wrap;"></div>
  </div>
</div>

<!-- MODAL DE RESERVA (crear reserva desde b√∫squeda) -->
<div id="modalReserva" class="modal-overlay" style="display:none">
  <div class="modal">
    <button class="modal-close" onclick="cerrarModal()">‚úï</button>
    <div id="modalContenido"></div>
  </div>
</div>

<script>

// ‚îÄ‚îÄ‚îÄ ESTADO RESERVA ‚îÄ‚îÄ‚îÄ
let searchIdActual = '';
let vueloSeleccionado = null;
let paisesData = [];
let paxActivo = 0;
let pasajerosForms = [];

// searchId se captura en la respuesta de /buscar-vuelos
const _buscarBtn = document.getElementById('btnBuscar');

let paisesFactData = [];
async function cargarPaises() {
  if (paisesData.length) return paisesData;
  const [r1, r2] = await Promise.all([
    fetch('/document-countries?documentFor=Passengers').then(r=>r.json()),
    fetch('/document-countries?documentFor=AccountingHolders').then(r=>r.json())
  ]);
  paisesData = r1.data || [];
  paisesFactData = r2.data || [];
  return paisesData;
}

function getPaisOpts(selectedId) {
  return paisesData.map(p => `<option value="${p.Id}" ${p.id===selectedId?'selected':''}>${p.name}</option>`).join('');
}
function getDocTipoOpts(paisId, selectedId) {
  const pais = paisesData.find(p=>p.id===paisId);
  const tipos = pais?.documentTypes || [];
  return tipos.map(t => `<option value="${t.id}" data-code="${t.code}" ${t.id===selectedId?'selected':''}>${t.name}</option>`).join('');
}
function getFactTipoOpts(paisId, selectedId) {
  const pais = paisesFactData.find(p=>p.id===paisId) || paisesData.find(p=>p.id===paisId);
  const tipos = pais?.documentTypes || [];
  return tipos.map(t => `<option value="${t.id}" data-code="${t.code}" ${t.id===selectedId?'selected':''}>${t.name}</option>`).join('');
}

// Pa√≠s por defecto Argentina
function getPaisDefaultId() {
  const arg = paisesData.find(p=>p.Name==='Argentina');
  return arg?.Id || '';
}

async function abrirReserva(quotationId, searchId, e) {
  e.stopPropagation();
  if (!searchId) { alert('Hac√© una nueva b√∫squeda para reservar'); return; }
  
  // Encontrar el vuelo
  vueloSeleccionado = todosLosVuelos.find(v=>v.id==quotationId);
  if (!vueloSeleccionado) return;

  document.getElementById('modalReserva').style.display = 'flex';
  document.getElementById('modalContenido').innerHTML = '<div class="estado"><div class="spinner"></div><h3>Verificando disponibilidad...</h3></div>';

  try {
    // Check availability
    const chk = await fetch('/check-availability', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ searchId, quotationId: String(quotationId) })
    }).then(r=>r.json());

    if (!chk.ok) throw new Error(chk.error);

    // Cargar pa√≠ses
    await cargarPaises();

    // Inicializar forms de pasajeros
    const adultos = parseInt(document.getElementById('adultos').value);
    const ninos = parseInt(document.getElementById('ninos').value);
    const infantes = parseInt(document.getElementById('infantes').value);
    pasajerosForms = [];
    for(let i=0;i<adultos;i++) pasajerosForms.push({tipo:'ADT', idx:i});
    for(let i=0;i<ninos;i++) pasajerosForms.push({tipo:'CHD', idx:i});
    for(let i=0;i<infantes;i++) pasajerosForms.push({tipo:'INF', idx:i});
    paxActivo = 0;

    renderModalReserva(searchId, quotationId, chk.hasDifferences);
  } catch(err) {
    document.getElementById('modalContenido').innerHTML = `<div class="estado"><div style="font-size:40px">‚ö†Ô∏è</div><h3>Error</h3><p>${err.message}</p></div>`;
  }
}

function renderModalReserva(searchId, quotationId, hasDiff) {
  const v = vueloSeleccionado;
  const pax = pasajerosForms[paxActivo];
  const tipoLabel = pax.tipo==='ADT'?'Adulto':pax.tipo==='CHD'?'Ni√±o':'Infante';
  const paxNum = pax.idx+1;
  const paisDefId = getPaisDefaultId();

  const tabs = pasajerosForms.map((p,i) => {
    const lbl = p.tipo==='ADT'?`Adulto ${p.idx+1}`:p.tipo==='CHD'?`Ni√±o ${p.idx+1}`:`Infante ${p.idx+1}`;
    return `<button class="pax-tab ${i===paxActivo?'active':''}" onclick="cambiarPax(${i})">${lbl}</button>`;
  }).join('');

  document.getElementById('modalContenido').innerHTML = `
    <div class="modal-title">‚úà Confirmar Reserva</div>
    <div class="modal-sub">${v.aerolinea} ¬∑ ${v.itinerario.map(l=>l.origen+' ‚Üí '+l.destino).join(' | ')} ¬∑ USD ${v.precioUSD?.toFixed(2)}</div>
    ${hasDiff?'<div class="alert-diff">‚ö†Ô∏è El precio del vuelo cambi√≥. Verific√° antes de confirmar.</div>':''}

    <div class="modal-section">
      <div class="modal-section-title">Pasajeros</div>
      <div class="pax-tab-header">${tabs}</div>
      <div id="paxForm"></div>
    </div>

    <div class="modal-section">
      <div class="modal-section-title">Datos de contacto</div>
      <div class="form-row">
        <div class="form-field"><label>Apellido*</label><input id="c_apellido" placeholder="Apellido"></div>
        <div class="form-field"><label>Nombre*</label><input id="c_nombre" placeholder="Nombre"></div>
      </div>
      <div class="form-row">
        <div class="form-field"><label>Email*</label><input id="c_email" type="email" placeholder="email@ejemplo.com"></div>
        <div class="form-field"><label>Tel√©fono 1*</label><input id="c_tel1" placeholder="+54 11 1234-5678"></div>
        <div class="form-field"><label>Tel√©fono 2</label><input id="c_tel2" placeholder="Opcional"></div>
      </div>
    </div>

    <button class="btn-modal-submit" id="btnConfirmar" onclick="confirmarReserva('${searchId}','${quotationId}')">Confirmar Reserva</button>
  `;

  renderPaxForm(paxActivo);
}

function renderPaxForm(idx) {
  const pax = pasajerosForms[idx];
  const saved = pax.data || {};
  const argId = paisesData.find(p=>p.name==='Argentina')?.id || paisesData[0]?.id || '';
  const docPaisId = saved.docPaisId || argId;
  const factPaisId = saved.factPaisId || argId;
  const paisDefId = argId;

  document.getElementById('paxForm').innerHTML = `
    <div class="cliente-search" style="margin-bottom:14px">
      <div class="form-field">
        <label>Buscar cliente existente</label>
        <input id="buscarCliente_${idx}" placeholder="Apellido, nombre o documento..." oninput="buscarCliente(${idx}, this.value)" autocomplete="off">
      </div>
      <div class="cliente-dropdown" id="dropdown_${idx}"></div>
    </div>
    <div class="form-row">
      <div class="form-field" style="flex:2"><label>Apellido*</label><input id="p_apellido_${idx}" placeholder="APELLIDO" value="${saved.apellido||''}" oninput="guardarPaxField(${idx},'apellido',this.value)"></div>
      <div class="form-field" style="flex:2"><label>Nombre*</label><input id="p_nombre_${idx}" placeholder="NOMBRE" value="${saved.nombre||''}" oninput="guardarPaxField(${idx},'nombre',this.value)"></div>
      <div class="form-field" style="flex:1"><label>G√©nero*</label>
        <select id="p_genero_${idx}" onchange="guardarPaxField(${idx},'genero',this.value)">
          <option value="">-</option>
          <option value="0" ${saved.genero=='0'?'selected':''}>Masculino</option>
          <option value="1" ${saved.genero=='1'?'selected':''}>Femenino</option>
        </select>
      </div>
    </div>
    <div class="form-row">
      <div class="form-field"><label>Email</label><input id="p_email_${idx}" type="email" value="${saved.email||''}" placeholder="email@ejemplo.com" oninput="guardarPaxField(${idx},'email',this.value)"></div>
      <div class="form-field"><label>Fecha nac. (D/M/A)*</label>
        <div style="display:flex;gap:4px">
          <input id="p_nacDia_${idx}" type="number" placeholder="DD" min="1" max="31" style="width:52px" value="${saved.fechaNacDia||''}" oninput="guardarPaxField(${idx},'fechaNacDia',this.value)">
          <input id="p_nacMes_${idx}" type="number" placeholder="MM" min="1" max="12" style="width:52px" value="${saved.fechaNacMes||''}" oninput="guardarPaxField(${idx},'fechaNacMes',this.value)">
          <input id="p_nacAnio_${idx}" type="number" placeholder="AAAA" min="1900" max="2026" style="width:72px" value="${saved.fechaNacAnio||''}" oninput="guardarPaxField(${idx},'fechaNacAnio',this.value)">
        </div>
      </div>
    </div>
    <div style="font-size:10px;color:var(--gold);text-transform:uppercase;letter-spacing:1px;font-weight:700;margin:10px 0 8px">Documento de viaje</div>
    <div class="form-row">
      <div class="form-field"><label>Pa√≠s doc.*</label>
        <select id="p_docPais_${idx}" onchange="onDocPaisChange(${idx})">
          <option value="">Seleccionar</option>
          ${getPaisOpts(docPaisId)}
        </select>
      </div>
      <div class="form-field"><label>Tipo doc.*</label>
        <select id="p_docTipo_${idx}" onchange="guardarPaxField(${idx},'docTipoId',this.value);guardarPaxField(${idx},'docTipo',this.options[this.selectedIndex]?.dataset.code)">
          <option value="">-</option>
          ${getDocTipoOpts(docPaisId, saved.docTipoId||'')}
        </select>
      </div>
      <div class="form-field"><label>Nro. documento*</label><input id="p_docNum_${idx}" value="${saved.docNumero||''}" placeholder="12345678" oninput="guardarPaxField(${idx},'docNumero',this.value)"></div>
    </div>
    <div class="form-row">
      <div class="form-field"><label>Nacionalidad*</label>
        <select id="p_nac_${idx}" onchange="guardarPaxField(${idx},'nacionalidadId',this.value)">
          <option value="">Seleccionar</option>
          ${getPaisOpts(saved.nacionalidadId||docPaisId)}
        </select>
      </div>
      <div class="form-field"><label>Venc. doc. (D/M/A)*</label>
        <div style="display:flex;gap:4px">
          <input id="p_vencDia_${idx}" type="number" placeholder="DD" min="1" max="31" style="width:52px" value="${saved.docVencDia||''}" oninput="guardarPaxField(${idx},'docVencDia',this.value)">
          <input id="p_vencMes_${idx}" type="number" placeholder="MM" min="1" max="12" style="width:52px" value="${saved.docVencMes||''}" oninput="guardarPaxField(${idx},'docVencMes',this.value)">
          <input id="p_vencAnio_${idx}" type="number" placeholder="AAAA" min="2026" max="2055" style="width:72px" value="${saved.docVencAnio||''}" oninput="guardarPaxField(${idx},'docVencAnio',this.value)">
        </div>
      </div>
    </div>
    <div style="font-size:10px;color:var(--gold);text-transform:uppercase;letter-spacing:1px;font-weight:700;margin:10px 0 8px">Documento de facturaci√≥n</div>
    <div class="form-row">
      <div class="form-field"><label>Pa√≠s fact.*</label>
        <select id="p_factPais_${idx}" onchange="onFactPaisChange(${idx})">
          <option value="">Seleccionar</option>
          ${getPaisOpts(factPaisId)}
        </select>
      </div>
      <div class="form-field"><label>Tipo fact.*</label>
        <select id="p_factTipo_${idx}" onchange="guardarPaxField(${idx},'factTipoId',this.value);guardarPaxField(${idx},'factTipo',this.options[this.selectedIndex]?.dataset.code)">
          <option value="">-</option>
          ${getFactTipoOpts(factPaisId, saved.factTipoId||'')}
        </select>
      </div>
      <div class="form-field"><label>Nro. fact.*</label><input id="p_factNum_${idx}" value="${saved.factNumero||''}" placeholder="20123456789" oninput="guardarPaxField(${idx},'factNumero',this.value)"></div>
    </div>
  `;

  // Guardar valores iniciales - siempre asegurar que existan
  guardarPaxField(idx,'docPaisId', docPaisId || argId);
  guardarPaxField(idx,'docPais', paisesData.find(p=>p.id===(docPaisId||argId))?.name || 'Argentina');
  guardarPaxField(idx,'factPaisId', factPaisId || argId);
  guardarPaxField(idx,'factPais', paisesData.find(p=>p.id===(factPaisId||argId))?.name || 'Argentina');
  // Guardar nacionalidad default si no tiene
  const nacId = saved.nacionalidadId || docPaisId || argId;
  if (nacId) guardarPaxField(idx,'nacionalidadId', nacId);
  // Guardar docTipo y factTipo defaults si ya est√°n seteados
  setTimeout(() => {
    const dtEl = document.getElementById(`p_docTipo_${idx}`);
    if (dtEl && dtEl.value && !saved.docTipoId) { guardarPaxField(idx,'docTipoId',dtEl.value); guardarPaxField(idx,'docTipo',dtEl.options[dtEl.selectedIndex]?.dataset?.code||''); }
    const ftEl = document.getElementById(`p_factTipo_${idx}`);
    if (ftEl && ftEl.value && !saved.factTipoId) { guardarPaxField(idx,'factTipoId',ftEl.value); guardarPaxField(idx,'factTipo',ftEl.options[ftEl.selectedIndex]?.dataset?.code||''); }
  }, 50);
}

function guardarPaxField(idx, campo, valor) {
  if (!pasajerosForms[idx].data) pasajerosForms[idx].data = {};
  // Never store "undefined" string
  if (valor === 'undefined' || valor === undefined) valor = null;
  pasajerosForms[idx].data[campo] = valor;
}

function onDocPaisChange(idx) {
  const sel = document.getElementById(`p_docPais_${idx}`);
  const paisId = sel.value;
  const paisNombre = sel.options[sel.selectedIndex]?.text || '';
  console.log('[DocPais] idx:', idx, 'paisId:', paisId, 'paisesData len:', paisesData.length);
  const tiposHtml = getDocTipoOpts(paisId,'');
  console.log('[DocTipos] html len:', tiposHtml.length, tiposHtml.substring(0,100));
  guardarPaxField(idx,'docPaisId',paisId);
  guardarPaxField(idx,'docPais',paisNombre);
  document.getElementById(`p_docTipo_${idx}`).innerHTML = '<option value="">-</option>' + tiposHtml;
  document.getElementById(`p_nac_${idx}`).innerHTML = '<option value="">Seleccionar</option>' + getPaisOpts(paisId);
  guardarPaxField(idx,'nacionalidadId',paisId);
}

function onFactPaisChange(idx) {
  const sel = document.getElementById(`p_factPais_${idx}`);
  const paisId = sel.value;
  const paisNombre = sel.options[sel.selectedIndex]?.text || '';
  guardarPaxField(idx,'factPaisId',paisId);
  guardarPaxField(idx,'factPais',paisNombre);
  document.getElementById(`p_factTipo_${idx}`).innerHTML = '<option value="">-</option>' + getFactTipoOpts(paisId,'');
  guardarPaxField(idx,'factTipoId','');
}

function cambiarPax(idx) {
  // Guardar datos actuales del form antes de cambiar
  const i = paxActivo;
  const campos = ['apellido','nombre','genero','email','nacDia','nacMes','nacAnio','docNum','vencDia','vencMes','vencAnio','factNum'];
  const mapeo = {apellido:'apellido',nombre:'nombre',genero:'genero',email:'email',nacDia:'fechaNacDia',nacMes:'fechaNacMes',nacAnio:'fechaNacAnio',docNum:'docNumero',vencDia:'docVencDia',vencMes:'docVencMes',vencAnio:'docVencAnio',factNum:'factNumero'};
  for(const c of campos) {
    const el = document.getElementById(`p_${c}_${i}`);
    if(el) guardarPaxField(i, mapeo[c], el.value);
  }
  // Guardar selects del tab actual
  const argId = paisesData.find(p=>p.name==='Argentina')?.id || '';
  ['docPais','docTipo','nac','factPais','factTipo'].forEach(campo => {
    const el = document.getElementById(`p_${campo}_${i}`);
    if(!el) return;
    const val = el.value;
    if(campo==='docPais') { guardarPaxField(i,'docPaisId', val||argId); }
    else if(campo==='docTipo') { guardarPaxField(i,'docTipoId',val); guardarPaxField(i,'docTipo',el.options[el.selectedIndex]?.dataset?.code||''); }
    else if(campo==='nac') { guardarPaxField(i,'nacionalidadId', val||argId); }
    else if(campo==='factPais') { guardarPaxField(i,'factPaisId', val||argId); }
    else if(campo==='factTipo') { guardarPaxField(i,'factTipoId',val); guardarPaxField(i,'factTipo',el.options[el.selectedIndex]?.dataset?.code||''); }
  });
  paxActivo = idx;
  document.querySelectorAll('.pax-tab').forEach((t,ti)=>t.classList.toggle('active',ti===idx));
  renderPaxForm(idx);
}

async function buscarCliente(idx, q) {
  const dd = document.getElementById(`dropdown_${idx}`);
  if (q.length < 2) { dd.classList.remove('show'); return; }
  const clientes = await fetch(`/clientes/buscar?q=${encodeURIComponent(q)}`).then(r=>r.json());
  if (!clientes.length) { dd.classList.remove('show'); return; }
  dd.innerHTML = clientes.map(c => `
    <div class="cliente-item" onclick="precargarCliente(${idx}, ${c.id})">
      <strong>${c.apellido}, ${c.nombre}</strong>
      <span>${c.doc_tipo} ${c.doc_numero}</span>
      <span>${c.email||''}</span>
    </div>
  `).join('');
  dd.classList.add('show');
}

async function precargarCliente(idx, clienteId) {
  document.getElementById(`dropdown_${idx}`).classList.remove('show');
  const clientes = await fetch('/clientes').then(r=>r.json());
  const c = clientes.find(x=>x.id===clienteId);
  if (!c) return;
  
  // Guardar todos los datos
  if (!pasajerosForms[idx].data) pasajerosForms[idx].data = {};
  Object.assign(pasajerosForms[idx].data, {
    apellido: c.apellido, nombre: c.nombre, email: c.email||'',
    genero: String(c.genero||'0'),
    fechaNacDia: c.fecha_nac_dia, fechaNacMes: c.fecha_nac_mes, fechaNacAnio: c.fecha_nac_anio,
    docPais: c.doc_pais, docPaisId: c.doc_pais_id,
    docTipo: c.doc_tipo, docTipoId: c.doc_tipo_id, docNumero: c.doc_numero,
    docVencDia: c.doc_venc_dia, docVencMes: c.doc_venc_mes, docVencAnio: c.doc_venc_anio,
    nacionalidad: c.nacionalidad, nacionalidadId: c.nacionalidad_id,
    factPais: c.fact_pais, factPaisId: c.fact_pais_id,
    factTipo: c.fact_tipo, factTipoId: c.fact_tipo_id, factNumero: c.fact_numero
  });
  renderPaxForm(idx);
  document.getElementById(`buscarCliente_${idx}`).value = `${c.apellido}, ${c.nombre}`;
}

async function confirmarReserva(searchId, quotationId) {
  // Guardar todos los campos del formulario activo antes de enviar
  const i = paxActivo;
  const mapeo = {apellido:'apellido',nombre:'nombre',genero:'genero',email:'email',
    nacDia:'fechaNacDia',nacMes:'fechaNacMes',nacAnio:'fechaNacAnio',
    docNum:'docNumero',vencDia:'docVencDia',vencMes:'docVencMes',vencAnio:'docVencAnio',
    factNum:'factNumero'};
  for(const [campo, key] of Object.entries(mapeo)) {
    const el = document.getElementById(`p_${campo}_${i}`);
    if(el) guardarPaxField(i, key, el.value);
  }
  // Guardar selects
  const argId = paisesData.find(p=>p.name==='Argentina')?.id || '';
  function safeVal(v) { return (v && v!=='undefined') ? v : null; }
  ['docPais','docTipo','nac','factPais','factTipo'].forEach(campo => {
    const el = document.getElementById(`p_${campo}_${i}`);
    if(!el) return;
    const val = safeVal(el.value);
    const txt = el.options[el.selectedIndex]?.text||'';
    if(campo==='docPais') { guardarPaxField(i,'docPaisId', val||argId); guardarPaxField(i,'docPais',txt); }
    else if(campo==='docTipo') { guardarPaxField(i,'docTipoId',val); guardarPaxField(i,'docTipo',el.options[el.selectedIndex]?.dataset?.code||''); }
    else if(campo==='nac') { guardarPaxField(i,'nacionalidadId', val||argId); }
    else if(campo==='factPais') { guardarPaxField(i,'factPaisId', val||argId); guardarPaxField(i,'factPais',txt); }
    else if(campo==='factTipo') { guardarPaxField(i,'factTipoId',val); guardarPaxField(i,'factTipo',el.options[el.selectedIndex]?.dataset?.code||''); }
  });

  // Validar
  for(const pax of pasajerosForms) {
    const d = pax.data || {};
    const tipoLabel = pax.tipo==='ADT'?'Adulto':pax.tipo==='CHD'?'Ni√±o':'Infante';
    const num = pax.idx+1;
    if(!d.apellido||!d.nombre) {
      alert(`Complet√° apellido y nombre del ${tipoLabel} ${num}`);
      return;
    }
    if(!d.docNumero) {
      alert(`Complet√° el documento del ${tipoLabel} ${num}`);
      return;
    }
    if(!d.fechaNacDia||!d.fechaNacMes||!d.fechaNacAnio) {
      alert(`Complet√° la fecha de nacimiento del ${tipoLabel} ${num}`);
      return;
    }
    if(!d.genero && d.genero!=='0') {
      alert(`Seleccion√° el g√©nero del ${tipoLabel} ${num}`);
      return;
    }
  }
  const cApellido = document.getElementById('c_apellido').value;
  const cNombre = document.getElementById('c_nombre').value;
  const cEmail = document.getElementById('c_email').value;
  const cTel1 = document.getElementById('c_tel1').value;
  if(!cApellido||!cNombre||!cEmail||!cTel1) { alert('Complet√° los datos de contacto'); return; }

  const btn = document.getElementById('btnConfirmar');
  btn.disabled = true; btn.textContent = '‚è≥ Procesando...';

  const pasajeros = pasajerosForms.map(p => {
    const d = { tipo: p.tipo, ...p.data };
    // Sanitizar IDs que puedan ser undefined
    const fallbackArgId = argId || '3144952d-b7f4-4ddf-9ed8-8021bfc67c4b';
    if (!d.docPaisId || d.docPaisId === 'undefined') d.docPaisId = fallbackArgId;
    if (!d.factPaisId || d.factPaisId === 'undefined') d.factPaisId = fallbackArgId;
    if (!d.nacionalidadId || d.nacionalidadId === 'undefined') d.nacionalidadId = fallbackArgId;
    return d;
  });
  const contacto = { apellido: cApellido, nombre: cNombre, email: cEmail, telefono1: cTel1, telefono2: document.getElementById('c_tel2').value };
  const v = vueloSeleccionado;
  const vueloInfo = {
    tipo: 'vuelo', origen: v.itinerario[0]?.origen, destino: v.itinerario[v.itinerario.length-1]?.destino,
    salida: v.itinerario[0]?.salida, aerolinea: v.aerolinea,
    precioUSD: v.precioUSD, moneda: 'USD', itinerario: v.itinerario
  };

  try {
    const res = await fetch('/crear-reserva', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ searchId, quotationId: String(quotationId), pasajeros, contacto, vueloInfo })
    }).then(r=>r.json());

    if (!res.ok) throw new Error(res.error);

    document.getElementById('modalContenido').innerHTML = `
      <div class="reserva-ok">
        <div style="font-size:48px">‚úÖ</div>
        <div style="font-size:13px;color:var(--muted);margin-top:12px">Reserva confirmada</div>
        <div class="reserva-pnr">${res.pnr}</div>
        <div class="reserva-detail">Nro. de orden: ${res.orderNumber}</div>
        <div class="reserva-detail" style="margin-top:16px">${v.aerolinea} ¬∑ ${v.itinerario.map(l=>l.origen+' ‚Üí '+l.destino).join(' | ')}</div>
        <div class="reserva-detail">USD ${v.precioUSD?.toFixed(2)}</div>
        <button class="btn-modal-submit" style="margin-top:20px;max-width:200px;margin-left:auto;margin-right:auto" onclick="cerrarModal()">Cerrar</button>
      </div>
    `;
  } catch(err) {
    btn.disabled = false; btn.textContent = 'Confirmar Reserva';
    alert('Error: ' + err.message);
  }
}

function cerrarModal() {
  document.getElementById('modalReserva').style.display = 'none';
  vueloSeleccionado = null;
  pasajerosForms = [];
}

// Cerrar al hacer click fuera
document.getElementById('modalReserva').addEventListener('click', function(e) {
  if(e.target === this) cerrarModal();
});


// ‚îÄ‚îÄ‚îÄ MARKUP ‚îÄ‚îÄ‚îÄ
let markupConfig = { tipo: 'porcentaje', valor: 0 };

async function cargarMarkup() {
  try {
    const r = await fetch('/config-markup').then(r=>r.json());
    markupConfig = r.markup;
    document.getElementById('markupTipo').value = markupConfig.tipo;
    document.getElementById('markupValor').value = markupConfig.valor;
    actualizarInfoMarkup();
  } catch(e) {}
}

function calcularPrecioVenta(precioBase) {
  if (markupConfig.tipo === 'porcentaje') return precioBase * (1 + markupConfig.valor / 100);
  return precioBase + markupConfig.valor;
}

function actualizarInfoMarkup() {
  const el = document.getElementById('markupInfo');
  if (!el) return;
  el.textContent = markupConfig.valor > 0
    ? (markupConfig.tipo === 'porcentaje' ? `+${markupConfig.valor}% sobre Tucano` : `+USD ${markupConfig.valor} fijo`)
    : 'Sin markup aplicado';
}

async function guardarMarkup() {
  markupConfig = { tipo: document.getElementById('markupTipo').value, valor: parseFloat(document.getElementById('markupValor').value) || 0 };
  actualizarInfoMarkup();
  await fetch('/config-markup', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ markup: markupConfig }) });
  if (todosLosVuelos.length) aplicarFiltrosYRender();
}

// ‚îÄ‚îÄ‚îÄ DETALLE DE PRECIO ‚îÄ‚îÄ‚îÄ
let detalleCache = {};
let detalleAbiertoId = null;

function mostrarVista(vista, btn) {
  document.querySelectorAll('.nav-tab').forEach(function(t) { t.classList.remove('active'); });
  btn.classList.add('active');
  var searchCard = document.querySelector('.search-card');
  var resultados = document.getElementById('resultados');
  var vistaReservas = document.getElementById('vistaReservas');
  var markupBar = document.getElementById('markupBar');
  var cotizarBar = document.getElementById('cotizarBar');
  if (vista === 'buscar') {
    if (searchCard) searchCard.style.display = '';
    if (resultados) resultados.style.display = '';
    vistaReservas.style.display = 'none';
    if (markupBar) markupBar.style.display = '';
    if (cotizarBar) cotizarBar.style.display = '';
  } else {
    if (searchCard) searchCard.style.display = 'none';
    if (resultados) resultados.style.display = 'none';
    vistaReservas.style.display = 'block';
    if (markupBar) markupBar.style.display = 'none';
    if (cotizarBar) cotizarBar.style.display = 'none';
    cargarReservas();
  }
}

async function verDetalle(quotationId, searchId, e) {
  e.stopPropagation();
  if (detalleAbiertoId === quotationId) {
    const p = document.querySelector('.detalle-panel[data-detalle="' + quotationId + '"]');
    if (p) { p.classList.remove('show'); p.innerHTML = ''; }
    detalleAbiertoId = null;
    return;
  }
  document.querySelectorAll('.detalle-panel.show').forEach(function(p) { p.classList.remove('show'); p.innerHTML = ''; });
  const panel = document.querySelector('.detalle-panel[data-detalle="' + quotationId + '"]');
  if (!panel) { console.error('No panel para', quotationId); return; }
  panel.innerHTML = '<div style="text-align:center;padding:10px;color:var(--muted);font-size:12px">‚è≥ Cargando desglose...</div>';
  panel.classList.add('show');
  detalleAbiertoId = quotationId;
  if (!searchId || searchId === 'undefined') {
    panel.innerHTML = '<div style="color:var(--red);font-size:12px;padding:8px">Hac√© una nueva b√∫squeda para ver el desglose.</div>';
    return;
  }
  try {
    var d = detalleCache[quotationId];
    if (!d) {
      var r = await fetch('/detalle-vuelo?searchId=' + searchId + '&quotationId=' + quotationId);
      d = await r.json();
      if (d.ok) detalleCache[quotationId] = d;
    }
    if (!d.ok) throw new Error(d.error);
    var bsp = tcUsdArs || 1425;
    var precioVenta = d.total;
    var desgloseHTML = d.desglose.map(function(p) {
      return '<div style="margin-bottom:8px;padding:8px;background:rgba(255,255,255,0.02);border-radius:6px;">' +
        '<div style="font-size:10px;color:var(--gold);font-weight:700;margin-bottom:5px">' + p.tipo + ' x ' + p.cantidad + '</div>' +
        '<div class="detalle-row"><span class="detalle-label">Tarifa base</span><span class="detalle-valor">' + d.moneda + ' ' + p.tarifa.toFixed(2) + '</span></div>' +
        '<div class="detalle-row"><span class="detalle-label">Impuestos</span><span class="detalle-valor">' + d.moneda + ' ' + p.impuestos.toFixed(2) + '</span></div>' +
        '<div class="detalle-row"><span class="detalle-label">Fee Tucano</span><span class="detalle-valor">' + d.moneda + ' ' + p.fee.toFixed(2) + '</span></div>' +
        (p.descuento > 0 ? '<div class="detalle-row" style="color:#28a745"><span class="detalle-label">Descuento (com/over)</span><span>-' + d.moneda + ' ' + p.descuento.toFixed(2) + '</span></div>' : '') +
        '<div class="detalle-row total"><span>Total Tucano</span><span>' + d.moneda + ' ' + p.total.toFixed(2) + '</span></div>' +
        '</div>';
    }).join('');
    // ‚îÄ‚îÄ‚îÄ CONDICIONES (tabla estilo SCIWeb) ‚îÄ‚îÄ‚îÄ
    var pen = d.penalidades || {};
    function renderCondRow(label, data) {
      if (!data) return '<tr><td class="cond-label">' + label + '</td><td class="cond-monto">‚Äî</td><td><span class="cond-badge no-permite">Sin info</span></td></tr>';
      var permite = data.permite !== false;
      var badge = permite ? '<span class="cond-badge permite">Permite</span>' : '<span class="cond-badge no-permite">No permite</span>';
      var monto = permite ? (data.moneda + ' ' + (data.monto || 0).toLocaleString('es-AR', {minimumFractionDigits:2})) : '';
      return '<tr><td class="cond-label">' + label + '</td><td class="cond-monto">' + monto + '</td><td>' + badge + '</td></tr>';
    }
    var condHTML = '<table class="cond-table">' +
      renderCondRow('Cambio (Antes del viaje)', pen.cambio_antes || pen.cambio) +
      renderCondRow('Cambio (Durante el viaje)', pen.cambio_durante) +
      renderCondRow('Devoluci√≥n (Antes del viaje)', pen.devolucion_antes || pen.cancelacion) +
      renderCondRow('Devoluci√≥n (Durante el viaje)', pen.devolucion_durante) +
      '</table>';
    panel.innerHTML =
      '<div class="detalle-grid">' +
        '<div>' +
          '<div class="detalle-section-title">üìä Desglose de precio</div>' +
          desgloseHTML +
          '<div class="detalle-venta">' +
            '<div class="detalle-venta-label">Precio Tucano (neto)</div>' +
            '<div class="detalle-venta-precio">USD ' + precioVenta.toFixed(2) + '</div>' +
            '<div style="font-size:11px;color:var(--muted);margin-top:2px">‚âà ARS ' + Math.round(precioVenta * bsp).toLocaleString('es-AR') + '</div>' +
          '</div>' +
        '</div>' +
        '<div>' +
          '<div class="detalle-section-title">üìã Condiciones</div>' +
          condHTML +
        '</div>' +
      '</div>';
  } catch(err) {
    panel.innerHTML = '<div style="color:var(--red);font-size:12px;padding:8px">Error: ' + err.message + '</div>';
  }
}

let reservasData = [];
let reservaActual = null;

async function cargarReservas() {
  const cont = document.getElementById('reservasTabla');
  cont.innerHTML = '<div class="estado"><div class="spinner"></div><p>Cargando reservas...</p></div>';
  const estado = document.getElementById('filterEstado')?.value || 'TODAS';
  const q = document.getElementById('searchInput')?.value?.trim() || '';
  const params = new URLSearchParams();
  if (estado !== 'TODAS') params.set('estado', estado);
  if (q) params.set('q', q);
  try {
    reservasData = await fetch('/reservas?' + params).then(r=>r.json());
    renderReservasStats();
    renderReservasTabla();
  } catch(e) { cont.innerHTML = '<div class="no-results">Error: ' + e.message + '</div>'; }
}

function renderReservasStats() {
  const counts = { CREADA:0, EMITIDA:0, CANCELADA:0 };
  reservasData.forEach(r => { if (counts[r.estado] !== undefined) counts[r.estado]++; });
  document.getElementById('reservasStats').innerHTML =
    '<div class="res-stat creada"><div class="num">' + counts.CREADA + '</div><div class="lbl">Creadas</div></div>' +
    '<div class="res-stat emitida"><div class="num">' + counts.EMITIDA + '</div><div class="lbl">Emitidas</div></div>' +
    '<div class="res-stat cancelada"><div class="num">' + counts.CANCELADA + '</div><div class="lbl">Canceladas</div></div>';
}

function renderReservasTabla() {
  const cont = document.getElementById('reservasTabla');
  if (!reservasData.length) { cont.innerHTML = '<div class="no-results">üì≠ No hay reservas</div>'; return; }
  const rows = reservasData.map(r => {
    const paxDetail = [];
    if (r.adultos) paxDetail.push(r.adultos + ' ADT');
    if (r.ninos) paxDetail.push(r.ninos + ' CHD');
    if (r.infantes) paxDetail.push(r.infantes + ' INF');
    const fecha = r.fecha_salida ? new Date(r.fecha_salida).toLocaleDateString('es-AR', { day:'2-digit', month:'short' }) : '-';
    const creado = r.created_at ? new Date(r.created_at).toLocaleDateString('es-AR', { day:'2-digit', month:'short', hour:'2-digit', minute:'2-digit' }) : '';
    return '<tr onclick="verDetalleReserva(' + r.id + ')">' +
      '<td><span class="res-pnr">' + (r.pnr||'-') + '</span><br><span class="res-fecha">' + creado + '</span></td>' +
      '<td><span class="res-ruta">' + (r.origen||'?') + ' ‚Üí ' + (r.destino||'?') + '</span></td>' +
      '<td style="color:var(--muted)">' + (r.aerolinea||'-') + '</td>' +
      '<td class="res-fecha">' + fecha + '</td>' +
      '<td>' + (paxDetail.join(', ')||'-') + '</td>' +
      '<td class="res-precio">USD ' + (r.precio_usd||0).toLocaleString('es-AR',{minimumFractionDigits:0}) + '</td>' +
      '<td><span class="badge-res badge-' + r.estado + '">' + r.estado + '</span></td>' +
    '</tr>';
  }).join('');
  cont.innerHTML = '<table class="res-table"><thead><tr><th>PNR</th><th>Ruta</th><th>Aerol√≠nea</th><th>Fecha</th><th>Pax</th><th>Precio</th><th>Estado</th></tr></thead><tbody>' + rows + '</tbody></table>';
}

async function verDetalleReserva(id) {
  document.getElementById('modalOverlay').style.display = 'flex';
  document.getElementById('modalBody').innerHTML = '<div style="text-align:center;padding:20px;color:var(--muted)"><div class="spinner"></div><p>Cargando...</p></div>';
  document.getElementById('modalActions').innerHTML = '';
  try {
    const res = await fetch('/reservas/' + id);
    const data = await res.json();
    if (!data.ok) throw new Error(data.error);
    reservaActual = data.reserva;
    const r = data.reserva;
    document.getElementById('modalTitle').textContent = 'Reserva ' + (r.pnr || '#' + r.id);

    // Itinerario
    let itinHtml = '';
    try {
      const itin = typeof r.itinerario_json === 'string' ? JSON.parse(r.itinerario_json) : r.itinerario_json;
      if (Array.isArray(itin)) {
        itinHtml = itin.map(s => {
          const salida = s.salida || s.departureDateTime || '';
          const llegada = s.llegada || s.arrivalDateTime || '';
          const fecha = s.fecha || (salida.includes('T') ? new Date(salida).toLocaleDateString('es-AR',{day:'2-digit',month:'short'}) : '');
          const hSal = salida.includes('T') ? new Date(salida).toLocaleTimeString('es-AR',{hour:'2-digit',minute:'2-digit'}) : salida;
          const hLleg = llegada.includes('T') ? new Date(llegada).toLocaleTimeString('es-AR',{hour:'2-digit',minute:'2-digit'}) : llegada;
          return '<div class="itin-seg"><div class="idate">' + fecha + '</div><div class="iroute"><div class="cities">' + (s.origen||s.departureAirport||'') + ' ‚Üí ' + (s.destino||s.arrivalAirport||'') + '</div><div class="fnum">' + (s.numero_vuelo||s.flightNumber||'') + '</div></div><div class="itimes">' + hSal + ' ‚Üí ' + hLleg + '</div></div>';
        }).join('');
      }
    } catch(e) {}

    // Pasajeros
    let paxHtml = '';
    const paxList = r.pasajeros_detalle || [];
    if (paxList.length) {
      paxHtml = paxList.map(p => '<div class="pax-row-det"><div><span class="pname">' + (p.apellido||'') + ', ' + (p.nombre||'') + '</span> <span class="ptype">(' + (p.tipo==='ADT'?'Adulto':p.tipo==='CHD'?'Menor':'Beb√©') + ')</span></div><span class="pdoc">' + (p.doc_tipo||'') + ' ' + (p.doc_numero||'') + '</span></div>').join('');
    } else {
      try {
        const pj = typeof r.pasajeros_json === 'string' ? JSON.parse(r.pasajeros_json) : r.pasajeros_json;
        if (Array.isArray(pj)) paxHtml = pj.map(p => '<div class="pax-row-det"><div><span class="pname">' + (p.apellido||'') + ', ' + (p.nombre||'') + '</span> <span class="ptype">(' + (p.tipo==='ADT'?'Adulto':p.tipo==='CHD'?'Menor':'Beb√©') + ')</span></div><span class="pdoc">' + (p.docTipo||'') + ' ' + (p.docNumero||'') + '</span></div>').join('');
      } catch(e) {}
    }

    // Contacto
    let contactoHtml = '';
    try { const c = typeof r.contacto_json === 'string' ? JSON.parse(r.contacto_json) : r.contacto_json; if (c) contactoHtml = (c.nombre||'') + ' ' + (c.apellido||'') + ' ¬∑ ' + (c.email||'') + ' ¬∑ ' + (c.telefono1||''); } catch(e) {}

    const creado = r.created_at ? new Date(r.created_at).toLocaleString('es-AR') : '-';

    // Tickets
    let ticketsHtml = '';
    if (r.estado === 'EMITIDA' || r.emision_data) {
      let ed = null;
      try { ed = typeof r.emision_data === 'string' ? JSON.parse(r.emision_data) : r.emision_data; } catch(e) {}
      if (ed && ed.tickets && ed.tickets.length) {
        ticketsHtml = '<div class="det-section"><h3>üé´ Tickets</h3>' + ed.tickets.map(t => '<span style="display:inline-block;background:rgba(46,204,113,0.15);padding:5px 12px;border-radius:6px;margin:3px;font-family:monospace;font-size:12px;border:1px solid rgba(46,204,113,0.3);color:#2ecc71;">üé´ ' + (t.carrier||'') + '-' + (t.numero||t.number||'') + '</span>').join('') + (ed.emitidoEn ? '<p style="font-size:10px;color:var(--muted);margin-top:6px;">Emitido: ' + new Date(ed.emitidoEn).toLocaleString('es-AR') + '</p>' : '') + '</div>';
      } else if (r.estado === 'EMITIDA') {
        ticketsHtml = '<div class="det-section"><h3>üé´ Tickets</h3><p style="color:var(--muted);font-size:11px;">Sin datos. Hac√© click en "Verificar estado" para sincronizar.</p></div>';
      }
    }

    document.getElementById('modalBody').innerHTML =
      '<div class="det-section"><h3>Informaci√≥n general</h3><div class="det-grid">' +
      '<div class="det-item"><div class="lbl">PNR</div><div class="val" style="color:var(--gold)">' + (r.pnr||'-') + '</div></div>' +
      '<div class="det-item"><div class="lbl">Order</div><div class="val">' + (r.order_id ? '<a href="https://sciweb.tucanotours.com.ar/FlightOrders/Details/' + r.order_id + '" target="_blank" style="color:#42a5f5;text-decoration:none;">' + (r.order_number||r.order_id.substring(0,8)) + ' üîó</a>' : (r.order_number||'-')) + '</div></div>' +
      '<div class="det-item"><div class="lbl">Estado</div><div class="val"><span class="badge-res badge-' + r.estado + '">' + r.estado + '</span></div></div>' +
      '<div class="det-item"><div class="lbl">Aerol√≠nea</div><div class="val">' + (r.aerolinea||'-') + '</div></div>' +
      '<div class="det-item"><div class="lbl">Precio neto</div><div class="val">USD ' + (r.precio_usd||0).toLocaleString('es-AR') + '</div></div>' +
      '<div class="det-item"><div class="lbl">Creada</div><div class="val">' + creado + '</div></div>' +
      '</div></div>' +
      (itinHtml ? '<div class="det-section"><h3>‚úà Itinerario</h3>' + itinHtml + '</div>' : '') +
      (paxHtml ? '<div class="det-section"><h3>üë• Pasajeros</h3>' + paxHtml + '</div>' : '') +
      (contactoHtml ? '<div class="det-section"><h3>üìû Contacto</h3><p style="color:var(--muted);font-size:13px;">' + contactoHtml + '</p></div>' : '') +
      ticketsHtml +
      '<div class="det-section"><h3>üìù Notas</h3><textarea class="notas-dark" id="notasArea" placeholder="Agregar notas...">' + (r.notas||'') + '</textarea></div>';

    // Actions
    let act = '<button class="btn-act btn-act-primary" onclick="verificarEstadoRes()">üîç Verificar estado</button>';
    act += '<button class="btn-act btn-act-outline" onclick="guardarNotasRes()">üíæ Notas</button>';
    act += '<button class="btn-act btn-act-outline" onclick="mostrarPdfOptsRes()">üìÑ PDF</button>';
    if (r.estado === 'CREADA') {
      act += '<button class="btn-act btn-act-success" onclick="mostrarRecotizarRes()">üí≤ Recotizar</button>';
      act += '<button class="btn-act btn-act-blue" onclick="confirmarEmisionRes()">‚úàÔ∏è Emitir</button>';
      act += '<button class="btn-act btn-act-success" onclick="cambiarEstadoRes(\'EMITIDA\')">‚úÖ Emitida</button>';
      act += '<button class="btn-act btn-act-danger" onclick="cambiarEstadoRes(\'CANCELADA\')">‚ùå Cancelar</button>';
    } else if (r.estado === 'EMITIDA') {
      act += '<button class="btn-act btn-act-danger" onclick="cambiarEstadoRes(\'CANCELADA\')">‚ùå Cancelar</button>';
    }
    document.getElementById('modalActions').innerHTML = act;
  } catch(e) {
    document.getElementById('modalBody').innerHTML = '<div class="no-results">Error: ' + e.message + '</div>';
  }
}

function cerrarModalRes() { document.getElementById('modalOverlay').style.display = 'none'; reservaActual = null; }

function mostrarPdfOptsRes() {
  if (document.getElementById('pdfPanel')) { document.getElementById('pdfPanel').remove(); return; }
  const panel = document.createElement('div'); panel.id = 'pdfPanel'; panel.className = 'recot-panel';
  panel.innerHTML = '<h4>üìÑ Generar PDF</h4><div class="recot-opts"><div><label>Vendedor</label><select id="pdfVendedor"><option value="guido">Guido Finkelstein</option><option value="julieta">Julieta Zubeldia</option><option value="ruthy">Ruthy Tuchsznajder</option></select></div><div><label>&nbsp;</label><button class="btn-act btn-act-primary" onclick="generarPdfRes()" id="btnPdfRes" style="width:100%">üìÑ Descargar</button></div></div>';
  document.getElementById('modalBody').appendChild(panel);
}

async function generarPdfRes() {
  if (!reservaActual) return;
  const btn = document.getElementById('btnPdfRes'); btn.textContent = '‚è≥...'; btn.disabled = true;
  try {
    const res = await fetch('/reservas/' + reservaActual.id + '/pdf', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({vendedor:document.getElementById('pdfVendedor').value}) });
    if (!res.ok) throw new Error((await res.json()).error);
    const blob = await res.blob(); const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'Reserva_' + reservaActual.pnr + '.pdf'; a.click(); URL.revokeObjectURL(url);
  } catch(e) { alert('Error: ' + e.message); } finally { btn.textContent = 'üìÑ Descargar'; btn.disabled = false; }
}

function mostrarRecotizarRes() {
  if (document.getElementById('recotPanel')) { document.getElementById('recotPanel').remove(); return; }
  const panel = document.createElement('div'); panel.id = 'recotPanel'; panel.className = 'recot-panel';
  panel.innerHTML = '<h4>üí≤ Recotizar reserva</h4><div class="recot-opts"><div><label>Moneda</label><select id="recotMoneda"><option value="">Auto</option><option value="USD">USD</option><option value="ARS">ARS</option></select></div><div><label>Tipo tarifa</label><select id="recotFareType"><option value="0">No forzar</option><option value="1">P√∫blicas</option><option value="2">Privadas</option></select></div><div><label>Validadora</label><input type="text" id="recotCarrier" placeholder="Ej: UX, AR..." maxlength="3"></div><div><label>Nacionalidad</label><input type="text" id="recotNationality" placeholder="Ej: ARG" maxlength="3"></div></div><button class="btn-act btn-act-primary" onclick="ejecutarRecotizarRes()" id="btnRecot">üìä Obtener tarifa actual</button><div id="recotResult"></div>';
  document.getElementById('modalBody').appendChild(panel);
}

async function ejecutarRecotizarRes() {
  if (!reservaActual) return;
  const btn = document.getElementById('btnRecot'); const rd = document.getElementById('recotResult');
  btn.textContent = '‚è≥ Consultando...'; btn.disabled = true; rd.innerHTML = '';
  try {
    const opts = { moneda:document.getElementById('recotMoneda').value||null, fareType:parseInt(document.getElementById('recotFareType').value)||0, overrideCarrier:document.getElementById('recotCarrier').value||null, nationality:document.getElementById('recotNationality').value||null };
    const res = await fetch('/reservas/' + reservaActual.id + '/recotizar', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(opts) });
    const data = await res.json(); if (!data.ok) throw new Error(data.error);
    if (data.tarifas && data.tarifas.length) {
      let html = ''; let grandTotal = 0; let grandNeto = 0;
      data.tarifas.forEach(t => {
        grandTotal += t.total;
        const comMonto = (t.comisionObtenida?.valueApplied||0) + (t.comisionCedida?.valueApplied||0);
        const overMonto = t.overComision?.ceded?.valueApplied || t.overComision?.obtained?.valueApplied || t.overComision?.valueApplied || t.overComision?.amount || 0;
        const neto = t.total + (t.fee||0) - comMonto - overMonto; grandNeto += neto;
        html += '<div class="tarifa-card-d"><div class="th">' + t.tipo + ' √ó 1</div>' +
          '<div class="tr"><span>Tarifa base</span><span>' + t.monedaBase + ' ' + t.tarifaBase.toFixed(2) + '</span></div>' +
          '<div class="tr"><span>Impuestos</span><span>' + t.monedaImpuestos + ' ' + t.impuestos.toFixed(2) + '</span></div>' +
          (t.fee ? '<div class="tr"><span>Fee</span><span>' + t.monedaFee + ' ' + t.fee.toFixed(2) + '</span></div>' : '') +
          (comMonto ? '<div class="tr" style="color:#2ecc71"><span>Comisi√≥n</span><span>-' + t.monedaTotal + ' ' + comMonto.toFixed(2) + '</span></div>' : '') +
          (overMonto ? '<div class="tr" style="color:#2ecc71"><span>Over</span><span>-' + t.monedaTotal + ' ' + overMonto.toFixed(2) + '</span></div>' : '') +
          '<div class="tr total"><span>NETO</span><span>' + t.monedaTotal + ' ' + neto.toFixed(2) + '</span></div></div>';
      });
      const mon = data.tarifas[0]?.monedaTotal || 'USD';
      html += '<div class="tarifa-card-d" style="border-color:var(--gold)"><div class="tr total"><span>TOTAL NETO</span><span style="color:var(--gold)">' + mon + ' ' + grandNeto.toFixed(2) + '</span></div></div>';
      if (data.pricingId) {
        window._lastPricing = { pricingId:data.pricingId, segmentIds:data.segmentIds, netoTotal:grandNeto, moneda:mon };
        html += '<button class="btn-act btn-act-success" onclick="guardarTarifaRes()" style="margin-top:8px">üíæ Guardar tarifa</button>';
      }
      rd.innerHTML = html;
    } else { rd.innerHTML = '<p style="color:var(--muted);font-size:12px">Sin tarifas disponibles</p>'; }
  } catch(e) { rd.innerHTML = '<p style="color:#e74c3c;font-size:12px">' + e.message + '</p>'; } finally { btn.textContent = 'üìä Obtener tarifa actual'; btn.disabled = false; }
}

async function guardarTarifaRes() {
  if (!reservaActual || !window._lastPricing) return;
  if (!confirm('¬øGuardar esta tarifa?')) return;
  try {
    const res = await fetch('/reservas/' + reservaActual.id + '/guardar-tarifa', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(window._lastPricing) });
    const data = await res.json(); if (!data.ok) throw new Error(data.error);
    alert('‚úÖ ' + data.mensaje); cerrarModalRes(); cargarReservas();
  } catch(e) { alert('Error: ' + e.message); }
}

async function verificarEstadoRes() {
  if (!reservaActual) return;
  try {
    const res = await fetch('/reservas/' + reservaActual.id + '/verificar', { method:'POST', headers:{'Content-Type':'application/json'} });
    const data = await res.json(); if (!data.ok) throw new Error(data.error);
    let msg = 'PNR: ' + data.pnr + '\n';
    if (data.estadoActualizado) msg += '\n‚ö° ESTADO: ' + data.estadoAnterior + ' ‚Üí ' + data.estadoAPI + '\n';
    else msg += '\n‚úÖ Estado: ' + data.estadoAPI + ' (sin cambios)\n';
    if (data.timeLimit) { const tl = new Date(data.timeLimit); msg += '\n‚è∞ L√≠mite: ' + tl.toLocaleDateString('es-AR') + ' ' + tl.toLocaleTimeString('es-AR',{hour:'2-digit',minute:'2-digit'}) + '\n'; }
    if (data.tickets?.length) { msg += '\nüé´ Tickets:\n'; data.tickets.forEach(t => msg += '   ' + t + '\n'); }
    if (data.vuelos?.length) { msg += '\n‚úàÔ∏è Vuelos:\n'; data.vuelos.forEach(v => msg += '   ' + v.vuelo + ' ' + v.ruta + ' [' + v.status + ']\n'); }
    if (data.mensaje) msg += '\n‚ÑπÔ∏è ' + data.mensaje;
    alert(msg);
    if (data.estadoActualizado) { cerrarModalRes(); cargarReservas(); }
  } catch(e) { alert('Error: ' + e.message); }
}

async function cambiarEstadoRes(estado) {
  if (!reservaActual) return;
  if (!confirm('¬øMarcar como ' + estado.toLowerCase() + '?')) return;
  try {
    const res = await fetch('/reservas/' + reservaActual.id + '/estado', { method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify({estado}) });
    const data = await res.json(); if (data.ok) { cerrarModalRes(); cargarReservas(); } else alert('Error: ' + data.error);
  } catch(e) { alert('Error: ' + e.message); }
}

async function guardarNotasRes() {
  if (!reservaActual) return;
  try {
    const res = await fetch('/reservas/' + reservaActual.id + '/notas', { method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify({notas:document.getElementById('notasArea').value}) });
    if ((await res.json()).ok) alert('‚úÖ Notas guardadas');
  } catch(e) { alert('Error: ' + e.message); }
}

async function confirmarEmisionRes() {
  if (!reservaActual || reservaActual.estado !== 'CREADA') return;
  try {
    const resp = await fetch('/reservas/' + reservaActual.id + '/emitir', { method:'POST', headers:{'Content-Type':'application/json'} });
    const data = await resp.json(); if (!data.ok) { alert('Error: ' + data.error); return; }
    if (data.sciweb_url && confirm('Emitir reserva ' + data.pnr + '\n\nSe abrir√° SCIWeb. Despu√©s volv√© y hac√© "Verificar estado".\n\n¬øAbrir?')) {
      window.open(data.sciweb_url, '_blank');
      const reminder = document.createElement('div');
      reminder.style.cssText = 'margin-top:14px;padding:14px;background:rgba(21,101,192,0.15);border:1px solid rgba(21,101,192,0.3);border-radius:10px;text-align:center;';
      reminder.innerHTML = '<p style="font-size:13px;color:#42a5f5;">‚úàÔ∏è SCIWeb abierto ‚Äî despu√©s de emitir:</p><button class="btn-act btn-act-primary" onclick="verificarEstadoRes()" style="margin-top:6px">üîÑ Verificar estado</button>';
      document.getElementById('modalBody').appendChild(reminder);
    }
  } catch(e) { alert('Error: ' + e.message); }
}

// Filtros con debounce
let searchTimerRes;
document.getElementById('searchInput')?.addEventListener('input', () => { clearTimeout(searchTimerRes); searchTimerRes = setTimeout(cargarReservas, 400); });
document.getElementById('filterEstado')?.addEventListener('change', cargarReservas);

// Cerrar modal con Escape
document.addEventListener('keydown', e => { if (e.key === 'Escape') { cerrarModalRes(); cerrarModal(); } });

// ‚îÄ‚îÄ‚îÄ COTIZACI√ìN ‚îÄ‚îÄ‚îÄ
let vuelosCotizar = []; // [{quotationId, searchId}]
const equipajeMap = {}; // quotationId ‚Üí equipaje data

function toggleCotizar(quotationId, searchId, checked) {
  if (checked) {
    if (!vuelosCotizar.find(v => v.quotationId === quotationId)) {
      // Buscar equipaje del vuelo en todosLosVuelos
      const vuelo = todosLosVuelos.find(v => v.id === quotationId);
      if (vuelo?.equipaje) equipajeMap[quotationId] = vuelo.equipaje;
      vuelosCotizar.push({ quotationId, searchId });
    }
  } else {
    vuelosCotizar = vuelosCotizar.filter(v => v.quotationId !== quotationId);
  }
  actualizarBarraCotizar();
}

function actualizarBarraCotizar() {
  const bar = document.getElementById('cotizarBar');
  const cnt = document.getElementById('cotizarCount');
  if (vuelosCotizar.length > 0) {
    bar.classList.add('show');
    cnt.textContent = vuelosCotizar.length === 1 ? '1 vuelo seleccionado' : vuelosCotizar.length + ' vuelos seleccionados';
  } else {
    bar.classList.remove('show');
  }
}

function limpiarCotizacion() {
  vuelosCotizar = [];
  document.querySelectorAll('.cotizar-check input[type=checkbox]').forEach(cb => cb.checked = false);
  actualizarBarraCotizar();
}

async function generarCotizacion() {
  if (!vuelosCotizar.length) return;
  const btn = document.getElementById('btnGenerarCot');
  btn.disabled = true;
  btn.textContent = '‚è≥ Generando...';
  try {
    const vendedor = document.getElementById('cotizarVendedor').value;
    const opcionesConEquipaje = vuelosCotizar.map(v => ({
      ...v,
      equipaje: equipajeMap[v.quotationId] || null
    }));
    const r = await fetch('/generar-cotizacion', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ opciones: opcionesConEquipaje, vendedor })
    });
    if (!r.ok) {
      const err = await r.json();
      throw new Error(err.error || 'Error al generar');
    }
    const blob = await r.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'cotizacion_lucky_tour.pdf';
    a.click();
    URL.revokeObjectURL(url);
    limpiarCotizacion();
  } catch(e) {
    alert('Error: ' + e.message);
  } finally {
    btn.disabled = false;
    btn.textContent = 'üìÑ Generar PDF';
  }
}

// (verDetalleReserva is defined above with full functionality)

cargarMarkup();


</script>


<div class="cotizar-bar" id="cotizarBar">
  <span class="cotizar-bar-txt" id="cotizarCount">0 vuelos seleccionados</span>
  <select id="cotizarVendedor">
    <option value="guido">Guido</option>
    <option value="julieta">Julieta</option>
    <option value="ruthy">Ruthy</option>
  </select>
  <button class="btn-cotizar-gen" id="btnGenerarCot" onclick="generarCotizacion()">üìÑ Generar PDF</button>
  <button class="btn-cotizar-cancel" onclick="limpiarCotizacion()">‚úï Cancelar</button>
</div>
<script>
// Auto-seleccionar vendedor desde sesi√≥n
const _ltVendedor = localStorage.getItem('lt_vendedor');
if (_ltVendedor) {
  const sel = document.getElementById('cotizarVendedor');
  if (sel) sel.value = _ltVendedor;
}
</script>
</body>
</html>
