<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lucky Tour ‚Äî Comparador de Vuelos</title>
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --gold:#C9A84C;--gold-light:#E8CC7A;--dark:#0D1117;--dark2:#161B22;--dark3:#21262D;
  --border:#30363D;--text:#E6EDF3;--muted:#8B949E;--green:#3FB950;--blue:#58A6FF;
  --red:#F85149;--orange:#F0883E;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Sora',sans-serif;background:var(--dark);color:var(--text);min-height:100vh;}
header{background:var(--dark2);border-bottom:1px solid var(--border);padding:14px 28px;display:flex;align-items:center;gap:12px;}
.logo-icon{width:36px;height:36px;background:var(--gold);border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:18px;}
.logo-text{font-size:17px;font-weight:700;}.logo-text span{color:var(--gold);}
.logo-sub{font-size:10px;color:var(--muted);letter-spacing:2px;text-transform:uppercase;}
.container{max-width:1200px;margin:0 auto;padding:24px 20px;}
.search-card{background:var(--dark2);border:1px solid var(--border);border-radius:14px;padding:22px 24px;margin-bottom:24px;}
.search-label{font-size:11px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:16px;}
.search-row{display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap;}
.field{display:flex;flex-direction:column;gap:5px;}
.field label{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;font-weight:600;}
.field input,.field select{background:var(--dark3);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:'Sora',sans-serif;font-size:14px;padding:9px 11px;outline:none;transition:border-color 0.2s;}
.field input:focus,.field select:focus{border-color:var(--gold);}
.field select option{background:var(--dark3);}
.f-sm{width:90px;}.f-md{width:148px;}.f-xs{width:72px;}.f-lg{width:130px;}
.btn-buscar{background:var(--gold);color:#000;border:none;border-radius:9px;font-family:'Sora',sans-serif;font-size:14px;font-weight:700;padding:10px 24px;cursor:pointer;transition:all 0.2s;white-space:nowrap;align-self:flex-end;}
.btn-buscar:hover{background:var(--gold-light);}
.btn-buscar:disabled{opacity:0.5;cursor:not-allowed;}
.results-layout{display:grid;grid-template-columns:230px 1fr;gap:20px;}
@media(max-width:768px){.results-layout{grid-template-columns:1fr;}}
.filtros-panel{background:var(--dark2);border:1px solid var(--border);border-radius:14px;padding:18px;height:fit-content;position:sticky;top:20px;}
.filtros-title{font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:16px;}
.filtro-grupo{margin-bottom:20px;}
.filtro-grupo-title{font-size:12px;font-weight:600;color:var(--text);margin-bottom:10px;}
.filtro-btn{display:flex;align-items:center;gap:8px;background:var(--dark3);border:1px solid var(--border);border-radius:7px;padding:8px 10px;cursor:pointer;margin-bottom:6px;width:100%;font-family:'Sora',sans-serif;font-size:12px;color:var(--muted);transition:all 0.15s;text-align:left;}
.filtro-btn:hover{border-color:var(--gold);color:var(--text);}
.filtro-btn.active{border-color:var(--gold);background:rgba(201,168,76,0.1);color:var(--gold);}
.filtro-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.filtro-count{margin-left:auto;font-size:10px;background:var(--dark);border-radius:10px;padding:1px 6px;}
.range-slider{width:100%;accent-color:var(--gold);cursor:pointer;}
.range-labels{display:flex;justify-content:space-between;font-size:10px;color:var(--muted);margin-top:4px;}
.btn-limpiar{background:none;border:1px solid var(--border);border-radius:7px;color:var(--muted);font-family:'Sora',sans-serif;font-size:11px;padding:6px 12px;cursor:pointer;width:100%;margin-top:4px;}
.btn-limpiar:hover{border-color:var(--red);color:var(--red);}
.results-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;}
.results-count{font-size:13px;color:var(--muted);}
.results-count strong{color:var(--gold);font-size:20px;margin-right:4px;}
.sort-select{background:var(--dark3);border:1px solid var(--border);border-radius:7px;color:var(--text);font-family:'Sora',sans-serif;font-size:12px;padding:6px 10px;outline:none;}
.vuelo-card{background:var(--dark2);border:1px solid var(--border);border-radius:12px;margin-bottom:8px;transition:border-color 0.2s;}
.vuelo-card:hover{border-color:rgba(201,168,76,0.4);}
.vuelo-main{display:grid;grid-template-columns:88px 1fr 165px;gap:16px;padding:16px 18px;align-items:center;}
.aero-col{text-align:center;}
.aero-code{font-size:20px;font-weight:700;color:var(--gold);}
.aero-name{font-size:10px;color:var(--muted);margin-top:2px;line-height:1.3;}
.aero-source{font-size:9px;color:var(--muted);margin-top:3px;background:var(--dark3);border-radius:3px;padding:1px 5px;display:inline-block;}
.tramo{padding:2px 0;}
.tramo-label{font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:5px;font-weight:600;}
.tramo-row{display:flex;align-items:center;gap:10px;}
.airport-block{min-width:44px;}
.airport-code{font-size:17px;font-weight:700;}
.airport-time{font-size:12px;color:var(--muted);margin-top:1px;}
.airport-date{font-size:9px;color:var(--muted);}
.tramo-line{flex:1;display:flex;flex-direction:column;align-items:center;gap:3px;}
.line-bar{width:100%;display:flex;align-items:center;gap:4px;}
.line-dot{width:5px;height:5px;border-radius:50%;background:var(--border);flex-shrink:0;}
.line-seg{flex:1;height:1px;background:var(--border);}
.line-plane{font-size:13px;flex-shrink:0;}
.tramo-dur{font-size:10px;color:var(--muted);}
.esc-badge{font-size:9px;font-weight:600;padding:2px 7px;border-radius:10px;text-transform:uppercase;letter-spacing:0.5px;}
.esc-badge.directo{background:rgba(63,185,80,0.15);color:var(--green);}
.esc-badge.una{background:rgba(240,136,62,0.15);color:var(--orange);}
.esc-badge.dos{background:rgba(248,81,73,0.15);color:var(--red);}
.tramo-divider{height:1px;background:var(--border);margin:8px 0;}
.precio-col{text-align:right;}
.precio-moneda{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;}
.precio-amt{font-size:22px;font-weight:700;line-height:1.1;}
.precio-pax{font-size:10px;color:var(--muted);}
.precio-expira{font-size:9px;color:var(--muted);margin-top:4px;}
.precio-expira.urgente{color:var(--orange);}
.equipaje-row{display:flex;gap:6px;margin-top:8px;flex-wrap:wrap;justify-content:flex-end;}
.eq-tag{font-size:10px;border-radius:5px;padding:3px 8px;display:flex;align-items:center;gap:4px;}
.eq-tag.incluido{background:rgba(63,185,80,0.12);border:1px solid rgba(63,185,80,0.3);color:var(--green);}
.eq-tag.no-incluido{background:var(--dark3);border:1px solid var(--border);color:var(--muted);}
.eq-tag.cargo{background:rgba(240,136,62,0.12);border:1px solid rgba(240,136,62,0.3);color:var(--orange);}
.estado{text-align:center;padding:60px 20px;color:var(--muted);}
.estado h3{font-size:17px;color:var(--text);margin:12px 0 6px;}
.spinner{width:36px;height:36px;border:3px solid var(--border);border-top-color:var(--gold);border-radius:50%;animation:spin 0.8s linear infinite;margin:0 auto;}
@keyframes spin{to{transform:rotate(360deg);}}
.no-results{text-align:center;padding:40px;background:var(--dark2);border:1px solid var(--border);border-radius:12px;color:var(--muted);}
</style>
</head>
<body>
<header>
  <div class="logo-icon">‚úà</div>
  <div>
    <div class="logo-text"><span>Lucky</span> Tour</div>
    <div class="logo-sub">Comparador de Vuelos</div>
  </div>
</header>
<div class="container">
  <div class="search-card">
    <div class="search-label">üîç B√∫squeda</div>
    <div class="search-row">
      <div class="field f-sm"><label>Origen</label><input type="text" id="origen" placeholder="BUE" value="BUE" maxlength="3" style="text-transform:uppercase"></div>
      <div class="field f-sm"><label>Destino</label><input type="text" id="destino" placeholder="MIA" maxlength="3" style="text-transform:uppercase"></div>
      <div class="field f-md"><label>Ida</label><input type="date" id="salida"></div>
      <div class="field f-md"><label>Vuelta</label><input type="date" id="regreso"></div>
      <div class="field f-xs"><label>Adultos</label><select id="adultos"><option>1</option><option selected>2</option><option>3</option><option>4</option><option>5</option><option>6</option></select></div>
      <div class="field f-xs"><label>Ni√±os</label><select id="ninos"><option selected>0</option><option>1</option><option>2</option><option>3</option></select></div>
      <div class="field f-xs"><label>Infantes</label><select id="infantes"><option selected>0</option><option>1</option><option>2</option></select></div>
      <div class="field f-lg"><label>Escalas</label>
        <select id="stops">
          <option value="">Todas</option>
          <option value="0">Solo directo</option>
          <option value="1">Hasta 1 escala</option>
          <option value="2">Hasta 2 escalas</option>
        </select>
      </div>
      <button class="btn-buscar" id="btnBuscar" onclick="buscar()">‚ö° Buscar</button>
    </div>
  </div>
  <div id="mainContent">
    <div class="estado"><div style="font-size:48px">‚úàÔ∏è</div><h3>Busc√° tu vuelo</h3><p>Ingres√° origen, destino y fechas</p></div>
  </div>
</div>
<script>
const hoy=new Date();
const d1=new Date(hoy);d1.setMonth(d1.getMonth()+1);
const d2=new Date(d1);d2.setDate(d2.getDate()+7);
document.getElementById('salida').value=d1.toISOString().split('T')[0];
document.getElementById('regreso').value=d2.toISOString().split('T')[0];

let todosLosVuelos=[];
let filtros={escalas:-1,maxPrecio:null,aerolineas:[],ordenar:'precio'};

function fmt(iso){if(!iso)return'‚Äì';return new Date(iso).toLocaleTimeString('es-AR',{hour:'2-digit',minute:'2-digit',hour12:false});}
function fmtFecha(iso){if(!iso)return'';return new Date(iso).toLocaleDateString('es-AR',{day:'2-digit',month:'short'});}
function fmtExpira(iso){
  if(!iso)return'';
  const diff=Math.floor((new Date(iso)-Date.now())/60000);
  if(diff<0)return'Expirado';
  if(diff<60)return`‚è± ${diff}m`;
  return`‚è± ${Math.floor(diff/60)}h ${diff%60}m`;
}
function escClass(n){return n===0?'directo':n===1?'una':'dos';}
function escLabel(n){return n===0?'Directo':n===1?'1 escala':`${n} escalas`;}

function renderEquipaje(v) {
  const tags = [];
  // Maleta despachada
  if (v.maleta && v.maleta !== 'Sin maleta incluida') {
    tags.push(`<div class="eq-tag incluido">üß≥ ${v.maleta}</div>`);
  } else {
    tags.push(`<div class="eq-tag no-incluido">üß≥ Sin maleta</div>`);
  }
  // Carry on
  if (v.handBag === 'Incluido') {
    tags.push(`<div class="eq-tag incluido">üëú Carry on</div>`);
  } else {
    tags.push(`<div class="eq-tag no-incluido">üëú Sin carry on</div>`);
  }
  return `<div class="equipaje-row">${tags.join('')}</div>`;
}

function renderTramo(leg,label){
  if(!leg)return'';
  const stops=(leg.ciudadesEscala||[]).map(c=>`<span style="color:var(--orange);font-size:9px">${c}</span>`).join(' ¬∑ ');
  const overnight=leg.tripDays>0?`<span style="color:var(--orange);font-size:9px"> +${leg.tripDays}d</span>`:'';
  return`<div class="tramo">
    <div class="tramo-label">${label}</div>
    <div class="tramo-row">
      <div class="airport-block">
        <div class="airport-code">${leg.origen}</div>
        <div class="airport-time">${fmt(leg.salida)}</div>
        <div class="airport-date">${fmtFecha(leg.salida)}</div>
      </div>
      <div class="tramo-line">
        <div class="line-bar"><div class="line-dot"></div><div class="line-seg"></div><div class="line-plane">‚úà</div><div class="line-seg"></div><div class="line-dot"></div></div>
        ${stops?`<div style="font-size:9px;color:var(--orange)">${stops}</div>`:''}
        <div class="tramo-dur">${leg.duracion||''}</div>
      </div>
      <div class="airport-block" style="text-align:right">
        <div class="airport-code">${leg.destino}${overnight}</div>
        <div class="airport-time">${fmt(leg.llegada)}</div>
        <div class="airport-date">${fmtFecha(leg.llegada)}</div>
      </div>
    </div>
    <div style="margin-top:5px"><span class="esc-badge ${escClass(leg.escalas)}">${escLabel(leg.escalas)}</span></div>
  </div>`;
}

function renderVuelo(v){
  const ida=v.itinerario?.[0],vuelta=v.itinerario?.[1];
  const expiraStr=fmtExpira(v.expira);
  const urgente=expiraStr.includes('m')&&!expiraStr.includes('h');
  const pax=parseInt(document.getElementById('adultos').value)+parseInt(document.getElementById('ninos').value);
  return`<div class="vuelo-card">
    <div class="vuelo-main">
      <div class="aero-col">
        <div class="aero-code">${v.aerolinea}</div>
        <div class="aero-name">${v.aerolineaDesc}</div>
        <div class="aero-source">${v.source}</div>
      </div>
      <div>
        ${renderTramo(ida,'üõ´ Ida')}
        ${vuelta?`<div class="tramo-divider"></div>${renderTramo(vuelta,'üõ¨ Vuelta')}`:''}
      </div>
      <div class="precio-col">
        <div class="precio-moneda">${v.moneda} Total</div>
        <div class="precio-amt">${v.precio?.toLocaleString('es-AR',{minimumFractionDigits:2})}</div>
        ${pax>1?`<div class="precio-pax">‚âà ${(v.precio/pax).toLocaleString('es-AR',{minimumFractionDigits:0})} por pax</div>`:''}
        ${renderEquipaje(v)}
        <div class="precio-expira ${urgente?'urgente':''}">${expiraStr}</div>
      </div>
    </div>
  </div>`;
}

function aplicarFiltrosYRender(){
  let vuelos=[...todosLosVuelos];
  if(filtros.escalas>=0)vuelos=vuelos.filter(v=>v.escalas===filtros.escalas);
  if(filtros.aerolineas.length>0)vuelos=vuelos.filter(v=>filtros.aerolineas.includes(v.aerolinea));
  if(filtros.maxPrecio)vuelos=vuelos.filter(v=>v.precio<=filtros.maxPrecio);
  if(filtros.ordenar==='precio')vuelos.sort((a,b)=>a.precio-b.precio);
  else if(filtros.ordenar==='duracion')vuelos.sort((a,b)=>(a.itinerario[0]?.duracionMin||999)-(b.itinerario[0]?.duracionMin||999));
  else if(filtros.ordenar==='salida')vuelos.sort((a,b)=>new Date(a.itinerario[0]?.salida)-new Date(b.itinerario[0]?.salida));

  const cuentas={0:0,1:0,2:0};
  todosLosVuelos.forEach(v=>{const k=Math.min(v.escalas,2);cuentas[k]++;});
  const aerosMap={};
  todosLosVuelos.forEach(v=>{aerosMap[v.aerolinea]=v.aerolineaDesc;});
  const precioMin=Math.min(...todosLosVuelos.map(v=>v.precio));
  const precioMax=Math.max(...todosLosVuelos.map(v=>v.precio));
  const currentMax=filtros.maxPrecio||precioMax;

  document.getElementById('mainContent').innerHTML=`
    <div class="results-layout">
      <div class="filtros-panel">
        <div class="filtros-title">Filtros</div>
        <div class="filtro-grupo">
          <div class="filtro-grupo-title">Escalas</div>
          <button class="filtro-btn ${filtros.escalas===-1?'active':''}" onclick="setFiltroEscalas(-1)"><div class="filtro-dot" style="background:var(--blue)"></div>Todos<span class="filtro-count">${todosLosVuelos.length}</span></button>
          <button class="filtro-btn ${filtros.escalas===0?'active':''}" onclick="setFiltroEscalas(0)"><div class="filtro-dot" style="background:var(--green)"></div>Directo<span class="filtro-count">${cuentas[0]}</span></button>
          <button class="filtro-btn ${filtros.escalas===1?'active':''}" onclick="setFiltroEscalas(1)"><div class="filtro-dot" style="background:var(--orange)"></div>1 escala<span class="filtro-count">${cuentas[1]}</span></button>
          <button class="filtro-btn ${filtros.escalas===2?'active':''}" onclick="setFiltroEscalas(2)"><div class="filtro-dot" style="background:var(--red)"></div>2+ escalas<span class="filtro-count">${cuentas[2]}</span></button>
        </div>
        <div class="filtro-grupo">
          <div class="filtro-grupo-title">Precio m√°ximo</div>
          <input type="range" class="range-slider" min="${precioMin}" max="${precioMax}" value="${currentMax}" oninput="setFiltroPrecio(this.value)">
          <div class="range-labels"><span>USD ${Math.round(precioMin).toLocaleString()}</span><span style="color:var(--gold)">USD ${Math.round(currentMax).toLocaleString()}</span></div>
        </div>
        <div class="filtro-grupo">
          <div class="filtro-grupo-title">Aerol√≠nea</div>
          ${Object.entries(aerosMap).map(([code,name])=>`<button class="filtro-btn ${filtros.aerolineas.includes(code)?'active':''}" onclick="toggleAero('${code}')"><span style="font-weight:700;color:var(--gold)">${code}</span> ${name}</button>`).join('')}
        </div>
        <button class="btn-limpiar" onclick="limpiarFiltros()">‚úï Limpiar filtros</button>
      </div>
      <div>
        <div class="results-header">
          <div class="results-count"><strong>${vuelos.length}</strong> opciones ${todosLosVuelos.length>vuelos.length?`(de ${todosLosVuelos.length})`:''}</div>
          <select class="sort-select" onchange="setOrden(this.value)">
            <option value="precio" ${filtros.ordenar==='precio'?'selected':''}>Precio ‚Üë</option>
            <option value="duracion" ${filtros.ordenar==='duracion'?'selected':''}>Duraci√≥n ‚Üë</option>
            <option value="salida" ${filtros.ordenar==='salida'?'selected':''}>Hora de salida</option>
          </select>
        </div>
        ${vuelos.length===0?'<div class="no-results">üòï Sin resultados con estos filtros</div>':vuelos.map(renderVuelo).join('')}
      </div>
    </div>`;
}

function setFiltroEscalas(n){filtros.escalas=n;aplicarFiltrosYRender();}
function setFiltroPrecio(v){filtros.maxPrecio=parseFloat(v);aplicarFiltrosYRender();}
function toggleAero(code){filtros.aerolineas.includes(code)?filtros.aerolineas=filtros.aerolineas.filter(a=>a!==code):filtros.aerolineas.push(code);aplicarFiltrosYRender();}
function setOrden(v){filtros.ordenar=v;aplicarFiltrosYRender();}
function limpiarFiltros(){filtros={escalas:-1,maxPrecio:null,aerolineas:[],ordenar:'precio'};aplicarFiltrosYRender();}

async function buscar(){
  const origen=document.getElementById('origen').value.trim().toUpperCase();
  const destino=document.getElementById('destino').value.trim().toUpperCase();
  const salida=document.getElementById('salida').value;
  const regreso=document.getElementById('regreso').value;
  const adultos=document.getElementById('adultos').value;
  const ninos=document.getElementById('ninos').value;
  const infantes=document.getElementById('infantes').value;
  const stops=document.getElementById('stops').value;
  if(!origen||!destino||!salida||!regreso){alert('Complet√° todos los campos');return;}
  document.getElementById('mainContent').innerHTML=`<div class="estado"><div class="spinner"></div><h3>Buscando vuelos...</h3><p>${origen} ‚Üí ${destino}</p></div>`;
  const btn=document.getElementById('btnBuscar');
  btn.disabled=true;btn.textContent='‚è≥ Buscando...';
  try{
    const res=await fetch('/buscar-vuelos',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({origen,destino,salida,regreso,adultos,ninos,infantes,stops:stops||undefined})});
    const data=await res.json();
    if(!data.ok){document.getElementById('mainContent').innerHTML=`<div class="estado"><div style="font-size:40px">‚ö†Ô∏è</div><h3>Error</h3><p>${data.error}</p></div>`;return;}
    todosLosVuelos=data.vuelos||[];
    filtros={escalas:-1,maxPrecio:null,aerolineas:[],ordenar:'precio'};
    if(!todosLosVuelos.length){document.getElementById('mainContent').innerHTML=`<div class="estado"><div style="font-size:40px">üîç</div><h3>Sin resultados</h3></div>`;return;}
    aplicarFiltrosYRender();
  }catch(err){
    document.getElementById('mainContent').innerHTML=`<div class="estado"><div style="font-size:40px">‚ö†Ô∏è</div><h3>Error de conexi√≥n</h3><p>${err.message}</p></div>`;
  }finally{
    btn.disabled=false;btn.textContent='‚ö° Buscar';
  }
}
document.addEventListener('keydown',e=>{if(e.key==='Enter')buscar();});
</script>
</body>
</html>
