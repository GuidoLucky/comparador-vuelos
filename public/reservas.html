<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Reservas - Lucky Tour</title>
<style>
  * { margin:0; padding:0; box-sizing:border-box; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background:#f0f2f5; color:#1a1a2e; }
  
  /* NAV */
  .nav { background:#1a1a2e; padding:12px 24px; display:flex; align-items:center; gap:20px; }
  .nav a { color:rgba(255,255,255,0.7); text-decoration:none; font-size:14px; font-weight:500; }
  .nav a:hover, .nav a.active { color:#fff; }
  .nav .brand { color:#fff; font-weight:700; font-size:18px; margin-right:auto; }
  
  /* MAIN */
  .container { max-width:1200px; margin:0 auto; padding:24px; }
  
  /* HEADER */
  .page-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:24px; flex-wrap:wrap; gap:12px; }
  .page-header h1 { font-size:24px; color:#1a1a2e; }
  
  /* FILTERS */
  .filters { display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:20px; }
  .filters input, .filters select { padding:8px 12px; border:1px solid #ddd; border-radius:8px; font-size:14px; background:#fff; }
  .filters input { width:260px; }
  .filters select { min-width:140px; }
  
  /* STATS */
  .stats { display:flex; gap:16px; margin-bottom:24px; flex-wrap:wrap; }
  .stat-card { background:#fff; border-radius:12px; padding:16px 20px; flex:1; min-width:140px; box-shadow:0 1px 3px rgba(0,0,0,0.08); }
  .stat-card .num { font-size:28px; font-weight:700; }
  .stat-card .label { font-size:12px; color:#666; margin-top:2px; text-transform:uppercase; letter-spacing:0.5px; }
  .stat-card.creada .num { color:#e67e22; }
  .stat-card.emitida .num { color:#2ecc71; }
  .stat-card.completada .num { color:#3498db; }
  .stat-card.cancelada .num { color:#e74c3c; }
  
  /* TABLE */
  .table-wrap { background:#fff; border-radius:12px; overflow:hidden; box-shadow:0 1px 3px rgba(0,0,0,0.08); }
  table { width:100%; border-collapse:collapse; }
  th { background:#f8f9fa; padding:12px 16px; text-align:left; font-size:12px; text-transform:uppercase; letter-spacing:0.5px; color:#666; border-bottom:2px solid #eee; }
  td { padding:12px 16px; border-bottom:1px solid #f0f0f0; font-size:14px; vertical-align:middle; }
  tr:hover td { background:#f8f9ff; }
  tr { cursor:pointer; }
  
  .pnr { font-family:'SF Mono',Consolas,monospace; font-weight:700; color:#1a1a2e; font-size:15px; }
  .ruta { font-weight:600; }
  .ruta small { font-weight:400; color:#666; }
  .aerolinea { color:#444; }
  .fecha { color:#666; font-size:13px; }
  .precio { font-weight:700; color:#1a1a2e; }
  
  /* BADGES */
  .badge { display:inline-block; padding:4px 10px; border-radius:20px; font-size:11px; font-weight:600; text-transform:uppercase; letter-spacing:0.3px; }
  .badge-CREADA { background:#fef3e2; color:#e67e22; }
  .badge-EMITIDA { background:#e8f8ef; color:#27ae60; }
  .badge-COMPLETADA { background:#eaf2fb; color:#2980b9; }
  .badge-CANCELADA { background:#fde8e8; color:#c0392b; }
  
  /* MODAL */
  .modal-overlay { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:100; justify-content:center; align-items:flex-start; padding:40px 20px; overflow-y:auto; }
  .modal-overlay.show { display:flex; }
  .modal { background:#fff; border-radius:16px; width:100%; max-width:700px; box-shadow:0 20px 60px rgba(0,0,0,0.3); }
  .modal-header { padding:20px 24px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; }
  .modal-header h2 { font-size:18px; }
  .modal-close { background:none; border:none; font-size:24px; cursor:pointer; color:#999; padding:4px 8px; }
  .modal-close:hover { color:#333; }
  .modal-body { padding:24px; }
  
  /* DETAIL SECTIONS */
  .detail-section { margin-bottom:20px; }
  .detail-section h3 { font-size:13px; text-transform:uppercase; letter-spacing:0.5px; color:#999; margin-bottom:8px; }
  .detail-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(180px, 1fr)); gap:12px; }
  .detail-item { }
  .detail-item .lbl { font-size:11px; color:#999; text-transform:uppercase; }
  .detail-item .val { font-size:15px; font-weight:600; margin-top:2px; }
  
  /* ITINERARY IN MODAL */
  .itin-segment { padding:10px 14px; background:#f8f9fa; border-radius:8px; margin-bottom:6px; display:flex; align-items:center; gap:12px; }
  .itin-date { font-weight:700; min-width:50px; }
  .itin-route { flex:1; }
  .itin-route .cities { font-weight:600; }
  .itin-route .flight-num { font-size:12px; color:#666; }
  .itin-times { font-size:13px; color:#555; white-space:nowrap; }
  
  /* PAX LIST */
  .pax-row { padding:10px 14px; background:#f8f9fa; border-radius:8px; margin-bottom:6px; display:flex; justify-content:space-between; align-items:center; }
  .pax-name { font-weight:600; }
  .pax-type { font-size:12px; color:#666; }
  .pax-doc { font-size:13px; color:#555; }
  
  /* ACTIONS */
  .actions-bar { display:flex; gap:8px; padding:16px 24px; border-top:1px solid #eee; flex-wrap:wrap; }
  .btn { padding:8px 16px; border:none; border-radius:8px; font-size:13px; font-weight:600; cursor:pointer; transition:all 0.2s; }
  .btn-primary { background:#1a1a2e; color:#fff; }
  .btn-primary:hover { background:#2d2d4e; }
  .btn-success { background:#27ae60; color:#fff; }
  .btn-success:hover { background:#219a52; }
  .btn-danger { background:#e74c3c; color:#fff; }
  .btn-danger:hover { background:#c0392b; }
  .btn-outline { background:#fff; color:#333; border:1px solid #ddd; }
  .btn-outline:hover { background:#f8f9fa; }
  
  /* NOTAS */
  .notas-area { width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; font-size:14px; font-family:inherit; resize:vertical; min-height:60px; }
  
  /* EMPTY */
  .empty { text-align:center; padding:60px 20px; color:#999; }
  .empty .icon { font-size:48px; margin-bottom:12px; }
  
  /* RESPONSIVE */
  @media (max-width:768px) {
    .filters { flex-direction:column; }
    .filters input, .filters select { width:100%; }
    .stats { flex-direction:column; }
    th:nth-child(4), td:nth-child(4),
    th:nth-child(6), td:nth-child(6) { display:none; }
  }
  
  .loading { text-align:center; padding:40px; color:#999; }
  
  /* RECOTIZAR PANEL */
  .recotizar-panel { background:#f0f4ff; border-radius:10px; padding:16px; margin-top:16px; }
  .recotizar-panel h4 { font-size:14px; margin-bottom:10px; color:#1a1a2e; }
  .recotizar-opts { display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:12px; }
  .recotizar-opts label { font-size:11px; color:#666; text-transform:uppercase; }
  .recotizar-opts select, .recotizar-opts input { padding:6px 10px; border:1px solid #ccc; border-radius:6px; font-size:13px; width:100%; }
  .recotizar-result { margin-top:12px; }
  .tarifa-card { background:#fff; border-radius:8px; padding:12px; margin-bottom:8px; border:1px solid #e0e0e0; }
  .tarifa-card .tarifa-header { font-weight:700; margin-bottom:6px; }
  .tarifa-card .tarifa-row { display:flex; justify-content:space-between; font-size:13px; padding:2px 0; }
  .tarifa-card .tarifa-row.total { font-weight:700; font-size:15px; border-top:1px solid #eee; padding-top:6px; margin-top:4px; }
</style>
</head>
<body>

<div class="nav">
  <span class="brand">Lucky Tour</span>
  <a href="/">Buscador</a>
  <a href="/reservas.html" class="active">Reservas</a>
</div>

<div class="container">
  <div class="page-header">
    <h1>üìã Reservas</h1>
  </div>
  
  <div class="stats" id="stats"></div>
  
  <div class="filters">
    <input type="text" id="searchInput" placeholder="Buscar PNR, ruta, aerol√≠nea..." />
    <select id="filterEstado">
      <option value="TODAS">Todos los estados</option>
      <option value="CREADA">Creada</option>
      <option value="EMITIDA">Emitida</option>
      <option value="COMPLETADA">Completada</option>
      <option value="CANCELADA">Cancelada</option>
    </select>
    <button class="btn btn-outline" onclick="cargarReservas()">üîÑ Actualizar</button>
  </div>
  
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>PNR</th>
          <th>Ruta</th>
          <th>Aerol√≠nea</th>
          <th>Fecha</th>
          <th>Pasajeros</th>
          <th>Precio</th>
          <th>Estado</th>
        </tr>
      </thead>
      <tbody id="tableBody">
        <tr><td colspan="7" class="loading">Cargando reservas...</td></tr>
      </tbody>
    </table>
  </div>
</div>

<!-- MODAL DETALLE -->
<div class="modal-overlay" id="modalOverlay" onclick="if(event.target===this)cerrarModal()">
  <div class="modal">
    <div class="modal-header">
      <h2 id="modalTitle">Detalle de Reserva</h2>
      <button class="modal-close" onclick="cerrarModal()">‚úï</button>
    </div>
    <div class="modal-body" id="modalBody">
      <div class="loading">Cargando...</div>
    </div>
    <div class="actions-bar" id="modalActions"></div>
  </div>
</div>

<script>
let reservas = [];
let reservaActual = null;

async function cargarReservas() {
  const estado = document.getElementById('filterEstado').value;
  const q = document.getElementById('searchInput').value.trim();
  const params = new URLSearchParams();
  if (estado !== 'TODAS') params.set('estado', estado);
  if (q) params.set('q', q);
  
  try {
    const res = await fetch('/reservas?' + params);
    reservas = await res.json();
    renderTabla();
    renderStats();
  } catch(e) {
    document.getElementById('tableBody').innerHTML = '<tr><td colspan="7" class="empty"><div class="icon">‚ö†Ô∏è</div>Error al cargar reservas</td></tr>';
  }
}

function renderStats() {
  const counts = { CREADA:0, EMITIDA:0, COMPLETADA:0, CANCELADA:0 };
  reservas.forEach(r => { if (counts[r.estado] !== undefined) counts[r.estado]++; });
  document.getElementById('stats').innerHTML = `
    <div class="stat-card creada"><div class="num">${counts.CREADA}</div><div class="label">Creadas</div></div>
    <div class="stat-card emitida"><div class="num">${counts.EMITIDA}</div><div class="label">Emitidas</div></div>
    <div class="stat-card completada"><div class="num">${counts.COMPLETADA}</div><div class="label">Completadas</div></div>
    <div class="stat-card cancelada"><div class="num">${counts.CANCELADA}</div><div class="label">Canceladas</div></div>
  `;
}

function renderTabla() {
  const tb = document.getElementById('tableBody');
  if (!reservas.length) {
    tb.innerHTML = '<tr><td colspan="7" class="empty"><div class="icon">üì≠</div>No hay reservas</td></tr>';
    return;
  }
  tb.innerHTML = reservas.map(r => {
    const pax = (r.adultos||0) + (r.ninos||0) + (r.infantes||0);
    const paxDetail = [];
    if (r.adultos) paxDetail.push(r.adultos + ' ADT');
    if (r.ninos) paxDetail.push(r.ninos + ' CHD');
    if (r.infantes) paxDetail.push(r.infantes + ' INF');
    const fecha = r.fecha_salida ? new Date(r.fecha_salida).toLocaleDateString('es-AR', { day:'2-digit', month:'short' }) : '-';
    const creado = r.created_at ? new Date(r.created_at).toLocaleDateString('es-AR', { day:'2-digit', month:'short', hour:'2-digit', minute:'2-digit' }) : '';
    return `<tr onclick="verDetalle(${r.id})">
      <td><span class="pnr">${r.pnr || '-'}</span><br><span class="fecha">${creado}</span></td>
      <td><span class="ruta">${r.origen || '?'} ‚Üí ${r.destino || '?'}</span></td>
      <td class="aerolinea">${r.aerolinea || '-'}</td>
      <td class="fecha">${fecha}</td>
      <td>${paxDetail.join(', ') || pax}</td>
      <td class="precio">USD ${(r.precio_usd||0).toLocaleString('es-AR', {minimumFractionDigits:0})}</td>
      <td><span class="badge badge-${r.estado}">${r.estado}</span></td>
    </tr>`;
  }).join('');
}

async function verDetalle(id) {
  document.getElementById('modalOverlay').classList.add('show');
  document.getElementById('modalBody').innerHTML = '<div class="loading">Cargando...</div>';
  document.getElementById('modalActions').innerHTML = '';
  
  try {
    const res = await fetch('/reservas/' + id);
    const data = await res.json();
    if (!data.ok) throw new Error(data.error);
    
    reservaActual = data.reserva;
    const r = data.reserva;
    document.getElementById('modalTitle').textContent = 'Reserva ' + (r.pnr || '#' + r.id);
    
    // Parse itinerario
    let itinHtml = '';
    try {
      const itin = typeof r.itinerario_json === 'string' ? JSON.parse(r.itinerario_json) : r.itinerario_json;
      if (Array.isArray(itin)) {
        itinHtml = itin.map(s => {
          // Formatear fechas ISO a formato corto
          function fmtDt(d) {
            if (!d) return '';
            try {
              if (d.includes('T')) {
                const dt = new Date(d);
                return dt.toLocaleDateString('es-AR',{day:'2-digit',month:'short'}) + ' ' + dt.toLocaleTimeString('es-AR',{hour:'2-digit',minute:'2-digit'});
              }
              return d;
            } catch(e) { return d; }
          }
          const salida = s.salida || s.departureDateTime || '';
          const llegada = s.llegada || s.arrivalDateTime || '';
          const fecha = s.fecha || (salida.includes('T') ? new Date(salida).toLocaleDateString('es-AR',{day:'2-digit',month:'short'}) : '');
          const horaSalida = salida.includes('T') ? new Date(salida).toLocaleTimeString('es-AR',{hour:'2-digit',minute:'2-digit'}) : salida;
          const horaLlegada = llegada.includes('T') ? new Date(llegada).toLocaleTimeString('es-AR',{hour:'2-digit',minute:'2-digit'}) : llegada;
          return `
          <div class="itin-segment">
            <div class="itin-date">${fecha}</div>
            <div class="itin-route">
              <div class="cities">${s.origen || s.departureAirport || ''} ‚Üí ${s.destino || s.arrivalAirport || ''}</div>
              <div class="flight-num">${s.numero_vuelo || s.flightNumber || ''}</div>
            </div>
            <div class="itin-times">${horaSalida} ‚Üí ${horaLlegada}</div>
          </div>
        `}).join('');
      }
    } catch(e) {}
    
    // Parse pasajeros
    let paxHtml = '';
    const paxList = r.pasajeros_detalle || [];
    if (paxList.length) {
      paxHtml = paxList.map(p => `
        <div class="pax-row">
          <div>
            <span class="pax-name">${p.apellido || ''}, ${p.nombre || ''}</span>
            <span class="pax-type">(${p.tipo === 'ADT' ? 'Adulto' : p.tipo === 'CHD' ? 'Menor' : 'Beb√©'})</span>
          </div>
          <span class="pax-doc">${p.doc_tipo || ''} ${p.doc_numero || ''}</span>
        </div>
      `).join('');
    } else {
      // Fallback: pasajeros_json
      try {
        const pj = typeof r.pasajeros_json === 'string' ? JSON.parse(r.pasajeros_json) : r.pasajeros_json;
        if (Array.isArray(pj)) {
          paxHtml = pj.map(p => `
            <div class="pax-row">
              <div>
                <span class="pax-name">${p.apellido || ''}, ${p.nombre || ''}</span>
                <span class="pax-type">(${p.tipo === 'ADT' ? 'Adulto' : p.tipo === 'CHD' ? 'Menor' : 'Beb√©'})</span>
              </div>
              <span class="pax-doc">${p.docTipo || ''} ${p.docNumero || ''}</span>
            </div>
          `).join('');
        }
      } catch(e) {}
    }
    
    // Parse contacto
    let contactoHtml = '';
    try {
      const c = typeof r.contacto_json === 'string' ? JSON.parse(r.contacto_json) : r.contacto_json;
      if (c) {
        contactoHtml = `${c.nombre || ''} ${c.apellido || ''} ¬∑ ${c.email || ''} ¬∑ ${c.telefono1 || ''}`;
      }
    } catch(e) {}
    
    const creado = r.created_at ? new Date(r.created_at).toLocaleString('es-AR') : '-';
    
    document.getElementById('modalBody').innerHTML = `
      <div class="detail-section">
        <h3>Informaci√≥n general</h3>
        <div class="detail-grid">
          <div class="detail-item"><div class="lbl">PNR</div><div class="val">${r.pnr || '-'}</div></div>
          <div class="detail-item"><div class="lbl">Order</div><div class="val">${r.order_id ? `<a href="https://sciweb.tucanotours.com.ar/FlightOrders/Details/${r.order_id}" target="_blank" style="color:#1565c0;text-decoration:none;">${r.order_number || r.order_id.substring(0,8)} üîó</a>` : (r.order_number || '-')}</div></div>
          <div class="detail-item"><div class="lbl">Estado</div><div class="val"><span class="badge badge-${r.estado}">${r.estado}</span></div></div>
          <div class="detail-item"><div class="lbl">Aerol√≠nea</div><div class="val">${r.aerolinea || '-'}</div></div>
          <div class="detail-item"><div class="lbl">Precio neto</div><div class="val">USD ${(r.precio_usd||0).toLocaleString('es-AR')}</div></div>
          <div class="detail-item"><div class="lbl">Creada</div><div class="val">${creado}</div></div>
        </div>
      </div>
      
      ${itinHtml ? `<div class="detail-section"><h3>‚úà Itinerario</h3>${itinHtml}</div>` : ''}
      ${paxHtml ? `<div class="detail-section"><h3>üë• Pasajeros</h3>${paxHtml}</div>` : ''}
      ${contactoHtml ? `<div class="detail-section"><h3>üìû Contacto</h3><p>${contactoHtml}</p></div>` : ''}
      
      <div class="detail-section">
        <h3>üìù Notas</h3>
        <textarea class="notas-area" id="notasArea" placeholder="Agregar notas sobre esta reserva...">${r.notas || ''}</textarea>
      </div>
    `;
    
    // Actions
    let actionsHtml = `<button class="btn btn-primary" onclick="verificarEstado()">üîç Verificar estado</button>`;
    actionsHtml += `<button class="btn btn-outline" onclick="guardarNotas()">üíæ Guardar notas</button>`;
    actionsHtml += `<button class="btn btn-outline" onclick="mostrarPdfOpts()">üìÑ Generar PDF</button>`;
    if (r.estado === 'CREADA') {
      actionsHtml += `<button class="btn btn-success" onclick="mostrarRecotizar()">üí≤ Recotizar</button>`;
      actionsHtml += `<button class="btn btn-outline" style="background:#1565c0;color:white;border:none;" onclick="confirmarEmision()">‚úàÔ∏è Emitir en SCIWeb</button>`;
      actionsHtml += `<button class="btn btn-success" onclick="cambiarEstado('EMITIDA')">‚úÖ Marcar como Emitida</button>`;
      actionsHtml += `<button class="btn btn-danger" onclick="cambiarEstado('CANCELADA')">‚ùå Cancelar</button>`;
    } else if (r.estado === 'EMITIDA') {
      actionsHtml += `<button class="btn btn-primary" onclick="cambiarEstado('COMPLETADA')">üèÅ Marcar Completada</button>`;
      actionsHtml += `<button class="btn btn-danger" onclick="cambiarEstado('CANCELADA')">‚ùå Cancelar</button>`;
    }
    document.getElementById('modalActions').innerHTML = actionsHtml;
    
  } catch(e) {
    document.getElementById('modalBody').innerHTML = '<div class="empty">Error: ' + e.message + '</div>';
  }
}

function mostrarPdfOpts() {
  const existing = document.getElementById('pdfPanel');
  if (existing) { existing.remove(); return; }
  
  const panel = document.createElement('div');
  panel.id = 'pdfPanel';
  panel.className = 'recotizar-panel';
  panel.innerHTML = `
    <h4>üìÑ Generar PDF de reserva</h4>
    <div class="recotizar-opts">
      <div>
        <label>Vendedor</label>
        <select id="pdfVendedor">
          <option value="guido">Guido Finkelstein</option>
          <option value="julieta">Julieta Zubeldia</option>
          <option value="ruthy">Ruthy Tuchsznajder</option>
        </select>
      </div>
      <div>
        <label>&nbsp;</label>
        <button class="btn btn-primary" onclick="generarPdf()" id="btnPdf" style="width:100%">üìÑ Generar y descargar</button>
      </div>
    </div>
    <p style="font-size:11px;color:#999">El PDF incluye PNR, pasajeros, itinerario y precio de venta (con markup)</p>
  `;
  document.getElementById('modalBody').appendChild(panel);
}

async function generarPdf() {
  if (!reservaActual) return;
  const btn = document.getElementById('btnPdf');
  btn.textContent = '‚è≥ Generando...'; btn.disabled = true;
  try {
    const vendedor = document.getElementById('pdfVendedor').value;
    const res = await fetch('/reservas/' + reservaActual.id + '/pdf', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ vendedor })
    });
    if (!res.ok) {
      const err = await res.json();
      throw new Error(err.error || 'Error generando PDF');
    }
    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `Reserva_${reservaActual.pnr}.pdf`;
    a.click();
    URL.revokeObjectURL(url);
  } catch(e) {
    alert('Error: ' + e.message);
  } finally {
    btn.textContent = 'üìÑ Generar y descargar'; btn.disabled = false;
  }
}

function mostrarRecotizar() {
  // Agregar panel de calificadores dentro del modal
  const existing = document.getElementById('recotizarPanel');
  if (existing) { existing.remove(); return; } // toggle
  
  const panel = document.createElement('div');
  panel.id = 'recotizarPanel';
  panel.className = 'recotizar-panel';
  panel.innerHTML = `
    <h4>üí≤ Recotizar reserva</h4>
    <div class="recotizar-opts">
      <div>
        <label>Moneda</label>
        <select id="recotMoneda">
          <option value="">Auto (por defecto)</option>
          <option value="USD">USD</option>
          <option value="ARS">ARS (Pesos)</option>
        </select>
      </div>
      <div>
        <label>Tipo tarifa</label>
        <select id="recotFareType">
          <option value="0">No forzar</option>
          <option value="1">P√∫blicas</option>
          <option value="2">Privadas</option>
        </select>
      </div>
      <div>
        <label>Validadora (override)</label>
        <input type="text" id="recotCarrier" placeholder="Ej: UX, AR..." maxlength="3" />
      </div>
      <div>
        <label>Nacionalidad</label>
        <input type="text" id="recotNationality" placeholder="Ej: ARG" maxlength="3" />
      </div>
      <div>
        <label>Fare Family / Brand</label>
        <input type="text" id="recotBrand" placeholder="Ej: BRANDID1" />
      </div>
      <div>
        <label>&nbsp;</label>
      </div>
    </div>
    <button class="btn btn-primary" onclick="ejecutarRecotizar()" id="btnRecotizar">üìä Obtener tarifa actual</button>
    <div id="recotizarResult" class="recotizar-result"></div>
  `;
  document.getElementById('modalBody').appendChild(panel);
}

async function ejecutarRecotizar() {
  if (!reservaActual) return;
  const btn = document.getElementById('btnRecotizar');
  const resultDiv = document.getElementById('recotizarResult');
  btn.textContent = '‚è≥ Consultando tarifa...'; btn.disabled = true;
  resultDiv.innerHTML = '';
  
  const opts = {
    moneda: document.getElementById('recotMoneda').value || null,
    fareType: parseInt(document.getElementById('recotFareType').value) || 0,
    overrideCarrier: document.getElementById('recotCarrier').value || null,
    nationality: document.getElementById('recotNationality').value || null,
    brandId: document.getElementById('recotBrand').value || null
  };
  
  try {
    const res = await fetch('/reservas/' + reservaActual.id + '/recotizar', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(opts)
    });
    const data = await res.json();
    if (!data.ok) throw new Error(data.error);
    
    if (data.tarifas && data.tarifas.length) {
      let html = '';
      let grandTotal = 0;
      let grandNeto = 0;
      data.tarifas.forEach(t => {
        grandTotal += t.total;
        // Comisi√≥n + Over se descuentan del neto
        const comObt = t.comisionObtenida?.valueApplied || 0;
        const comCed = t.comisionCedida?.valueApplied || 0;
        const comisionMonto = comObt + comCed;
        const comDisplayVal = t.comisionObtenida?.displayValue || t.comisionCedida?.displayValue || '';
        const overMonto = t.overComision?.ceded?.valueApplied || t.overComision?.obtained?.valueApplied || t.overComision?.valueApplied || t.overComision?.amount || 0;
        const overDisplayVal = t.overComision?.ceded?.displayValue || t.overComision?.obtained?.displayValue || t.overComision?.displayValue || '';
        // Neto = total + fee - comisi√≥n - over
        const neto = t.total + t.fee - comisionMonto - overMonto;
        grandNeto += neto;
        
        html += `
          <div class="tarifa-card">
            <div class="tarifa-header">${t.tipo} √ó 1 ${t.pasajero ? '‚Äî ' + t.pasajero : ''}</div>
            ${t.tipoTarifa ? `<div class="tarifa-row" style="color:#666;font-size:12px"><span>Tipo: ${t.tipoTarifa}${t.validadora ? ' / ' + t.validadora : ''}</span></div>` : ''}
            <div class="tarifa-row"><span>Tarifa base</span><span>${t.monedaBase} ${t.tarifaBase.toLocaleString('es-AR', {minimumFractionDigits:2})}</span></div>
            <div class="tarifa-row"><span>Impuestos</span><span>${t.monedaImpuestos} ${t.impuestos.toLocaleString('es-AR', {minimumFractionDigits:2})}</span></div>
            <div class="tarifa-row" style="border-top:1px solid #eee;padding-top:4px;"><span>Subtotal tarifa</span><span>${t.monedaTotal} ${t.total.toLocaleString('es-AR', {minimumFractionDigits:2})}</span></div>
            ${t.fee ? `<div class="tarifa-row"><span>Fee Tucano</span><span>${t.monedaFee} ${t.fee.toLocaleString('es-AR', {minimumFractionDigits:2})}</span></div>` : ''}
            ${comisionMonto ? `<div class="tarifa-row" style="color:#2e7d32"><span>Comisi√≥n ${comDisplayVal}</span><span>- ${t.monedaTotal} ${comisionMonto.toLocaleString('es-AR', {minimumFractionDigits:2})}</span></div>` : ''}
            ${overMonto ? `<div class="tarifa-row" style="color:#2e7d32"><span>Over ${overDisplayVal}</span><span>- ${t.monedaTotal} ${overMonto.toLocaleString('es-AR', {minimumFractionDigits:2})}</span></div>` : ''}
            <div class="tarifa-row total"><span>NETO a pagar</span><span>${t.monedaTotal} ${neto.toLocaleString('es-AR', {minimumFractionDigits:2})}</span></div>
          </div>
        `;
      });
      const mon = data.tarifas[0]?.monedaTotal || 'USD';
      const totalComisiones = data.tarifas.reduce((s, t) => s + (t.comisionCedida?.valueApplied || 0) + (t.comisionObtenida?.valueApplied || 0), 0);
      const totalOver = data.tarifas.reduce((s, t) => s + (t.overComision?.ceded?.valueApplied || t.overComision?.obtained?.valueApplied || t.overComision?.valueApplied || t.overComision?.amount || 0), 0);
      const totalFees = data.tarifas.reduce((s, t) => s + (t.fee || 0), 0);
      const totalDescuentos = totalComisiones + totalOver;
      html += `<div class="tarifa-card" style="background:#e8f5e9;border-color:#4caf50;">
        <div class="tarifa-row" style="padding:2px 0;font-size:13px">
          <span>Subtotal tarifas</span>
          <span>${mon} ${grandTotal.toLocaleString('es-AR', {minimumFractionDigits:2})}</span>
        </div>
        ${totalFees ? `<div class="tarifa-row" style="padding:2px 0;font-size:13px">
          <span>+ Fees</span>
          <span>${mon} ${totalFees.toLocaleString('es-AR', {minimumFractionDigits:2})}</span>
        </div>` : ''}
        ${totalComisiones ? `<div class="tarifa-row" style="padding:2px 0;font-size:13px;color:#2e7d32">
          <span>- Comisiones</span>
          <span>- ${mon} ${totalComisiones.toLocaleString('es-AR', {minimumFractionDigits:2})}</span>
        </div>` : ''}
        ${totalOver ? `<div class="tarifa-row" style="padding:2px 0;font-size:13px;color:#2e7d32">
          <span>- Over</span>
          <span>- ${mon} ${totalOver.toLocaleString('es-AR', {minimumFractionDigits:2})}</span>
        </div>` : ''}
        <div class="tarifa-row total" style="border:none;margin:0;padding-top:6px;">
          <span>TOTAL NETO RESERVA</span>
          <span>${mon} ${grandNeto.toLocaleString('es-AR', {minimumFractionDigits:2})}</span>
        </div>
      </div>`;
      
      // Penalidades
      if (data.penalidades) {
        const pen = data.penalidades;
        const parts = [];
        if (pen.cambio) parts.push(`<span>Cambio: ${pen.cambio.moneda} ${pen.cambio.monto}</span>`);
        if (pen.cancelacion) parts.push(`<span>Cancelaci√≥n: ${pen.cancelacion.moneda} ${pen.cancelacion.monto}</span>`);
        if (parts.length) {
          html += `<div style="margin-top:8px;padding:8px 12px;background:#fff3e0;border:1px solid #ffcc80;border-radius:6px;font-size:12px;color:#e65100;">
            <strong>‚ö†Ô∏è Penalidades:</strong> ${parts.join(' &nbsp;|&nbsp; ')}
          </div>`;
        }
      }
      
      // Bot√≥n guardar tarifa
      if (data.pricingId) {
        window._lastPricing = { pricingId: data.pricingId, segmentIds: data.segmentIds, netoTotal: grandNeto, moneda: mon };
        html += `<button class="btn btn-success" style="margin-top:10px;width:100%" 
          onclick="guardarTarifa()">
          üíæ Guardar tarifa en reserva
        </button>`;
      } else {
        html += `<p style="color:#999;font-size:12px;margin-top:8px">‚ö†Ô∏è Sin PricingId - verific√° la respuesta</p>
          <pre style="font-size:11px;max-height:150px;overflow:auto;background:#f5f5f5;padding:8px;border-radius:4px">${data.rawKeys?.join(', ')}\n${data.rawPreview || ''}</pre>`;
      }
      
      resultDiv.innerHTML = html;
    } else {
      resultDiv.innerHTML = `<p style="color:#999">Sin tarifas. Respuesta: ${data.rawKeys?.join(', ') || 'vac√≠a'}</p>
        <pre style="font-size:11px;max-height:200px;overflow:auto;background:#f5f5f5;padding:8px;border-radius:4px">${data.rawPreview || ''}</pre>`;
    }
  } catch(e) {
    resultDiv.innerHTML = `<p style="color:#e74c3c">Error: ${e.message}</p>`;
  } finally {
    btn.textContent = 'üìä Obtener tarifa actual'; btn.disabled = false;
  }
}

async function guardarTarifa() {
  if (!reservaActual || !window._lastPricing) return;
  if (!confirm('¬øGuardar esta tarifa en la reserva?\nEsta ser√° la tarifa usada para emitir.')) return;
  try {
    const { pricingId, segmentIds, netoTotal, moneda } = window._lastPricing;
    const res = await fetch('/reservas/' + reservaActual.id + '/guardar-tarifa', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ pricingId, segmentIds, netoTotal, moneda })
    });
    const data = await res.json();
    if (!data.ok) throw new Error(data.error);
    alert('‚úÖ ' + data.mensaje);
    cerrarModal();
    cargarReservas();
  } catch(e) {
    alert('Error: ' + e.message);
  }
}

async function verificarEstado() {
  if (!reservaActual) return;
  const btn = document.querySelector('.actions-bar .btn-primary');
  if (btn) { btn.textContent = '‚è≥ Consultando API...'; btn.disabled = true; }
  try {
    const res = await fetch('/reservas/' + reservaActual.id + '/verificar', {
      method: 'POST', headers: { 'Content-Type': 'application/json' }
    });
    const data = await res.json();
    if (!data.ok) throw new Error(data.error);
    
    let msg = `PNR: ${data.pnr}\n`;
    
    // Estado
    if (data.estadoActualizado) {
      msg += `\n‚ö° ESTADO ACTUALIZADO: ${data.estadoAnterior} ‚Üí ${data.estadoAPI}\n`;
    } else {
      msg += `\n‚úÖ Estado: ${data.estadoAPI} (sin cambios)\n`;
    }
    
    // Time limit
    if (data.timeLimit) {
      const tl = new Date(data.timeLimit);
      msg += `\n‚è∞ L√≠mite emisi√≥n: ${tl.toLocaleDateString('es-AR')} ${tl.toLocaleTimeString('es-AR', {hour:'2-digit',minute:'2-digit'})}\n`;
    }
    
    // Tickets
    if (data.tickets && data.tickets.length) {
      msg += `\nüé´ Tickets emitidos:\n`;
      data.tickets.forEach(t => msg += `   ${t}\n`);
    }
    
    // Tickets VOID
    if (data.ticketsVoid && data.ticketsVoid.length) {
      msg += `\nüö´ Tickets anulados:\n`;
      data.ticketsVoid.forEach(t => msg += `   ${t}\n`);
    }
    
    // OrderState
    if (data.orderState !== undefined) {
      msg += `\nüìã OrderState: ${data.orderState}\n`;
    }
    
    // Vuelos
    if (data.vuelos && data.vuelos.length) {
      msg += `\n‚úàÔ∏è Vuelos:\n`;
      data.vuelos.forEach(v => msg += `   ${v.vuelo} ${v.ruta} [${v.status}]\n`);
    }
    
    // Mensaje adicional
    if (data.mensaje) {
      msg += `\n‚ÑπÔ∏è ${data.mensaje}\n`;
    }
    
    alert(msg);
    
    if (data.estadoActualizado) {
      cerrarModal();
      cargarReservas();
    }
  } catch(e) {
    alert('Error al verificar: ' + e.message);
  } finally {
    if (btn) { btn.textContent = 'üîç Verificar estado'; btn.disabled = false; }
  }
}

async function cambiarEstado(estado) {
  if (!reservaActual) return;
  const label = { EMITIDA: 'emitida', COMPLETADA: 'completada', CANCELADA: 'cancelada' }[estado];
  if (!confirm(`¬øMarcar como ${label}?`)) return;
  try {
    const res = await fetch('/reservas/' + reservaActual.id + '/estado', {
      method: 'PUT', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ estado })
    });
    const data = await res.json();
    if (data.ok) {
      cerrarModal();
      cargarReservas();
    } else {
      alert('Error: ' + (data.error || 'desconocido'));
    }
  } catch(e) { alert('Error: ' + e.message); }
}

async function guardarNotas() {
  if (!reservaActual) return;
  const notas = document.getElementById('notasArea').value;
  try {
    const res = await fetch('/reservas/' + reservaActual.id + '/notas', {
      method: 'PUT', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ notas })
    });
    const data = await res.json();
    if (data.ok) {
      // Feedback visual
      const btn = document.querySelector('.actions-bar .btn-outline');
      if (btn) { btn.textContent = '‚úÖ Guardado'; setTimeout(() => btn.textContent = 'üíæ Guardar notas', 1500); }
    }
  } catch(e) { alert('Error: ' + e.message); }
}

function cerrarModal() {
  document.getElementById('modalOverlay').classList.remove('show');
  reservaActual = null;
}

// ‚îÄ‚îÄ‚îÄ EMISI√ìN ‚îÄ‚îÄ‚îÄ
async function confirmarEmision() {
  if (!reservaActual) return;
  if (reservaActual.estado === 'EMITIDA') {
    alert('Esta reserva ya est√° emitida.');
    return;
  }
  if (reservaActual.estado === 'CANCELADA') {
    alert('No se puede emitir una reserva cancelada.');
    return;
  }
  
  try {
    const resp = await fetch('/reservas/' + reservaActual.id + '/emitir', { 
      method: 'POST', headers: {'Content-Type':'application/json'} 
    });
    const data = await resp.json();
    if (!data.ok) { alert('Error: ' + data.error); return; }
    
    // Abrir SCIWeb en nueva pesta√±a
    if (data.sciweb_url) {
      const abrir = confirm(
        `Emitir reserva ${data.pnr}\n\n` +
        `Se abrir√° SCIWeb para completar la emisi√≥n.\n` +
        `Despu√©s de emitir en SCIWeb, volv√© ac√° y hac√© click en "Verificar estado" para sincronizar.\n\n` +
        `¬øAbrir SCIWeb?`
      );
      if (abrir) {
        window.open(data.sciweb_url, '_blank');
        // Mostrar recordatorio
        const statusDiv = document.getElementById('modalBody');
        const reminder = document.createElement('div');
        reminder.style.cssText = 'margin-top:16px;padding:16px;background:#e3f2fd;border:2px solid #1976d2;border-radius:10px;text-align:center;';
        reminder.innerHTML = `
          <p style="font-size:14px;margin:0;color:#1565c0;">‚úàÔ∏è SCIWeb abierto en nueva pesta√±a</p>
          <p style="color:#666;margin:8px 0;font-size:12px;">Despu√©s de emitir, hac√© click abajo para sincronizar:</p>
          <button class="btn btn-primary" onclick="verificarEstado()" style="margin-top:4px">üîÑ Verificar estado</button>
        `;
        statusDiv.appendChild(reminder);
      }
    }
  } catch(e) {
    alert('Error: ' + e.message);
  }
}

// Buscar al escribir (con debounce)
let searchTimer;
document.getElementById('searchInput').addEventListener('input', () => {
  clearTimeout(searchTimer);
  searchTimer = setTimeout(cargarReservas, 400);
});
document.getElementById('filterEstado').addEventListener('change', cargarReservas);

// Cerrar modal con Escape
document.addEventListener('keydown', e => { if (e.key === 'Escape') cerrarModal(); });

// Init
cargarReservas();
</script>
</body>
</html>
